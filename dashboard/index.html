<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Git Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* CSS Variables for theming */
        :root {
            --bg-primary: #f3f4f6;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f9fafb;
            --bg-hover: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #374151;
            --text-tertiary: #6b7280;
            --text-muted: #9ca3af;
            --border-color: #e5e7eb;
            --border-light: #f3f4f6;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --chart-grid: rgba(0, 0, 0, 0.1);
        }

        .dark {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --bg-hover: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #e5e7eb;
            --text-tertiary: #9ca3af;
            --text-muted: #6b7280;
            --border-color: #374151;
            --border-light: #1f2937;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.3);
            --chart-grid: rgba(255, 255, 255, 0.1);
        }

        /* Tag classes */
        .tag-feature { background-color: #10b981; color: white; }
        .tag-bugfix { background-color: #ef4444; color: white; }
        .tag-refactor { background-color: #8b5cf6; color: white; }
        .tag-docs { background-color: #3b82f6; color: white; }
        .tag-test { background-color: #f59e0b; color: white; }
        .tag-config { background-color: #64748b; color: white; }
        .tag-style { background-color: #ec4899; color: white; }
        .tag-cleanup { background-color: #6b7280; color: white; }
        .tag-security { background-color: #dc2626; color: white; }
        .tag-performance { background-color: #06b6d4; color: white; }
        .tag-dependency { background-color: #84cc16; color: white; }
        .tag-other { background-color: #9ca3af; color: white; }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .timeline-dot:hover {
            transform: scale(1.5);
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            padding: 1.5rem;
        }

        /* Text color utilities using CSS variables for dark mode support */
        .text-themed-primary { color: var(--text-primary); }
        .text-themed-secondary { color: var(--text-secondary); }
        .text-themed-tertiary { color: var(--text-tertiary); }
        .text-themed-muted { color: var(--text-muted); }
        .bg-themed-primary { background-color: var(--bg-primary); }
        .bg-themed-secondary { background-color: var(--bg-secondary); }
        .bg-themed-tertiary { background-color: var(--bg-tertiary); }
        .border-themed { border-color: var(--border-color); }

        .tag {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Special alert-style tags */
        .tag-breaking { background-color: #fef3c7; color: #d97706; border: 1px solid #fde68a; }

        .filter-select {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            min-width: 120px;
        }
        .filter-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .filter-input {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
        }
        .filter-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* Hide scrollbar for mobile tabs */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* Work pattern badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.625rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        .badge-after-hours {
            background-color: #fef3c7;
            color: #92400e;
        }
        .badge-weekend {
            background-color: #e0e7ff;
            color: #3730a3;
        }
        .badge-holiday {
            background-color: #fce7f3;
            color: #9d174d;
        }

        /* Export/Share buttons */
        .btn-icon {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover {
            background-color: var(--bg-hover);
        }
        .btn-icon svg {
            width: 1rem;
            height: 1rem;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background-color: #1f2937;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            z-index: 1000;
            opacity: 0;
            transform: translateY(1rem);
            transition: all 0.3s ease;
        }
        .dark .toast {
            background-color: #f9fafb;
            color: #111827;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Dark mode toggle button */
        .btn-theme {
            padding: 0.5rem;
            border-radius: 0.375rem;
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn-theme:hover {
            background-color: var(--bg-hover);
            color: var(--text-primary);
        }
        .btn-theme svg {
            width: 1.25rem;
            height: 1.25rem;
        }

        /* Print styles for PDF */
        @media print {
            body { background: white !important; }
            .no-print { display: none !important; }
            .card { box-shadow: none !important; border: 1px solid #e5e7eb; }
        }

        /* Heatmap styles */
        .heatmap-grid {
            display: grid;
            grid-template-columns: 50px repeat(7, 1fr);
            gap: 2px;
            min-width: 400px;
        }
        .heatmap-cell {
            aspect-ratio: 1;
            min-width: 28px;
            min-height: 28px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #374151;
            cursor: default;
            transition: transform 0.1s;
        }
        .heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 1;
        }
        .heatmap-label {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 11px;
            color: #6b7280;
        }
        .heatmap-header {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 500;
            color: #374151;
        }
        /* Heatmap intensity levels */
        .heatmap-0 { background-color: #f3f4f6; }
        .heatmap-1 { background-color: #dbeafe; }
        .heatmap-2 { background-color: #93c5fd; }
        .heatmap-3 { background-color: #3b82f6; color: white; }
        .heatmap-4 { background-color: #1d4ed8; color: white; }

        .dark .heatmap-0 { background-color: #374151; }
        .dark .heatmap-1 { background-color: #1e3a5f; }
        .dark .heatmap-2 { background-color: #1e40af; }
        .dark .heatmap-3 { background-color: #2563eb; color: white; }
        .dark .heatmap-4 { background-color: #3b82f6; color: white; }

        .heatmap-cell {
            color: var(--text-secondary);
        }
        .heatmap-label {
            color: var(--text-tertiary);
        }
        .heatmap-header {
            color: var(--text-secondary);
        }

        /* Dark mode color overrides */
        .dark .bg-gray-50 { background-color: var(--bg-tertiary) !important; }
        .dark .bg-gray-100 { background-color: var(--bg-primary) !important; }
        .dark .text-gray-900 { color: var(--text-primary) !important; }
        .dark .text-gray-700 { color: var(--text-secondary) !important; }
        .dark .text-gray-600 { color: var(--text-secondary) !important; }
        .dark .text-gray-500 { color: var(--text-tertiary) !important; }
        .dark .text-gray-400 { color: var(--text-muted) !important; }
        .dark .border-gray-200 { border-color: var(--border-color) !important; }
        .dark .border-gray-100 { border-color: var(--border-light) !important; }
        .dark .hover\:text-gray-900:hover { color: var(--text-primary) !important; }
        .dark .hover\:text-gray-700:hover { color: var(--text-secondary) !important; }
        .dark .hover\:bg-gray-100:hover { background-color: var(--bg-hover) !important; }

        /* Dark mode summary card backgrounds */
        .dark .bg-amber-50 { background-color: rgba(251, 191, 36, 0.1) !important; }
        .dark .bg-indigo-50 { background-color: rgba(99, 102, 241, 0.1) !important; }
        .dark .bg-pink-50 { background-color: rgba(236, 72, 153, 0.1) !important; }
        .dark .bg-purple-50 { background-color: rgba(139, 92, 246, 0.1) !important; }
        .dark .bg-red-50 { background-color: rgba(239, 68, 68, 0.1) !important; }

        /* Dark mode badges */
        .dark .badge-after-hours {
            background-color: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        .dark .badge-weekend {
            background-color: rgba(99, 102, 241, 0.2);
            color: #818cf8;
        }
        .dark .badge-holiday {
            background-color: rgba(236, 72, 153, 0.2);
            color: #f472b6;
        }

        /* Loading states */
        .loading-spinner {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: var(--bg-secondary);
            opacity: 0.8;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.75rem;
            z-index: 10;
        }
        .card-loading {
            position: relative;
            min-height: 100px;
        }
        .skeleton {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-hover) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 0.25rem;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Detail Pane - Slide-out panel for drill-down */
        .detail-pane-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 998;
        }
        .detail-pane-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .dark .detail-pane-overlay {
            background: rgba(0, 0, 0, 0.5);
        }

        .detail-pane {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 480px;
            height: 100%;
            background: var(--bg-secondary);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 999;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .detail-pane.open {
            transform: translateX(0);
        }
        .dark .detail-pane {
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.4);
        }

        .detail-pane-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .detail-pane-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .detail-pane-subtitle {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 0.25rem;
        }
        .detail-pane-close {
            padding: 0.5rem;
            border-radius: 0.375rem;
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all 0.15s;
        }
        .detail-pane-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .detail-pane-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .detail-pane-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        /* Detail pane commit list */
        .detail-commit {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-light);
            margin-bottom: 0.75rem;
            transition: background 0.15s;
        }
        .detail-commit:hover {
            background: var(--bg-tertiary);
        }
        .detail-commit-message {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        .detail-commit-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }
        .detail-commit-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        /* Mobile: Bottom sheet variant */
        @media (max-width: 640px) {
            .detail-pane {
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                max-width: none;
                height: 85vh;
                max-height: 85vh;
                border-radius: 1rem 1rem 0 0;
                transform: translateY(100%);
            }
            .detail-pane.open {
                transform: translateY(0);
            }
            .detail-pane-header {
                padding: 0.75rem 1rem;
            }
            .detail-pane-header::before {
                content: '';
                position: absolute;
                top: 0.5rem;
                left: 50%;
                transform: translateX(-50%);
                width: 2rem;
                height: 0.25rem;
                background: var(--border-color);
                border-radius: 0.125rem;
            }
            .detail-pane-content {
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-themed-primary" id="repo-name">Git Analytics Dashboard</h1>
                    <p class="text-gray-500 mt-1" id="repo-subtitle">Loading data...</p>
                </div>
                <div id="export-buttons" class="hidden flex items-center gap-2 no-print">
                    <button id="btn-sanitize" class="btn-theme" title="Toggle private mode (hide names/messages)">
                        <svg id="icon-eye" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.64 0 8.577 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.64 0-8.577-3.007-9.963-7.178z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <svg id="icon-eye-slash" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hidden">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
                        </svg>
                    </button>
                    <button id="btn-theme" class="btn-theme" title="Toggle dark mode">
                        <svg id="icon-sun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hidden">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                        </svg>
                        <svg id="icon-moon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                        </svg>
                    </button>
                    <button id="btn-share" class="btn-icon btn-secondary" title="Copy shareable link">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
                        </svg>
                        <span class="hidden sm:inline">Share</span>
                    </button>
                    <button id="btn-export-pdf" class="btn-icon btn-primary" title="Export as PDF">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        <span class="hidden sm:inline">Export PDF</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Data Loader -->
        <div id="loader" class="card text-center py-12">
            <div id="loader-content">
                <p class="text-gray-500">Select data file(s) to load:</p>
                <input type="file" id="file-input" accept=".json" multiple class="mt-4 text-sm">
                <p class="text-sm text-gray-400 mt-2">Select multiple files to combine data from different repositories</p>
                <p class="text-sm text-gray-400 mt-1">Or place your data.json in the same directory as this file</p>
            </div>
            <div id="loader-spinner" class="hidden">
                <div class="loading-spinner mb-3"></div>
                <p class="text-gray-500">Loading dashboard data...</p>
            </div>
        </div>

        <!-- Dashboard Content (hidden until data loads) -->
        <div id="dashboard" class="hidden">
            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="card">
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Files Changed</p>
                    <p class="text-3xl font-bold text-themed-primary" id="stat-files">0</p>
                    <p class="text-xs text-gray-400" id="stat-files-sub"></p>
                </div>
                <div class="card">
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Avg Complexity</p>
                    <p class="text-3xl font-bold text-themed-primary" id="stat-complexity">-</p>
                    <p class="text-xs text-gray-400" id="stat-complexity-sub"></p>
                </div>
                <div class="card">
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Top Work Type</p>
                    <p class="text-2xl font-bold text-themed-primary" id="stat-top-tag">-</p>
                    <p class="text-xs text-gray-400" id="stat-top-tag-sub"></p>
                </div>
                <div class="card">
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Contributors</p>
                    <p class="text-3xl font-bold text-themed-primary" id="stat-contributors">0</p>
                </div>
            </div>

            <!-- Navigation Tabs (V2: 4 grouped tabs) -->
            <div class="flex border-b border-gray-200 mb-6 overflow-x-auto -mx-4 px-4 md:mx-0 md:px-0 scrollbar-hide">
                <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600 whitespace-nowrap" data-tab="overview">Overview</button>
                <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="activity">Activity</button>
                <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="work">Work</button>
                <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="health">Health</button>
            </div>

            <!-- Tab Content -->
            <div id="tab-overview" class="tab-content">
                <!-- Period Selector -->
                <div class="card mb-6">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <div>
                            <h2 class="text-lg font-semibold text-themed-primary">Executive Summary</h2>
                            <p class="text-xs text-gray-500">High-level overview for quick scanning</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-gray-500">Compare:</label>
                            <select id="summary-period" class="filter-select text-sm">
                                <option value="7days">Last 7 Days</option>
                                <option value="30days">Last 30 Days</option>
                                <option value="quarter">This Quarter</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats with Trends -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-summary-card="features">
                        <p class="text-sm text-gray-500 uppercase tracking-wide">Features Built</p>
                        <p class="text-3xl font-bold text-green-600" id="summary-features">0</p>
                        <p class="text-sm mt-1" id="summary-features-trend"></p>
                    </div>
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-summary-card="fixes">
                        <p class="text-sm text-gray-500 uppercase tracking-wide">Bugs Fixed</p>
                        <p class="text-3xl font-bold text-amber-600" id="summary-fixes">0</p>
                        <p class="text-sm mt-1" id="summary-fixes-trend"></p>
                    </div>
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-summary-card="urgency">
                        <p class="text-sm text-gray-500 uppercase tracking-wide">Avg Urgency</p>
                        <p class="text-3xl font-bold text-themed-primary" id="summary-urgency">-</p>
                        <p class="text-sm mt-1" id="summary-urgency-trend"></p>
                    </div>
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-summary-card="planned">
                        <p class="text-sm text-gray-500 uppercase tracking-wide">% Planned</p>
                        <p class="text-3xl font-bold text-green-600" id="summary-planned">0%</p>
                        <p class="text-sm mt-1" id="summary-planned-trend"></p>
                    </div>
                </div>

                <!-- Work Breakdown and Highlights -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="card">
                        <h3 class="text-lg font-semibold text-themed-primary mb-4">Work Breakdown</h3>
                        <div class="h-48">
                            <canvas id="summary-breakdown-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-themed-primary mb-4">Key Highlights</h3>
                        <div id="summary-highlights" class="space-y-3"></div>
                    </div>
                </div>

                <!-- Activity Snapshot -->
                <div class="card">
                    <h3 class="text-lg font-semibold text-themed-primary mb-4">Activity Snapshot</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="summary-activity">
                    </div>
                </div>
            </div>

            <div id="tab-activity" class="tab-content hidden">
                <!-- Filters -->
                <div class="card mb-6">
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:flex lg:flex-wrap items-end gap-3 lg:gap-4">
                        <div class="flex flex-col gap-1">
                            <label class="text-xs text-gray-500">Tag</label>
                            <select id="filter-tag" class="filter-select w-full">
                                <option value="">All Tags</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-xs text-gray-500">Author</label>
                            <select id="filter-author" class="filter-select w-full">
                                <option value="">All Authors</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1" id="repo-filter-container" style="display: none;">
                            <label class="text-xs text-gray-500">Repo</label>
                            <select id="filter-repo" class="filter-select w-full">
                                <option value="">All Repos</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-xs text-gray-500">From</label>
                            <input type="date" id="filter-date-from" class="filter-input w-full">
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-xs text-gray-500">To</label>
                            <input type="date" id="filter-date-to" class="filter-input w-full">
                        </div>
                        <button id="clear-filters" class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded border border-gray-200 col-span-2 sm:col-span-1">
                            Clear Filters
                        </button>
                    </div>
                    <!-- Work Pattern Legend -->
                    <div class="mt-3 pt-3 border-t border-gray-100 flex flex-wrap items-center gap-3 text-xs text-gray-500">
                        <span>Work patterns:</span>
                        <span class="badge badge-after-hours">After Hours</span>
                        <span class="text-gray-400">before 8am or after 5pm</span>
                        <span class="badge badge-weekend">Weekend</span>
                        <span class="text-gray-400">Sat/Sun</span>
                        <span class="badge badge-holiday">Holiday</span>
                        <span class="text-gray-400">SA public holidays</span>
                    </div>
                </div>

                <!-- Activity Timeline Chart -->
                <div class="card mb-6">
                    <h2 class="text-lg font-semibold text-themed-primary mb-4">Activity Timeline</h2>
                    <p class="text-xs text-gray-500 -mt-2 mb-4">Commits by date across all projects</p>
                    <div class="h-48 md:h-64">
                        <canvas id="activity-timeline-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-themed-primary">Changes</h2>
                        <span id="commit-count" class="text-sm text-gray-500"></span>
                    </div>
                    <div id="commit-list" class="space-y-3 max-h-[600px] overflow-y-auto"></div>
                </div>
            </div>

            <div id="tab-progress" class="tab-content hidden">
                <div class="card mb-6">
                    <h2 class="text-lg font-semibold text-themed-primary mb-4">Work Type Trend</h2>
                    <p class="text-xs text-gray-500 -mt-2 mb-4">Features vs bug fixes over time</p>
                    <div class="h-64">
                        <canvas id="feat-fix-chart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-lg font-semibold text-themed-primary mb-4">Complexity Over Time</h2>
                    <p class="text-xs text-gray-500 -mt-2 mb-4">Average complexity by month</p>
                    <div class="h-64">
                        <canvas id="complexity-trend-chart"></canvas>
                    </div>
                </div>
            </div>

            <div id="tab-contributors" class="tab-content hidden">
                <div class="card mb-6">
                    <h2 class="text-lg font-semibold text-themed-primary mb-4">Who Does What</h2>
                    <p class="text-xs text-gray-500 -mt-2 mb-4">Work type distribution by contributor</p>
                    <div id="contributor-work-types" class="space-y-4"></div>
                </div>
                <div class="card">
                    <h2 class="text-lg font-semibold text-themed-primary mb-4">Complexity by Contributor</h2>
                    <p class="text-xs text-gray-500 -mt-2 mb-4">Who handles complex vs simple changes</p>
                    <div class="h-64">
                        <canvas id="contributor-complexity-chart"></canvas>
                    </div>
                </div>
            </div>

            <div id="tab-security" class="tab-content hidden">
                <!-- Operational Health Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-health-card="security">
                        <p class="text-sm text-gray-500 uppercase tracking-wide">Security</p>
                        <p class="text-3xl font-bold text-red-600" id="health-security-count">0</p>
                        <p class="text-xs text-gray-400">security commits</p>
                    </div>
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-health-card="reactive">
                        <p class="text-sm text-gray-500 uppercase tracking-wide">Reactive</p>
                        <p class="text-3xl font-bold text-amber-600" id="health-reactive-pct">0%</p>
                        <p class="text-xs text-gray-400">urgency 4-5</p>
                    </div>
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-health-card="weekend">
                        <p class="text-sm text-gray-500 uppercase tracking-wide">Weekend</p>
                        <p class="text-3xl font-bold text-indigo-600" id="health-weekend-pct">0%</p>
                        <p class="text-xs text-gray-400">Sat/Sun commits</p>
                    </div>
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-health-card="afterhours">
                        <p class="text-sm text-gray-500 uppercase tracking-wide">After Hours</p>
                        <p class="text-3xl font-bold text-purple-600" id="health-afterhours-pct">0%</p>
                        <p class="text-xs text-gray-400">outside work hours</p>
                    </div>
                </div>

                <!-- Urgency Distribution -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="card">
                        <h2 class="text-lg font-semibold text-themed-primary mb-4">Urgency Distribution</h2>
                        <p class="text-xs text-gray-500 -mt-2 mb-4">Planned (1-2) vs Normal (3) vs Reactive (4-5)</p>
                        <div id="urgency-breakdown" class="space-y-3"></div>
                    </div>
                    <div class="card">
                        <h2 class="text-lg font-semibold text-themed-primary mb-4">Impact Distribution</h2>
                        <p class="text-xs text-gray-500 -mt-2 mb-4">Where effort is directed</p>
                        <div id="impact-breakdown" class="space-y-3"></div>
                    </div>
                </div>

                <!-- Trend Charts -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="card">
                        <h2 class="text-lg font-semibold text-themed-primary mb-4">Urgency Trend</h2>
                        <p class="text-xs text-gray-500 -mt-2 mb-4">Average urgency by month (lower is better)</p>
                        <div class="h-48">
                            <canvas id="urgency-trend-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-lg font-semibold text-themed-primary mb-4">Impact Over Time</h2>
                        <p class="text-xs text-gray-500 -mt-2 mb-4">Distribution of impact categories by month</p>
                        <div class="h-48">
                            <canvas id="impact-trend-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Contributor Health -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="card">
                        <h2 class="text-lg font-semibold text-themed-primary mb-4">Urgency by Contributor</h2>
                        <p class="text-xs text-gray-500 -mt-2 mb-4">Who handles reactive vs planned work</p>
                        <div id="urgency-by-contributor" class="space-y-3"></div>
                    </div>
                    <div class="card">
                        <h2 class="text-lg font-semibold text-themed-primary mb-4">Impact by Contributor</h2>
                        <p class="text-xs text-gray-500 -mt-2 mb-4">Where each person's effort goes</p>
                        <div id="impact-by-contributor" class="space-y-3"></div>
                    </div>
                </div>

                <!-- Security Commits -->
                <div class="card">
                    <h2 class="text-lg font-semibold text-themed-primary mb-4">Security-Related Commits</h2>
                    <p class="text-sm text-gray-500 mb-4">Commits tagged with security, or containing security-related keywords</p>
                    <div id="security-list" class="space-y-3"></div>
                </div>
            </div>

            <div id="tab-tags" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <h2 class="text-lg font-semibold text-themed-primary mb-4">Commits by Tag</h2>
                        <p class="text-xs text-gray-500 -mt-2 mb-4">A commit can have multiple tags</p>
                        <div class="h-64">
                            <canvas id="tags-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-lg font-semibold text-themed-primary mb-4">Tag Breakdown</h2>
                        <p class="text-xs text-gray-500 -mt-2 mb-4">Tag occurrences (total may exceed commit count)</p>
                        <div id="tag-breakdown" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <div id="tab-timing" class="tab-content hidden">
                <div class="card mb-6">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                        <div>
                            <h2 class="text-lg font-semibold text-themed-primary">When Work Happens</h2>
                            <p class="text-xs text-gray-500">Commit distribution by time of day and day of week</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-gray-500">Timezone:</label>
                            <select id="timezone-select" class="filter-select text-sm">
                                <option value="local">Local</option>
                                <option value="utc">UTC</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Heatmap -->
                <div class="card mb-6">
                    <h2 class="text-lg font-semibold text-themed-primary mb-4">Activity Heatmap</h2>
                    <p class="text-xs text-gray-500 -mt-2 mb-4">Commits by hour and day of week (darker = more commits)</p>
                    <div id="heatmap-container" class="overflow-x-auto">
                        <div id="heatmap" class="heatmap-grid"></div>
                    </div>
                    <div class="flex items-center justify-center gap-2 mt-4 text-xs text-gray-500">
                        <span>Less</span>
                        <div class="flex gap-0.5">
                            <div class="w-4 h-4 rounded heatmap-0"></div>
                            <div class="w-4 h-4 rounded heatmap-1"></div>
                            <div class="w-4 h-4 rounded heatmap-2"></div>
                            <div class="w-4 h-4 rounded heatmap-3"></div>
                            <div class="w-4 h-4 rounded heatmap-4"></div>
                        </div>
                        <span>More</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <h2 class="text-lg font-semibold text-themed-primary mb-4">Commits by Hour of Day</h2>
                        <p class="text-xs text-gray-500 -mt-2 mb-4">Distribution across 24 hours (0-23)</p>
                        <div class="h-64">
                            <canvas id="hour-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-lg font-semibold text-themed-primary mb-4">Commits by Day of Week</h2>
                        <p class="text-xs text-gray-500 -mt-2 mb-4">Distribution across weekdays</p>
                        <div class="h-64">
                            <canvas id="day-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Developer Activity Patterns -->
                <div class="card mt-6">
                    <h2 class="text-lg font-semibold text-themed-primary mb-4">Developer Activity Patterns</h2>
                    <p class="text-xs text-gray-500 -mt-2 mb-4">When each contributor typically commits</p>
                    <div id="developer-patterns" class="space-y-4"></div>
                </div>

                <!-- Work Hours Settings -->
                <div class="card mt-6">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <div>
                            <h2 class="text-lg font-semibold text-themed-primary">Work Hours Settings</h2>
                            <p class="text-xs text-gray-500">Customize what counts as "work hours"</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2">
                                <label class="text-xs text-gray-500">Start:</label>
                                <select id="work-hour-start" class="filter-select text-sm">
                                    <option value="6">6:00</option>
                                    <option value="7">7:00</option>
                                    <option value="8" selected>8:00</option>
                                    <option value="9">9:00</option>
                                    <option value="10">10:00</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-xs text-gray-500">End:</label>
                                <select id="work-hour-end" class="filter-select text-sm">
                                    <option value="16">16:00</option>
                                    <option value="17" selected>17:00</option>
                                    <option value="18">18:00</option>
                                    <option value="19">19:00</option>
                                    <option value="20">20:00</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detail Pane (slide-out panel for drill-down) -->
        <div id="detail-overlay" class="detail-pane-overlay"></div>
        <div id="detail-pane" class="detail-pane">
            <div class="detail-pane-header">
                <div>
                    <div class="detail-pane-title" id="detail-title">Details</div>
                    <div class="detail-pane-subtitle" id="detail-subtitle"></div>
                </div>
                <button class="detail-pane-close" id="detail-close" title="Close panel">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="detail-pane-content" id="detail-content">
                <div class="detail-pane-loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // === Global State ===
        let data = null;
        let charts = {};
        let filters = {
            tag: '',
            author: '',
            repo: '',
            dateFrom: '',
            dateTo: ''
        };
        let useUTC = false;
        let isDarkMode = false;
        let workHourStart = 8;
        let workHourEnd = 17;
        let isSanitized = false;
        const anonymousNames = ['Developer A', 'Developer B', 'Developer C', 'Developer D', 'Developer E', 'Developer F', 'Developer G', 'Developer H'];
        const authorAnonMap = new Map();
        let detailPaneOpen = false;

        // === Detail Pane Functions ===
        function openDetailPane(title, subtitle, commits) {
            const overlay = document.getElementById('detail-overlay');
            const pane = document.getElementById('detail-pane');
            const titleEl = document.getElementById('detail-title');
            const subtitleEl = document.getElementById('detail-subtitle');
            const contentEl = document.getElementById('detail-content');

            titleEl.textContent = title;
            subtitleEl.textContent = subtitle || '';

            // Render commits in the detail pane
            if (commits && commits.length > 0) {
                contentEl.innerHTML = commits.map(commit => renderDetailCommit(commit)).join('');
            } else {
                contentEl.innerHTML = '<p class="text-gray-500 text-center py-8">No commits found</p>';
            }

            overlay.classList.add('open');
            pane.classList.add('open');
            detailPaneOpen = true;
            document.body.style.overflow = 'hidden';
        }

        function closeDetailPane() {
            const overlay = document.getElementById('detail-overlay');
            const pane = document.getElementById('detail-pane');

            overlay.classList.remove('open');
            pane.classList.remove('open');
            detailPaneOpen = false;
            document.body.style.overflow = '';
        }

        function renderDetailCommit(commit) {
            const tags = getCommitTags(commit);
            const email = getAuthorEmail(commit);
            const authorName = sanitizeName(getAuthorName(commit), email);
            const message = sanitizeMessage(commit.message);
            const date = new Date(commit.timestamp).toLocaleDateString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric'
            });

            const tagsHtml = tags.map(tag =>
                `<span class="tag tag-${tag}">${tag}</span>`
            ).join('');

            const urgencyLabel = commit.urgency ? getUrgencyLabel(commit.urgency) : '';
            const impactLabel = commit.impact ? commit.impact : '';

            return `
                <div class="detail-commit">
                    <div class="detail-commit-message">${escapeHtml(message)}</div>
                    <div class="detail-commit-meta">
                        <span>${authorName}</span>
                        <span>•</span>
                        <span>${date}</span>
                        ${commit.repo_id ? `<span>•</span><span>${commit.repo_id}</span>` : ''}
                        ${urgencyLabel ? `<span>•</span><span class="text-amber-600">${urgencyLabel}</span>` : ''}
                        ${impactLabel ? `<span>•</span><span class="text-blue-600">${impactLabel}</span>` : ''}
                    </div>
                    ${tags.length > 0 ? `<div class="detail-commit-tags">${tagsHtml}</div>` : ''}
                </div>
            `;
        }

        function getUrgencyLabel(urgency) {
            if (urgency <= 2) return 'Planned';
            if (urgency === 3) return 'Normal';
            return 'Reactive';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize detail pane event listeners
        function initDetailPane() {
            const overlay = document.getElementById('detail-overlay');
            const closeBtn = document.getElementById('detail-close');

            overlay.addEventListener('click', closeDetailPane);
            closeBtn.addEventListener('click', closeDetailPane);

            // Close on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && detailPaneOpen) {
                    closeDetailPane();
                }
            });
        }

        // Helper to filter commits by criteria and open detail pane
        function showCommitsInPane(title, subtitle, filterFn) {
            const commits = data.commits.filter(filterFn);
            openDetailPane(title, subtitle, commits);
        }

        // === Dark Mode ===
        function initDarkMode() {
            // Check localStorage first, then system preference
            const stored = localStorage.getItem('darkMode');
            if (stored !== null) {
                isDarkMode = stored === 'true';
            } else {
                isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
            }
            applyDarkMode();
        }

        function applyDarkMode() {
            document.documentElement.classList.toggle('dark', isDarkMode);
            document.getElementById('icon-sun').classList.toggle('hidden', !isDarkMode);
            document.getElementById('icon-moon').classList.toggle('hidden', isDarkMode);

            // Update Chart.js defaults for dark mode
            if (isDarkMode) {
                Chart.defaults.color = '#9ca3af';
                Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
            } else {
                Chart.defaults.color = '#6b7280';
                Chart.defaults.borderColor = 'rgba(0, 0, 0, 0.1)';
            }

            // Re-render charts if data is loaded
            if (data) {
                renderProgress();
                renderContributors();
                renderTags();
                renderTiming();
                renderSummary();
                renderHealth();
            }
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
            applyDarkMode();
        }

        // === Sanitization Mode ===
        function initSanitizeMode() {
            isSanitized = localStorage.getItem('sanitized') === 'true';
            applySanitizeMode();
        }

        function applySanitizeMode() {
            document.getElementById('icon-eye').classList.toggle('hidden', isSanitized);
            document.getElementById('icon-eye-slash').classList.toggle('hidden', !isSanitized);

            // Re-render views if data is loaded
            if (data) {
                renderTimeline();
                renderContributors();
                renderTiming();
                renderSummary();
            }
        }

        function toggleSanitizeMode() {
            isSanitized = !isSanitized;
            localStorage.setItem('sanitized', isSanitized);
            applySanitizeMode();
            showToast(isSanitized ? 'Private mode enabled' : 'Private mode disabled');
        }

        function getAnonymousName(email) {
            if (!authorAnonMap.has(email)) {
                const index = authorAnonMap.size % anonymousNames.length;
                authorAnonMap.set(email, anonymousNames[index]);
            }
            return authorAnonMap.get(email);
        }

        function sanitizeName(name, email) {
            if (!isSanitized) return name;
            return getAnonymousName(email);
        }

        function sanitizeMessage(message) {
            if (!isSanitized) return message;
            // Show only the type prefix if conventional commit, otherwise generic
            const match = message.match(/^(feat|fix|docs|style|refactor|test|chore|ci|build|perf|security)(\(.+?\))?:/i);
            if (match) {
                return match[0] + ' [message hidden]';
            }
            return '[Commit message hidden]';
        }

        // Initialize dark mode immediately (before DOM loads to prevent flash)
        (function() {
            const stored = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (stored === 'true' || (stored === null && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        })();

        // === South African Public Holidays ===
        // Format: 'YYYY-MM-DD' for fixed dates, calculated for moveable feasts
        const SA_HOLIDAYS = {
            // Fixed holidays (apply every year)
            fixed: [
                { month: 1, day: 1, name: "New Year's Day" },
                { month: 3, day: 21, name: "Human Rights Day" },
                { month: 4, day: 27, name: "Freedom Day" },
                { month: 5, day: 1, name: "Workers' Day" },
                { month: 6, day: 16, name: "Youth Day" },
                { month: 8, day: 9, name: "National Women's Day" },
                { month: 9, day: 24, name: "Heritage Day" },
                { month: 12, day: 16, name: "Day of Reconciliation" },
                { month: 12, day: 25, name: "Christmas Day" },
                { month: 12, day: 26, name: "Day of Goodwill" }
            ],
            // Easter-based holidays (Good Friday, Family Day) - pre-calculated for 2024-2027
            easter: {
                2024: { goodFriday: '2024-03-29', familyDay: '2024-04-01' },
                2025: { goodFriday: '2025-04-18', familyDay: '2025-04-21' },
                2026: { goodFriday: '2026-04-03', familyDay: '2026-04-06' },
                2027: { goodFriday: '2027-03-26', familyDay: '2027-03-29' }
            }
        };

        // Build holiday lookup set for quick checking
        function buildHolidaySet() {
            const holidays = new Set();
            // Add fixed holidays for years 2020-2030
            for (let year = 2020; year <= 2030; year++) {
                SA_HOLIDAYS.fixed.forEach(h => {
                    const dateStr = `${year}-${String(h.month).padStart(2, '0')}-${String(h.day).padStart(2, '0')}`;
                    holidays.add(dateStr);
                    // If holiday falls on Sunday, Monday is observed
                    const date = new Date(year, h.month - 1, h.day);
                    if (date.getDay() === 0) {
                        const monday = new Date(date);
                        monday.setDate(monday.getDate() + 1);
                        holidays.add(monday.toISOString().substring(0, 10));
                    }
                });
            }
            // Add Easter-based holidays
            Object.values(SA_HOLIDAYS.easter).forEach(e => {
                holidays.add(e.goodFriday);
                holidays.add(e.familyDay);
            });
            return holidays;
        }
        const holidaySet = buildHolidaySet();

        // === Work Pattern Helpers ===
        function getWorkPattern(commit) {
            const date = new Date(commit.timestamp);
            const hour = useUTC ? date.getUTCHours() : date.getHours();
            const dayOfWeek = useUTC ? date.getUTCDay() : date.getDay();
            const dateStr = commit.timestamp.substring(0, 10);

            return {
                isAfterHours: hour < workHourStart || hour >= workHourEnd,
                isWeekend: dayOfWeek === 0 || dayOfWeek === 6,
                isHoliday: holidaySet.has(dateStr),
                hour,
                dayOfWeek,
                dateStr
            };
        }

        function getWorkPatternBadges(commit) {
            const pattern = getWorkPattern(commit);
            const badges = [];

            if (pattern.isHoliday) {
                badges.push('<span class="badge badge-holiday">Holiday</span>');
            }
            if (pattern.isWeekend) {
                badges.push('<span class="badge badge-weekend">Weekend</span>');
            } else if (pattern.isAfterHours) {
                badges.push('<span class="badge badge-after-hours">After Hours</span>');
            }

            return badges.join(' ');
        }

        // === Tag Colors ===
        const TAG_COLORS = {
            feature: '#10b981',
            bugfix: '#ef4444',
            refactor: '#8b5cf6',
            docs: '#3b82f6',
            test: '#f59e0b',
            config: '#64748b',
            style: '#ec4899',
            cleanup: '#6b7280',
            security: '#dc2626',
            performance: '#06b6d4',
            dependency: '#84cc16',
            other: '#9ca3af'
        };

        // === Tag Helper Functions ===
        function getCommitTags(commit) {
            if (commit.tags && commit.tags.length > 0) {
                return commit.tags;
            }
            return ['other'];
        }

        function getAllTags(commits) {
            const tagSet = new Set();
            commits.forEach(c => {
                getCommitTags(c).forEach(tag => tagSet.add(tag));
            });
            return [...tagSet].sort();
        }

        function getTagColor(tag) {
            return TAG_COLORS[tag] || TAG_COLORS.other;
        }

        function getTagClass(tag) {
            return TAG_COLORS[tag] ? `tag-${tag}` : 'tag-other';
        }

        // === Author Resolution ===
        function getAuthorName(commit) {
            let name;
            // Try to resolve from metadata.authors using author_id
            if (commit.author_id && data.metadata?.authors?.[commit.author_id]) {
                name = data.metadata.authors[commit.author_id].name;
            } else {
                // Fall back to embedded author object
                name = commit.author?.name || commit.author_id || 'Unknown';
            }
            const email = getAuthorEmail(commit);
            return sanitizeName(name, email);
        }

        function getAuthorEmail(commit) {
            // Try to resolve from metadata.authors using author_id
            if (commit.author_id && data.metadata?.authors?.[commit.author_id]) {
                return data.metadata.authors[commit.author_id].email;
            }
            // Fall back to embedded author object or author_id
            return commit.author?.email || commit.author_id || 'unknown';
        }

        // === Summary Stats ===
        function getFilesChanged(commit) {
            // Handle different data formats: stats.filesChanged, filesChanged, files_changed
            return commit.stats?.filesChanged || commit.filesChanged || commit.files_changed || 0;
        }

        function updateSummaryStats() {
            // Files changed - sum of all file changes across commits (not unique files)
            const totalFileChanges = data.commits.reduce((sum, c) => sum + getFilesChanged(c), 0);
            const uniqueFiles = data.files?.length || 0;
            document.getElementById('stat-files').textContent = totalFileChanges.toLocaleString();
            document.getElementById('stat-files-sub').textContent = uniqueFiles > 0 ? `${uniqueFiles} unique files` : `across ${data.summary.totalCommits} commits`;

            // Average complexity
            const complexities = data.commits.map(c => c.complexity).filter(c => c != null);
            if (complexities.length > 0) {
                const avgComplexity = (complexities.reduce((a, b) => a + b, 0) / complexities.length).toFixed(1);
                document.getElementById('stat-complexity').textContent = avgComplexity;
                // Complexity distribution
                const high = complexities.filter(c => c >= 4).length;
                const low = complexities.filter(c => c <= 2).length;
                document.getElementById('stat-complexity-sub').textContent = `${high} complex, ${low} simple`;
            } else {
                document.getElementById('stat-complexity').textContent = '-';
                document.getElementById('stat-complexity-sub').textContent = 'not available';
            }

            // Top work type (most common tag)
            const tagCounts = {};
            data.commits.forEach(c => {
                getCommitTags(c).forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });
            const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);
            if (sortedTags.length > 0) {
                const [topTag, topCount] = sortedTags[0];
                const pct = Math.round((topCount / data.commits.length) * 100);
                document.getElementById('stat-top-tag').textContent = topTag;
                document.getElementById('stat-top-tag-sub').textContent = `${pct}% of changes`;
            }

            // Contributors
            document.getElementById('stat-contributors').textContent = data.summary.totalContributors;
        }

        // === Filter Functions ===
        function getFilteredCommits() {
            if (!data || !data.commits) return [];

            return data.commits.filter(commit => {
                // Tag filter - check if any of commit's tags match
                if (filters.tag) {
                    const commitTags = getCommitTags(commit);
                    if (!commitTags.includes(filters.tag)) return false;
                }

                // Author filter - check both author_id and author.email
                if (filters.author) {
                    const authorEmail = getAuthorEmail(commit);
                    if (authorEmail !== filters.author) return false;
                }

                // Repo filter
                if (filters.repo && commit.repo_id !== filters.repo) return false;

                // Date range filter
                if (filters.dateFrom) {
                    const commitDate = commit.timestamp?.substring(0, 10);
                    if (commitDate < filters.dateFrom) return false;
                }
                if (filters.dateTo) {
                    const commitDate = commit.timestamp?.substring(0, 10);
                    if (commitDate > filters.dateTo) return false;
                }

                return true;
            });
        }

        function populateFilters() {
            // Tag filter
            const tagSelect = document.getElementById('filter-tag');
            const tags = getAllTags(data.commits);
            tagSelect.innerHTML = '<option value="">All Tags</option>' +
                tags.map(t => `<option value="${t}">${t}</option>`).join('');

            // Author filter - use author resolution
            const authorSelect = document.getElementById('filter-author');
            const authorMap = {};
            data.commits.forEach(c => {
                const email = getAuthorEmail(c);
                const name = getAuthorName(c);
                if (email && !authorMap[email]) {
                    authorMap[email] = name;
                }
            });
            const authors = Object.keys(authorMap).sort();
            authorSelect.innerHTML = '<option value="">All Authors</option>' +
                authors.map(email => `<option value="${email}">${escapeHtml(authorMap[email] || email)}</option>`).join('');

            // Repo filter (only show if aggregated data)
            const repos = [...new Set(data.commits.map(c => c.repo_id).filter(Boolean))];
            const repoContainer = document.getElementById('repo-filter-container');
            if (repos.length > 1) {
                repoContainer.style.display = 'flex';
                const repoSelect = document.getElementById('filter-repo');
                repoSelect.innerHTML = '<option value="">All Repos</option>' +
                    repos.sort().map(r => `<option value="${r}">${r}</option>`).join('');
            } else {
                repoContainer.style.display = 'none';
            }

            // Date range defaults
            if (data.summary?.dateRange) {
                const fromInput = document.getElementById('filter-date-from');
                const toInput = document.getElementById('filter-date-to');
                if (data.summary.dateRange.earliest) {
                    fromInput.min = data.summary.dateRange.earliest.substring(0, 10);
                }
                if (data.summary.dateRange.latest) {
                    toInput.max = data.summary.dateRange.latest.substring(0, 10);
                }
            }
        }

        function setupFilterListeners() {
            document.getElementById('filter-tag').addEventListener('change', (e) => {
                filters.tag = e.target.value;
                applyFilters();
            });

            document.getElementById('filter-author').addEventListener('change', (e) => {
                filters.author = e.target.value;
                applyFilters();
            });

            document.getElementById('filter-repo').addEventListener('change', (e) => {
                filters.repo = e.target.value;
                applyFilters();
            });

            document.getElementById('filter-date-from').addEventListener('change', (e) => {
                filters.dateFrom = e.target.value;
                applyFilters();
            });

            document.getElementById('filter-date-to').addEventListener('change', (e) => {
                filters.dateTo = e.target.value;
                applyFilters();
            });

            document.getElementById('clear-filters').addEventListener('click', () => {
                filters = { tag: '', author: '', repo: '', dateFrom: '', dateTo: '' };
                document.getElementById('filter-tag').value = '';
                document.getElementById('filter-author').value = '';
                document.getElementById('filter-repo').value = '';
                document.getElementById('filter-date-from').value = '';
                document.getElementById('filter-date-to').value = '';
                applyFilters();
            });
        }

        function applyFilters() {
            renderTimeline();
            updateFilteredStats();
            saveFiltersToStorage();
        }

        // === Filter Persistence ===
        function saveFiltersToStorage() {
            const state = {
                filters,
                summaryPeriod,
                useUTC,
                workHourStart,
                workHourEnd,
                activeTab: document.querySelector('.tab-btn.border-blue-500')?.dataset.tab || 'overview'
            };
            localStorage.setItem('dashboardState', JSON.stringify(state));
        }

        function loadFiltersFromStorage() {
            try {
                const stored = localStorage.getItem('dashboardState');
                if (!stored) return false;

                const state = JSON.parse(stored);

                // Restore filters
                if (state.filters) {
                    filters = { ...filters, ...state.filters };
                    document.getElementById('filter-tag').value = filters.tag;
                    document.getElementById('filter-author').value = filters.author;
                    document.getElementById('filter-repo').value = filters.repo;
                    document.getElementById('filter-date-from').value = filters.dateFrom;
                    document.getElementById('filter-date-to').value = filters.dateTo;
                }

                // Restore summary period
                if (state.summaryPeriod) {
                    summaryPeriod = state.summaryPeriod;
                    document.getElementById('summary-period').value = summaryPeriod;
                }

                // Restore timezone
                if (state.useUTC !== undefined) {
                    useUTC = state.useUTC;
                    document.getElementById('timezone-select').value = useUTC ? 'utc' : 'local';
                }

                // Restore work hours
                if (state.workHourStart !== undefined) {
                    workHourStart = state.workHourStart;
                    document.getElementById('work-hour-start').value = workHourStart;
                }
                if (state.workHourEnd !== undefined) {
                    workHourEnd = state.workHourEnd;
                    document.getElementById('work-hour-end').value = workHourEnd;
                }

                // Restore active tab
                if (state.activeTab) {
                    const tabBtn = document.querySelector(`.tab-btn[data-tab="${state.activeTab}"]`);
                    if (tabBtn) tabBtn.click();
                }

                return true;
            } catch (e) {
                console.warn('Failed to restore dashboard state:', e);
                return false;
            }
        }

        function updateFilteredStats() {
            const filtered = getFilteredCommits();
            const total = data.commits.length;
            const filteredEl = document.getElementById('stat-commits-filtered');

            if (filtered.length !== total) {
                filteredEl.textContent = `(${filtered.length} shown)`;
            } else {
                filteredEl.textContent = '';
            }
        }

        // === Data Loading ===
        async function loadData(jsonData) {
            data = jsonData;
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');

            // Update header
            document.getElementById('repo-name').textContent = data.metadata.repository;
            document.getElementById('repo-subtitle').textContent =
                `${data.summary.totalCommits} commits from ${data.summary.totalContributors} contributors | ` +
                `${formatDate(data.summary.dateRange.earliest)} - ${formatDate(data.summary.dateRange.latest)}`;

            // Update stats - focus on meaningful metrics
            updateSummaryStats();

            // Populate and setup filters
            populateFilters();
            setupFilterListeners();

            // Setup export/share buttons
            setupExportButtons();

            // Load saved state from localStorage (URL params will override)
            const hasUrlParams = window.location.search.length > 1;
            if (!hasUrlParams) {
                loadFiltersFromStorage();
            }

            // Apply URL state (filters, tab, etc.) if present
            applyUrlState();

            // Render all views
            renderSummary();
            renderTimeline();
            renderProgress();
            renderContributors();
            renderSecurity();
            renderHealth();
            renderTags();
            renderTiming();
            setupSummaryPeriodToggle();
            setupTimezoneToggle();
            setupWorkHoursToggle();

            // Apply filters from URL after render
            if (hasActiveFilters()) {
                applyFilters();
            }
        }

        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            return new Date(isoString).toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric'
            });
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // === Timeline Tab ===
        function renderTimeline() {
            const filteredCommits = getFilteredCommits();

            // Update count
            document.getElementById('commit-count').textContent =
                `Showing ${Math.min(filteredCommits.length, 100)} of ${filteredCommits.length}`;

            // Render activity timeline chart
            renderActivityTimeline(filteredCommits);

            // Commit List - show tags, complexity, work patterns (no +/- lines)
            const listHtml = filteredCommits.slice(0, 100).map(commit => {
                const tags = getCommitTags(commit);
                const tagBadges = tags.slice(0, 3).map(t =>
                    `<span class="tag ${getTagClass(t)} shrink-0">${t}</span>`
                ).join(' ');
                const extraTags = tags.length > 3 ? `<span class="tag tag-other shrink-0">+${tags.length - 3}</span>` : '';
                const workPatternBadges = getWorkPatternBadges(commit);
                const complexityBadge = commit.complexity != null
                    ? `<span class="text-xs px-1.5 py-0.5 rounded ${commit.complexity >= 4 ? 'bg-purple-100 text-purple-700' : commit.complexity >= 2 ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'}">${commit.complexity}/5</span>`
                    : '';

                return `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-start gap-2 sm:gap-3">
                        <div class="flex flex-wrap gap-1 shrink-0">
                            ${tagBadges}${extraTags}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 break-words sm:truncate">${escapeHtml(sanitizeMessage(commit.subject))}</p>
                        </div>
                        ${complexityBadge}
                    </div>
                    <div class="mt-1 flex flex-wrap items-center gap-x-2 gap-y-1 text-xs text-gray-500">
                        <span>${escapeHtml(getAuthorName(commit))}</span>
                        <span>·</span>
                        <span>${formatDate(commit.timestamp)}</span>
                        ${commit.repo_id ? `<span class="text-gray-400">· ${commit.repo_id}</span>` : ''}
                        ${workPatternBadges ? `<span class="ml-1">${workPatternBadges}</span>` : ''}
                    </div>
                </div>
            `}).join('');
            document.getElementById('commit-list').innerHTML = listHtml || '<p class="text-gray-500">No changes match the current filters</p>';
        }

        function renderActivityTimeline(commits) {
            // Group commits by date
            const commitsByDate = {};
            const repoColors = {};
            const repos = [...new Set(commits.map(c => c.repo_id).filter(Boolean))];

            // Assign colors to repos
            const repoColorPalette = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#06b6d4'];
            repos.forEach((repo, i) => {
                repoColors[repo] = repoColorPalette[i % repoColorPalette.length];
            });

            commits.forEach(commit => {
                const dateStr = commit.timestamp?.substring(0, 10);
                if (!dateStr) return;
                if (!commitsByDate[dateStr]) {
                    commitsByDate[dateStr] = { total: 0, byRepo: {} };
                }
                commitsByDate[dateStr].total++;
                if (commit.repo_id) {
                    commitsByDate[dateStr].byRepo[commit.repo_id] = (commitsByDate[dateStr].byRepo[commit.repo_id] || 0) + 1;
                }
            });

            // Sort dates and limit to reasonable range (last 60 dates with activity)
            const sortedDates = Object.keys(commitsByDate).sort().slice(-60);

            if (sortedDates.length === 0) {
                if (charts.activityTimeline) charts.activityTimeline.destroy();
                return;
            }

            // Build datasets
            let datasets;
            if (repos.length > 1) {
                // Multi-repo: stacked bar chart by repo
                datasets = repos.map(repo => ({
                    label: repo,
                    data: sortedDates.map(d => commitsByDate[d]?.byRepo[repo] || 0),
                    backgroundColor: repoColors[repo],
                    borderRadius: 2
                }));
            } else {
                // Single repo: simple bar chart
                datasets = [{
                    label: 'Commits',
                    data: sortedDates.map(d => commitsByDate[d]?.total || 0),
                    backgroundColor: '#3b82f6',
                    borderRadius: 2
                }];
            }

            // Format date labels (show month/day for readability)
            const labels = sortedDates.map(d => {
                const date = new Date(d);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            if (charts.activityTimeline) charts.activityTimeline.destroy();
            charts.activityTimeline = new Chart(document.getElementById('activity-timeline-chart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: repos.length > 1,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            stacked: repos.length > 1,
                            ticks: {
                                maxRotation: 45,
                                callback: function(value, index) {
                                    // Show fewer labels on smaller datasets
                                    const step = Math.ceil(sortedDates.length / 15);
                                    return index % step === 0 ? this.getLabelForValue(value) : '';
                                }
                            }
                        },
                        y: {
                            stacked: repos.length > 1,
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        // === Progress Tab ===
        function renderProgress() {
            const months = Object.keys(data.summary.monthlyCommits).sort();

            // Feature vs Bug Fix Trend
            const monthlyTagCounts = {};
            const monthlyComplexity = {};
            data.commits.forEach(commit => {
                const month = commit.timestamp?.substring(0, 7);
                if (!month) return;
                if (!monthlyTagCounts[month]) monthlyTagCounts[month] = { feature: 0, bugfix: 0 };
                if (!monthlyComplexity[month]) monthlyComplexity[month] = { total: 0, count: 0 };
                const tags = getCommitTags(commit);
                if (tags.includes('feature')) monthlyTagCounts[month].feature++;
                if (tags.includes('bugfix')) monthlyTagCounts[month].bugfix++;
                if (commit.complexity != null) {
                    monthlyComplexity[month].total += commit.complexity;
                    monthlyComplexity[month].count++;
                }
            });
            const featData = months.map(m => monthlyTagCounts[m]?.feature || 0);
            const fixData = months.map(m => monthlyTagCounts[m]?.bugfix || 0);

            if (charts.featFix) charts.featFix.destroy();
            charts.featFix = new Chart(document.getElementById('feat-fix-chart'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Features',
                            data: featData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Bug Fixes',
                            data: fixData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Complexity Over Time
            const complexityData = months.map(m => {
                const mc = monthlyComplexity[m];
                return mc && mc.count > 0 ? (mc.total / mc.count) : null;
            });

            if (charts.complexityTrend) charts.complexityTrend.destroy();
            charts.complexityTrend = new Chart(document.getElementById('complexity-trend-chart'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Avg Complexity',
                        data: complexityData,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            min: 1,
                            max: 5,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        // === Contributors Tab ===
        function renderContributors() {
            // Build per-contributor stats from commits
            const contributorStats = {};
            data.commits.forEach(commit => {
                const email = getAuthorEmail(commit);
                const name = getAuthorName(commit);
                if (!contributorStats[email]) {
                    contributorStats[email] = {
                        name,
                        email,
                        tags: {},
                        complexities: []
                    };
                }
                getCommitTags(commit).forEach(tag => {
                    contributorStats[email].tags[tag] = (contributorStats[email].tags[tag] || 0) + 1;
                });
                if (commit.complexity != null) {
                    contributorStats[email].complexities.push(commit.complexity);
                }
            });

            // Sort by total changes
            const sorted = Object.values(contributorStats).sort((a, b) => {
                const aTotal = Object.values(a.tags).reduce((s, v) => s + v, 0);
                const bTotal = Object.values(b.tags).reduce((s, v) => s + v, 0);
                return bTotal - aTotal;
            });

            // Who Does What - work type breakdown per contributor
            const workTypesHtml = sorted.slice(0, 8).map(c => {
                const totalTags = Object.values(c.tags).reduce((s, v) => s + v, 0);
                const tagBars = Object.entries(c.tags)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([tag, count]) => {
                        const pct = Math.round((count / totalTags) * 100);
                        return `<div class="flex items-center gap-2">
                            <span class="tag tag-${tag} text-xs">${tag}</span>
                            <div class="flex-1 bg-gray-200 rounded-full h-2">
                                <div class="h-2 rounded-full" style="width: ${pct}%; background-color: ${getTagColor(tag)}"></div>
                            </div>
                            <span class="text-xs text-gray-500 w-8">${pct}%</span>
                        </div>`;
                    }).join('');
                return `
                    <div class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" data-contributor-email="${escapeHtml(c.email)}">
                        <p class="font-medium text-gray-900 mb-2">${escapeHtml(sanitizeName(c.name, c.email))}</p>
                        <div class="space-y-1">${tagBars}</div>
                    </div>
                `;
            }).join('');
            document.getElementById('contributor-work-types').innerHTML = workTypesHtml || '<p class="text-gray-500">No contributor data</p>';

            // Add click handlers for contributor cards
            document.querySelectorAll('[data-contributor-email]').forEach(el => {
                el.addEventListener('click', () => {
                    const email = el.dataset.contributorEmail;
                    const commits = data.commits.filter(c => getAuthorEmail(c) === email);
                    const name = commits.length > 0 ? sanitizeName(getAuthorName(commits[0]), email) : 'Unknown';
                    openDetailPane(`${name}'s Commits`, `${commits.length} commits`, commits);
                });
            });

            // Complexity by Contributor chart
            const top8 = sorted.slice(0, 8);
            const names = top8.map(c => c.name);
            const avgComplexities = top8.map(c => {
                if (c.complexities.length === 0) return 0;
                return c.complexities.reduce((a, b) => a + b, 0) / c.complexities.length;
            });

            if (charts.contributorComplexity) charts.contributorComplexity.destroy();
            charts.contributorComplexity = new Chart(document.getElementById('contributor-complexity-chart'), {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [{
                        label: 'Avg Complexity',
                        data: avgComplexities,
                        backgroundColor: avgComplexities.map(c => c >= 3.5 ? '#8b5cf6' : c >= 2.5 ? '#3b82f6' : '#94a3b8')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { min: 0, max: 5, ticks: { stepSize: 1 } }
                    }
                }
            });
        }

        // === Security Tab ===
        function renderSecurity() {
            // Use security_events from summary if available, otherwise compute
            let securityCommits;
            if (data.summary?.security_events?.length > 0) {
                // Map security_events back to full commits for display
                const securityShas = new Set(data.summary.security_events.map(e => e.sha));
                securityCommits = data.commits.filter(c => securityShas.has(c.sha));
            } else {
                securityCommits = data.commits.filter(c =>
                    c.type === 'security' || (c.tags || []).includes('security')
                );
            }

            document.getElementById('security-count').textContent = securityCommits.length;

            const listHtml = securityCommits.length > 0
                ? securityCommits.map(commit => `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex items-start gap-3">
                            <span class="tag tag-security">security</span>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">${escapeHtml(sanitizeMessage(commit.subject))}</p>
                                <p class="text-sm text-gray-600 mt-1">${isSanitized ? '[Details hidden]' : (escapeHtml(commit.body || '').substring(0, 200) || 'No description')}</p>
                                <p class="text-xs text-gray-500 mt-2">
                                    ${commit.sha} by ${escapeHtml(getAuthorName(commit))} on ${formatDate(commit.timestamp)}
                                    ${commit.repo_id ? `in ${commit.repo_id}` : ''}
                                </p>
                            </div>
                        </div>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-center py-8">No security-related commits found</p>';

            document.getElementById('security-list').innerHTML = listHtml;
        }

        // === Health Tab (Urgency & Impact) ===
        function renderHealth() {
            const commits = data.commits;
            const total = commits.length;

            // Security count
            const securityCount = commits.filter(c =>
                c.type === 'security' || (c.tags || []).includes('security')
            ).length;
            document.getElementById('health-security-count').textContent = securityCount;

            // Reactive percentage (urgency 4-5)
            const reactiveCount = commits.filter(c => c.urgency >= 4).length;
            const reactivePct = total > 0 ? Math.round((reactiveCount / total) * 100) : 0;
            document.getElementById('health-reactive-pct').textContent = `${reactivePct}%`;

            // Weekend percentage
            const weekendCount = commits.filter(c => {
                if (!c.timestamp) return false;
                const date = new Date(c.timestamp);
                const day = date.getDay();
                return day === 0 || day === 6;
            }).length;
            const weekendPct = total > 0 ? Math.round((weekendCount / total) * 100) : 0;
            document.getElementById('health-weekend-pct').textContent = `${weekendPct}%`;

            // After hours percentage
            const afterHoursCount = commits.filter(c => {
                if (!c.timestamp) return false;
                const date = new Date(c.timestamp);
                const hour = date.getHours();
                return hour < workHourStart || hour >= workHourEnd;
            }).length;
            const afterHoursPct = total > 0 ? Math.round((afterHoursCount / total) * 100) : 0;
            document.getElementById('health-afterhours-pct').textContent = `${afterHoursPct}%`;

            // Urgency breakdown
            const urgencyBreakdown = { planned: 0, normal: 0, reactive: 0 };
            commits.forEach(c => {
                if (c.urgency <= 2) urgencyBreakdown.planned++;
                else if (c.urgency === 3) urgencyBreakdown.normal++;
                else if (c.urgency >= 4) urgencyBreakdown.reactive++;
            });

            const urgencyHtml = [
                { label: 'Planned (1-2)', count: urgencyBreakdown.planned, color: 'bg-green-500', filter: 'planned' },
                { label: 'Normal (3)', count: urgencyBreakdown.normal, color: 'bg-blue-500', filter: 'normal' },
                { label: 'Reactive (4-5)', count: urgencyBreakdown.reactive, color: 'bg-amber-500', filter: 'reactive' }
            ].map(({ label, count, color, filter }) => {
                const pct = total > 0 ? Math.round((count / total) * 100) : 0;
                return `
                    <div class="cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 rounded p-2 -m-2 transition-colors" data-urgency-filter="${filter}">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">${label}</span>
                            <span class="text-gray-900 font-medium">${count} (${pct}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="${color} h-2 rounded-full" style="width: ${pct}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('urgency-breakdown').innerHTML = urgencyHtml;

            // Add click handlers for urgency bars
            document.querySelectorAll('[data-urgency-filter]').forEach(el => {
                el.addEventListener('click', () => {
                    const filter = el.dataset.urgencyFilter;
                    let filterFn, title;
                    if (filter === 'planned') {
                        filterFn = c => c.urgency <= 2;
                        title = 'Planned Work (Urgency 1-2)';
                    } else if (filter === 'normal') {
                        filterFn = c => c.urgency === 3;
                        title = 'Normal Work (Urgency 3)';
                    } else {
                        filterFn = c => c.urgency >= 4;
                        title = 'Reactive Work (Urgency 4-5)';
                    }
                    const commits = data.commits.filter(filterFn);
                    openDetailPane(title, `${commits.length} commits`, commits);
                });
            });

            // Impact breakdown
            const impactBreakdown = { 'user-facing': 0, 'internal': 0, 'infrastructure': 0, 'api': 0 };
            commits.forEach(c => {
                if (c.impact && impactBreakdown.hasOwnProperty(c.impact)) {
                    impactBreakdown[c.impact]++;
                }
            });

            const impactLabels = {
                'user-facing': { label: 'User-Facing', color: 'bg-blue-500' },
                'internal': { label: 'Internal', color: 'bg-gray-500' },
                'infrastructure': { label: 'Infrastructure', color: 'bg-purple-500' },
                'api': { label: 'API', color: 'bg-green-500' }
            };

            const impactHtml = Object.entries(impactBreakdown)
                .sort((a, b) => b[1] - a[1])
                .map(([key, count]) => {
                    const { label, color } = impactLabels[key] || { label: key, color: 'bg-gray-400' };
                    const pct = total > 0 ? Math.round((count / total) * 100) : 0;
                    return `
                        <div class="cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 rounded p-2 -m-2 transition-colors" data-impact-filter="${key}">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-600">${label}</span>
                                <span class="text-gray-900 font-medium">${count} (${pct}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="${color} h-2 rounded-full" style="width: ${pct}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            document.getElementById('impact-breakdown').innerHTML = impactHtml;

            // Add click handlers for impact bars
            document.querySelectorAll('[data-impact-filter]').forEach(el => {
                el.addEventListener('click', () => {
                    const impact = el.dataset.impactFilter;
                    const label = impactLabels[impact]?.label || impact;
                    const commits = data.commits.filter(c => c.impact === impact);
                    openDetailPane(`${label} Impact`, `${commits.length} commits`, commits);
                });
            });

            // Urgency Trend Chart (line chart by month)
            const monthlyUrgency = {};
            commits.forEach(c => {
                if (!c.timestamp || !c.urgency) return;
                const month = c.timestamp.substring(0, 7);
                if (!monthlyUrgency[month]) {
                    monthlyUrgency[month] = { sum: 0, count: 0 };
                }
                monthlyUrgency[month].sum += c.urgency;
                monthlyUrgency[month].count++;
            });

            const sortedMonths = Object.keys(monthlyUrgency).sort();
            const urgencyData = sortedMonths.map(m =>
                Math.round((monthlyUrgency[m].sum / monthlyUrgency[m].count) * 100) / 100
            );

            if (charts.urgencyTrend) charts.urgencyTrend.destroy();
            charts.urgencyTrend = new Chart(document.getElementById('urgency-trend-chart'), {
                type: 'line',
                data: {
                    labels: sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                    }),
                    datasets: [{
                        label: 'Avg Urgency',
                        data: urgencyData,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { min: 1, max: 5, ticks: { stepSize: 1 } }
                    }
                }
            });

            // Impact Over Time Chart (stacked bar)
            const monthlyImpact = {};
            commits.forEach(c => {
                if (!c.timestamp || !c.impact) return;
                const month = c.timestamp.substring(0, 7);
                if (!monthlyImpact[month]) {
                    monthlyImpact[month] = { 'user-facing': 0, 'internal': 0, 'infrastructure': 0, 'api': 0 };
                }
                if (monthlyImpact[month].hasOwnProperty(c.impact)) {
                    monthlyImpact[month][c.impact]++;
                }
            });

            const impactColors = {
                'user-facing': '#3b82f6',
                'internal': '#6b7280',
                'infrastructure': '#8b5cf6',
                'api': '#10b981'
            };

            if (charts.impactTrend) charts.impactTrend.destroy();
            charts.impactTrend = new Chart(document.getElementById('impact-trend-chart'), {
                type: 'bar',
                data: {
                    labels: sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                    }),
                    datasets: ['user-facing', 'internal', 'infrastructure', 'api'].map(impact => ({
                        label: impact,
                        data: sortedMonths.map(m => monthlyImpact[m]?.[impact] || 0),
                        backgroundColor: impactColors[impact]
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } },
                    scales: { x: { stacked: true }, y: { stacked: true } }
                }
            });

            // Urgency by Contributor
            const contributorUrgency = {};
            commits.forEach(c => {
                const email = getAuthorEmail(c);
                const name = getAuthorName(c);
                if (!contributorUrgency[email]) {
                    contributorUrgency[email] = { name, email, planned: 0, normal: 0, reactive: 0, total: 0 };
                }
                contributorUrgency[email].total++;
                if (c.urgency <= 2) contributorUrgency[email].planned++;
                else if (c.urgency === 3) contributorUrgency[email].normal++;
                else if (c.urgency >= 4) contributorUrgency[email].reactive++;
            });

            const sortedContributors = Object.values(contributorUrgency)
                .sort((a, b) => b.total - a.total)
                .slice(0, 6);

            const urgencyByContributorHtml = sortedContributors.map(c => {
                const plannedPct = Math.round((c.planned / c.total) * 100);
                const normalPct = Math.round((c.normal / c.total) * 100);
                const reactivePct = Math.round((c.reactive / c.total) * 100);
                return `
                    <div class="cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 rounded p-2 -m-2 transition-colors" data-contributor-urgency="${escapeHtml(c.email)}">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-700 font-medium">${escapeHtml(sanitizeName(c.name, c.email))}</span>
                            <span class="text-gray-500">${c.total} commits</span>
                        </div>
                        <div class="w-full h-2 rounded-full flex overflow-hidden">
                            <div class="bg-green-500 h-full" style="width: ${plannedPct}%" title="Planned: ${c.planned}"></div>
                            <div class="bg-blue-500 h-full" style="width: ${normalPct}%" title="Normal: ${c.normal}"></div>
                            <div class="bg-amber-500 h-full" style="width: ${reactivePct}%" title="Reactive: ${c.reactive}"></div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('urgency-by-contributor').innerHTML = urgencyByContributorHtml || '<p class="text-gray-500 text-sm">No data</p>';

            // Click handlers for urgency by contributor
            document.querySelectorAll('[data-contributor-urgency]').forEach(el => {
                el.addEventListener('click', () => {
                    const email = el.dataset.contributorUrgency;
                    const commits = data.commits.filter(c => getAuthorEmail(c) === email);
                    const name = commits.length > 0 ? sanitizeName(getAuthorName(commits[0]), email) : 'Unknown';
                    openDetailPane(`${name}'s Commits`, `${commits.length} commits`, commits);
                });
            });

            // Impact by Contributor
            const contributorImpact = {};
            commits.forEach(c => {
                const email = getAuthorEmail(c);
                const name = getAuthorName(c);
                if (!contributorImpact[email]) {
                    contributorImpact[email] = { name, email, 'user-facing': 0, 'internal': 0, 'infrastructure': 0, 'api': 0, total: 0 };
                }
                contributorImpact[email].total++;
                if (c.impact && contributorImpact[email].hasOwnProperty(c.impact)) {
                    contributorImpact[email][c.impact]++;
                }
            });

            const sortedContributorsImpact = Object.values(contributorImpact)
                .sort((a, b) => b.total - a.total)
                .slice(0, 6);

            const impactByContributorHtml = sortedContributorsImpact.map(c => {
                const userPct = Math.round((c['user-facing'] / c.total) * 100);
                const internalPct = Math.round((c['internal'] / c.total) * 100);
                const infraPct = Math.round((c['infrastructure'] / c.total) * 100);
                const apiPct = Math.round((c['api'] / c.total) * 100);
                return `
                    <div class="cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 rounded p-2 -m-2 transition-colors" data-contributor-impact="${escapeHtml(c.email)}">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-700 font-medium">${escapeHtml(sanitizeName(c.name, c.email))}</span>
                            <span class="text-gray-500">${c.total} commits</span>
                        </div>
                        <div class="w-full h-2 rounded-full flex overflow-hidden">
                            <div class="bg-blue-500 h-full" style="width: ${userPct}%" title="User-facing: ${c['user-facing']}"></div>
                            <div class="bg-gray-500 h-full" style="width: ${internalPct}%" title="Internal: ${c['internal']}"></div>
                            <div class="bg-purple-500 h-full" style="width: ${infraPct}%" title="Infrastructure: ${c['infrastructure']}"></div>
                            <div class="bg-green-500 h-full" style="width: ${apiPct}%" title="API: ${c['api']}"></div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('impact-by-contributor').innerHTML = impactByContributorHtml || '<p class="text-gray-500 text-sm">No data</p>';

            // Click handlers for impact by contributor
            document.querySelectorAll('[data-contributor-impact]').forEach(el => {
                el.addEventListener('click', () => {
                    const email = el.dataset.contributorImpact;
                    const commits = data.commits.filter(c => getAuthorEmail(c) === email);
                    const name = commits.length > 0 ? sanitizeName(getAuthorName(commits[0]), email) : 'Unknown';
                    openDetailPane(`${name}'s Commits`, `${commits.length} commits`, commits);
                });
            });

            // Add click handlers for health cards
            document.querySelectorAll('[data-health-card]').forEach(el => {
                el.addEventListener('click', () => {
                    const cardType = el.dataset.healthCard;
                    let filteredCommits, title;

                    if (cardType === 'security') {
                        filteredCommits = commits.filter(c =>
                            c.type === 'security' || (c.tags || []).includes('security')
                        );
                        title = 'Security Commits';
                    } else if (cardType === 'reactive') {
                        filteredCommits = commits.filter(c => c.urgency >= 4);
                        title = 'Reactive Work (Urgency 4-5)';
                    } else if (cardType === 'weekend') {
                        filteredCommits = commits.filter(c => {
                            if (!c.timestamp) return false;
                            const date = new Date(c.timestamp);
                            const day = date.getDay();
                            return day === 0 || day === 6;
                        });
                        title = 'Weekend Commits';
                    } else if (cardType === 'afterhours') {
                        filteredCommits = commits.filter(c => {
                            if (!c.timestamp) return false;
                            const date = new Date(c.timestamp);
                            const hour = date.getHours();
                            return hour < workHourStart || hour >= workHourEnd;
                        });
                        title = 'After Hours Commits';
                    }

                    if (filteredCommits) {
                        openDetailPane(title, `${filteredCommits.length} commits`, filteredCommits);
                    }
                });
            });
        }

        // === Tags Tab ===
        function renderTags() {
            // Build tag breakdown from commits (counting each tag occurrence)
            const tagBreakdown = {};
            data.commits.forEach(commit => {
                const tags = getCommitTags(commit);
                tags.forEach(tag => {
                    tagBreakdown[tag] = (tagBreakdown[tag] || 0) + 1;
                });
            });

            // Sort tags by count (descending) for consistent display
            const sortedTags = Object.entries(tagBreakdown)
                .map(([tag, count]) => ({ tag, count }))
                .sort((a, b) => b.count - a.count);

            const tags = sortedTags.map(t => t.tag);
            const counts = sortedTags.map(t => t.count);
            const colors = tags.map(t => getTagColor(t));
            const total = counts.reduce((a, b) => a + b, 0);

            // Tags Pie Chart
            if (charts.tags) charts.tags.destroy();
            charts.tags = new Chart(document.getElementById('tags-chart'), {
                type: 'doughnut',
                data: {
                    labels: tags,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });

            const breakdownHtml = sortedTags.map(({ tag, count }) => `
                <div class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 rounded p-2 -m-2 transition-colors" data-tag-filter="${tag}">
                    <span class="tag ${getTagClass(tag)}">${tag}</span>
                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full" style="width: ${(count / total * 100).toFixed(1)}%; background-color: ${getTagColor(tag)}"></div>
                    </div>
                    <span class="text-sm text-gray-600">${count} (${(count / total * 100).toFixed(1)}%)</span>
                </div>
            `).join('');
            document.getElementById('tag-breakdown').innerHTML = breakdownHtml;

            // Add click handlers for tag bars
            document.querySelectorAll('[data-tag-filter]').forEach(el => {
                el.addEventListener('click', () => {
                    const tag = el.dataset.tagFilter;
                    const commits = data.commits.filter(c => (c.tags || []).includes(tag));
                    openDetailPane(`${tag} Commits`, `${commits.length} commits`, commits);
                });
            });
        }

        // === Timing Tab ===
        const DAY_NAMES = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const DAY_NAMES_SHORT = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        function getCommitDateTime(commit) {
            const date = new Date(commit.timestamp);
            if (useUTC) {
                return {
                    hour: date.getUTCHours(),
                    dayOfWeek: date.getUTCDay()
                };
            }
            return {
                hour: date.getHours(),
                dayOfWeek: date.getDay()
            };
        }

        function renderTiming() {
            // Render the heatmap first
            renderHeatmap();

            // Aggregate commits by hour (0-23)
            const byHour = new Array(24).fill(0);
            // Aggregate commits by day of week (0=Sun, 6=Sat)
            const byDay = new Array(7).fill(0);

            data.commits.forEach(commit => {
                const { hour, dayOfWeek } = getCommitDateTime(commit);
                byHour[hour]++;
                byDay[dayOfWeek]++;
            });

            // Hour Chart
            const hourLabels = Array.from({ length: 24 }, (_, i) =>
                i.toString().padStart(2, '0') + ':00'
            );

            if (charts.hour) charts.hour.destroy();
            charts.hour = new Chart(document.getElementById('hour-chart'), {
                type: 'bar',
                data: {
                    labels: hourLabels,
                    datasets: [{
                        label: 'Commits',
                        data: byHour,
                        backgroundColor: byHour.map((_, i) =>
                            (i >= workHourStart && i < workHourEnd) ? '#3b82f6' : '#94a3b8'
                        ),
                        borderRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: (ctx) => {
                                    const hour = ctx.dataIndex;
                                    if (hour >= workHourStart && hour < workHourEnd) return 'Work hours';
                                    return 'After hours';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                callback: function(value, index) {
                                    // Show every 3rd label to reduce clutter
                                    return index % 3 === 0 ? this.getLabelForValue(value) : '';
                                }
                            }
                        },
                        y: { beginAtZero: true }
                    }
                }
            });

            // Day of Week Chart - reorder to start with Monday
            const mondayFirstOrder = [1, 2, 3, 4, 5, 6, 0]; // Mon-Sun
            const dayLabels = mondayFirstOrder.map(i => DAY_NAMES_SHORT[i]);
            const dayData = mondayFirstOrder.map(i => byDay[i]);

            if (charts.day) charts.day.destroy();
            charts.day = new Chart(document.getElementById('day-chart'), {
                type: 'bar',
                data: {
                    labels: dayLabels,
                    datasets: [{
                        label: 'Commits',
                        data: dayData,
                        backgroundColor: dayData.map((_, i) =>
                            (i < 5) ? '#3b82f6' : '#94a3b8'  // Mon-Fri blue, Sat-Sun gray
                        ),
                        borderRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: (ctx) => {
                                    return ctx.dataIndex < 5 ? 'Weekday' : 'Weekend';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Render developer activity patterns
            renderDeveloperPatterns();
        }

        function renderHeatmap() {
            // Build 24x7 matrix (hours x days)
            const matrix = Array.from({ length: 24 }, () => new Array(7).fill(0));

            data.commits.forEach(commit => {
                const { hour, dayOfWeek } = getCommitDateTime(commit);
                matrix[hour][dayOfWeek]++;
            });

            // Find max for intensity scaling
            const maxCount = Math.max(...matrix.flat(), 1);

            // Get intensity level (0-4)
            const getIntensity = (count) => {
                if (count === 0) return 0;
                const ratio = count / maxCount;
                if (ratio <= 0.25) return 1;
                if (ratio <= 0.5) return 2;
                if (ratio <= 0.75) return 3;
                return 4;
            };

            // Reorder to Monday-first
            const dayOrder = [1, 2, 3, 4, 5, 6, 0]; // Mon-Sun
            const dayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

            // Build HTML
            let html = '';

            // Header row (empty corner + day names)
            html += '<div class="heatmap-label"></div>';
            dayLabels.forEach(day => {
                html += `<div class="heatmap-header">${day}</div>`;
            });

            // Data rows (hour label + cells)
            for (let hour = 0; hour < 24; hour++) {
                // Hour label (show every 3 hours)
                const hourLabel = hour % 3 === 0 ? `${hour.toString().padStart(2, '0')}:00` : '';
                html += `<div class="heatmap-label">${hourLabel}</div>`;

                // Day cells
                dayOrder.forEach((dayIdx, i) => {
                    const count = matrix[hour][dayIdx];
                    const intensity = getIntensity(count);
                    const isWorkHours = hour >= 8 && hour < 17;
                    const isWeekday = i < 5;
                    const tooltip = `${dayLabels[i]} ${hour}:00 - ${count} commit${count !== 1 ? 's' : ''}`;

                    html += `<div class="heatmap-cell heatmap-${intensity}" title="${tooltip}">${count || ''}</div>`;
                });
            }

            document.getElementById('heatmap').innerHTML = html;
        }

        function setupTimezoneToggle() {
            document.getElementById('timezone-select').addEventListener('change', (e) => {
                useUTC = e.target.value === 'utc';
                renderTiming();
                saveFiltersToStorage();
            });
        }

        function setupWorkHoursToggle() {
            document.getElementById('work-hour-start').addEventListener('change', (e) => {
                workHourStart = parseInt(e.target.value);
                renderTiming();
                renderTimeline();
                renderSummary();
                saveFiltersToStorage();
            });
            document.getElementById('work-hour-end').addEventListener('change', (e) => {
                workHourEnd = parseInt(e.target.value);
                renderTiming();
                renderTimeline();
                renderSummary();
                saveFiltersToStorage();
            });
        }

        function renderDeveloperPatterns() {
            // Get per-author timing data
            const authorPatterns = {};

            data.commits.forEach(commit => {
                const email = getAuthorEmail(commit);
                const name = getAuthorName(commit);
                const { hour, dayOfWeek } = getCommitDateTime(commit);

                if (!authorPatterns[email]) {
                    authorPatterns[email] = {
                        name,
                        email,
                        commitCount: 0,
                        byHour: new Array(24).fill(0),
                        byDay: new Array(7).fill(0),
                        afterHours: 0,
                        weekend: 0
                    };
                }

                authorPatterns[email].commitCount++;
                authorPatterns[email].byHour[hour]++;
                authorPatterns[email].byDay[dayOfWeek]++;

                if (hour < workHourStart || hour >= workHourEnd) {
                    authorPatterns[email].afterHours++;
                }
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    authorPatterns[email].weekend++;
                }
            });

            // Sort by commit count
            const sorted = Object.values(authorPatterns).sort((a, b) => b.commitCount - a.commitCount);

            // Render top contributors
            const html = sorted.slice(0, 6).map(author => {
                // Find peak hour
                const peakHour = author.byHour.indexOf(Math.max(...author.byHour));
                // Find peak day
                const mondayFirstOrder = [1, 2, 3, 4, 5, 6, 0];
                const dayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                const peakDayIdx = author.byDay.indexOf(Math.max(...author.byDay));
                const peakDayLabel = DAY_NAMES_SHORT[peakDayIdx];

                // After hours percentage
                const afterHoursPct = Math.round((author.afterHours / author.commitCount) * 100);
                const weekendPct = Math.round((author.weekend / author.commitCount) * 100);

                // Mini sparkline for hours (simplified - just show work vs after hours)
                const workHoursCommits = author.byHour.slice(workHourStart, workHourEnd).reduce((a, b) => a + b, 0);
                const workHoursPct = Math.round((workHoursCommits / author.commitCount) * 100);

                return `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-gray-900">${escapeHtml(author.name)}</span>
                            <span class="text-xs text-gray-500">${author.commitCount} commits</span>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs">
                            <div class="p-2 bg-white rounded">
                                <span class="text-gray-500">Peak Hour</span>
                                <p class="font-semibold text-gray-900">${peakHour.toString().padStart(2, '0')}:00</p>
                            </div>
                            <div class="p-2 bg-white rounded">
                                <span class="text-gray-500">Peak Day</span>
                                <p class="font-semibold text-gray-900">${peakDayLabel}</p>
                            </div>
                            <div class="p-2 bg-white rounded">
                                <span class="text-gray-500">Work Hours</span>
                                <p class="font-semibold ${workHoursPct >= 70 ? 'text-green-600' : workHoursPct >= 50 ? 'text-amber-600' : 'text-red-600'}">${workHoursPct}%</p>
                            </div>
                            <div class="p-2 bg-white rounded">
                                <span class="text-gray-500">Weekends</span>
                                <p class="font-semibold ${weekendPct <= 10 ? 'text-green-600' : weekendPct <= 25 ? 'text-amber-600' : 'text-red-600'}">${weekendPct}%</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('developer-patterns').innerHTML = html || '<p class="text-gray-500">No contributor data</p>';
        }

        // === Executive Summary Tab ===
        let summaryPeriod = '7days';

        function getPeriodDates(period) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let currentStart, currentEnd, previousStart, previousEnd;

            // Helper to set time to end of day (23:59:59.999)
            function endOfDay(date) {
                const d = new Date(date);
                d.setHours(23, 59, 59, 999);
                return d;
            }

            if (period === '7days') {
                // Rolling last 7 days (including today)
                currentStart = new Date(today);
                currentStart.setDate(today.getDate() - 6);
                currentEnd = endOfDay(today);
                // Previous 7 days before that
                previousStart = new Date(currentStart);
                previousStart.setDate(previousStart.getDate() - 7);
                previousEnd = new Date(currentStart);
                previousEnd.setDate(previousEnd.getDate() - 1);
                previousEnd = endOfDay(previousEnd);
            } else if (period === '30days') {
                // Rolling last 30 days (including today)
                currentStart = new Date(today);
                currentStart.setDate(today.getDate() - 29);
                currentEnd = endOfDay(today);
                // Previous 30 days before that
                previousStart = new Date(currentStart);
                previousStart.setDate(previousStart.getDate() - 30);
                previousEnd = new Date(currentStart);
                previousEnd.setDate(previousEnd.getDate() - 1);
                previousEnd = endOfDay(previousEnd);
            } else { // quarter
                const quarter = Math.floor(today.getMonth() / 3);
                currentStart = new Date(today.getFullYear(), quarter * 3, 1);
                currentEnd = endOfDay(today);
                previousStart = new Date(today.getFullYear(), (quarter - 1) * 3, 1);
                previousEnd = endOfDay(new Date(today.getFullYear(), quarter * 3, 0));
            }

            return {
                current: { start: currentStart, end: currentEnd },
                previous: { start: previousStart, end: previousEnd }
            };
        }

        function getCommitsInRange(commits, start, end) {
            return commits.filter(c => {
                const date = new Date(c.timestamp);
                return date >= start && date <= end;
            });
        }

        function getTrendHtml(current, previous, label) {
            if (previous === 0) {
                return current > 0
                    ? `<span class="text-green-600">+${current} new</span>`
                    : `<span class="text-gray-400">No change</span>`;
            }
            const change = current - previous;
            const pct = Math.round((change / previous) * 100);
            if (change > 0) {
                return `<span class="text-green-600">↑ ${pct}% vs ${label}</span>`;
            } else if (change < 0) {
                return `<span class="text-red-600">↓ ${Math.abs(pct)}% vs ${label}</span>`;
            }
            return `<span class="text-gray-400">No change</span>`;
        }

        function renderSummary() {
            const periods = getPeriodDates(summaryPeriod);
            const periodLabel = summaryPeriod === '7days' ? 'previous 7 days'
                : summaryPeriod === '30days' ? 'previous 30 days' : 'last quarter';

            const currentCommits = getCommitsInRange(data.commits, periods.current.start, periods.current.end);
            const previousCommits = getCommitsInRange(data.commits, periods.previous.start, periods.previous.end);

            // Count metrics for current period
            const countTag = (commits, tag) => commits.filter(c =>
                getCommitTags(c).includes(tag)
            ).length;

            const currentFeatures = countTag(currentCommits, 'feature');
            const previousFeatures = countTag(previousCommits, 'feature');
            const currentFixes = countTag(currentCommits, 'bugfix');
            const previousFixes = countTag(previousCommits, 'bugfix');

            // Urgency metrics
            const getAvgUrgency = (commits) => {
                const urgencies = commits.map(c => c.urgency).filter(u => u != null && u >= 1 && u <= 5);
                return urgencies.length > 0
                    ? (urgencies.reduce((a, b) => a + b, 0) / urgencies.length)
                    : 0;
            };
            const currentUrgency = getAvgUrgency(currentCommits);
            const previousUrgency = getAvgUrgency(previousCommits);

            // Planned percentage (urgency 1-2)
            const getPlannedPct = (commits) => {
                const withUrgency = commits.filter(c => c.urgency != null && c.urgency >= 1 && c.urgency <= 5);
                if (withUrgency.length === 0) return 0;
                const planned = withUrgency.filter(c => c.urgency <= 2).length;
                return Math.round((planned / withUrgency.length) * 100);
            };
            const currentPlanned = getPlannedPct(currentCommits);
            const previousPlanned = getPlannedPct(previousCommits);

            // Update stats - focus on what matters
            document.getElementById('summary-features').textContent = currentFeatures;
            document.getElementById('summary-features-trend').innerHTML = getTrendHtml(currentFeatures, previousFeatures, periodLabel);

            document.getElementById('summary-fixes').textContent = currentFixes;
            document.getElementById('summary-fixes-trend').innerHTML = getTrendHtml(currentFixes, previousFixes, periodLabel);

            document.getElementById('summary-urgency').textContent = currentUrgency > 0 ? currentUrgency.toFixed(1) : '-';
            document.getElementById('summary-urgency-trend').innerHTML = currentUrgency > 0
                ? getTrendHtml(Math.round(previousUrgency * 10), Math.round(currentUrgency * 10), periodLabel, true) // Inverted: lower is better
                : '<span class="text-gray-400">No data</span>';

            document.getElementById('summary-planned').textContent = currentPlanned > 0 ? `${currentPlanned}%` : '-';
            document.getElementById('summary-planned-trend').innerHTML = currentPlanned > 0
                ? getTrendHtml(currentPlanned, previousPlanned, periodLabel) // Higher is better
                : '<span class="text-gray-400">No data</span>';

            // Work breakdown chart
            const tagCounts = {};
            currentCommits.forEach(c => {
                getCommitTags(c).forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });
            const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);

            if (charts.summaryBreakdown) charts.summaryBreakdown.destroy();
            charts.summaryBreakdown = new Chart(document.getElementById('summary-breakdown-chart'), {
                type: 'doughnut',
                data: {
                    labels: sortedTags.map(t => t[0]),
                    datasets: [{
                        data: sortedTags.map(t => t[1]),
                        backgroundColor: sortedTags.map(t => getTagColor(t[0]))
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });

            // Key highlights - focus on meaningful insights
            const highlights = [];

            // Complexity breakdown
            const complexChanges = currentCommits.filter(c => c.complexity >= 4).length;
            const simpleChanges = currentCommits.filter(c => c.complexity != null && c.complexity <= 2).length;
            if (complexChanges > 0 || simpleChanges > 0) {
                highlights.push({
                    label: 'Complex Changes',
                    value: `${complexChanges} high complexity`,
                    subvalue: `${simpleChanges} simple`
                });
            }

            // Most active repo (if aggregated)
            const repoCounts = {};
            currentCommits.forEach(c => {
                if (c.repo_id) {
                    repoCounts[c.repo_id] = (repoCounts[c.repo_id] || 0) + 1;
                }
            });
            const repos = Object.keys(repoCounts);
            if (repos.length > 1) {
                const topRepo = Object.entries(repoCounts).sort((a, b) => b[1] - a[1])[0];
                const topPct = Math.round((topRepo[1] / currentCommits.length) * 100);
                highlights.push({
                    label: 'Most Active Repo',
                    value: topRepo[0],
                    subvalue: `${topPct}% of work`
                });
            }

            // Work pattern summary
            const afterHoursCount = currentCommits.filter(c => getWorkPattern(c).isAfterHours).length;
            const weekendCount = currentCommits.filter(c => getWorkPattern(c).isWeekend).length;
            const afterHoursPct = currentCommits.length > 0
                ? Math.round((afterHoursCount / currentCommits.length) * 100)
                : 0;
            if (afterHoursPct > 0 || weekendCount > 0) {
                highlights.push({
                    label: 'Off-Hours Work',
                    value: `${afterHoursPct}% after hours`,
                    subvalue: `${weekendCount} weekend`
                });
            }

            // Refactoring ratio
            const refactorCount = currentCommits.filter(c => getCommitTags(c).includes('refactor')).length;
            const testCount = currentCommits.filter(c => getCommitTags(c).includes('test')).length;
            if (refactorCount > 0 || testCount > 0) {
                highlights.push({
                    label: 'Quality Work',
                    value: `${refactorCount} refactors`,
                    subvalue: `${testCount} tests`
                });
            }

            document.getElementById('summary-highlights').innerHTML = highlights.length > 0
                ? highlights.map(h => `
                    <div class="p-3 bg-gray-50 rounded">
                        <p class="text-xs text-gray-500 mb-1">${h.label}</p>
                        <p class="text-sm font-semibold text-gray-900">${h.value}</p>
                        ${h.subvalue ? `<p class="text-xs text-gray-500">${h.subvalue}</p>` : ''}
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No activity in this period</p>';

            // Activity snapshot - work pattern indicators (useful for burnout detection)
            const holidayCount = currentCommits.filter(c => getWorkPattern(c).isHoliday).length;

            document.getElementById('summary-activity').innerHTML = `
                <div class="text-center p-3 bg-amber-50 rounded">
                    <p class="text-2xl font-bold text-amber-600">${afterHoursCount}</p>
                    <p class="text-xs text-gray-500">After-hours</p>
                </div>
                <div class="text-center p-3 bg-indigo-50 rounded">
                    <p class="text-2xl font-bold text-indigo-600">${weekendCount}</p>
                    <p class="text-xs text-gray-500">Weekend</p>
                </div>
                <div class="text-center p-3 bg-pink-50 rounded">
                    <p class="text-2xl font-bold text-pink-600">${holidayCount}</p>
                    <p class="text-xs text-gray-500">Holiday</p>
                </div>
                <div class="text-center p-3 bg-purple-50 rounded">
                    <p class="text-2xl font-bold text-purple-600">${complexChanges}</p>
                    <p class="text-xs text-gray-500">Complex</p>
                </div>
            `;

            // Add click handlers for summary cards
            document.querySelectorAll('[data-summary-card]').forEach(el => {
                el.addEventListener('click', () => {
                    const cardType = el.dataset.summaryCard;
                    let filteredCommits, title;

                    if (cardType === 'features') {
                        filteredCommits = currentCommits.filter(c => (c.tags || []).includes('feature'));
                        title = 'Feature Commits';
                    } else if (cardType === 'fixes') {
                        filteredCommits = currentCommits.filter(c => (c.tags || []).includes('bugfix'));
                        title = 'Bug Fix Commits';
                    } else if (cardType === 'urgency') {
                        filteredCommits = currentCommits.filter(c => c.urgency >= 4);
                        title = 'Reactive Commits (Urgency 4-5)';
                    } else if (cardType === 'planned') {
                        filteredCommits = currentCommits.filter(c => c.urgency <= 2);
                        title = 'Planned Work (Urgency 1-2)';
                    }

                    if (filteredCommits) {
                        openDetailPane(title, `${filteredCommits.length} commits in this period`, filteredCommits);
                    }
                });
            });
        }

        function setupSummaryPeriodToggle() {
            document.getElementById('summary-period').addEventListener('change', (e) => {
                summaryPeriod = e.target.value;
                renderSummary();
                saveFiltersToStorage();
            });
        }

        // === Tab Navigation (V2: 4 grouped tabs) ===
        // Map new tabs to the content containers they should show
        const TAB_MAPPING = {
            'overview': ['tab-overview'],
            'activity': ['tab-activity', 'tab-timing'],
            'work': ['tab-progress', 'tab-tags', 'tab-contributors'],
            'health': ['tab-security']
        };

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Update button styles
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('border-blue-500', 'text-blue-600');
                    b.classList.add('border-transparent', 'text-gray-500');
                });
                btn.classList.remove('border-transparent', 'text-gray-500');
                btn.classList.add('border-blue-500', 'text-blue-600');

                // Show/hide tabs based on mapping
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                const tabsToShow = TAB_MAPPING[btn.dataset.tab] || [`tab-${btn.dataset.tab}`];
                tabsToShow.forEach(tabId => {
                    const tabEl = document.getElementById(tabId);
                    if (tabEl) tabEl.classList.remove('hidden');
                });

                // Save state (only if data is loaded)
                if (data) {
                    saveFiltersToStorage();
                }
            });
        });

        // === File Input Handler ===
        document.getElementById('file-input').addEventListener('change', async (e) => {
            const files = e.target.files;
            if (!files || files.length === 0) return;

            try {
                if (files.length === 1) {
                    // Single file - load directly
                    const text = await files[0].text();
                    const jsonData = JSON.parse(text);
                    loadData(jsonData);
                } else {
                    // Multiple files - combine them
                    const allData = [];
                    for (const file of files) {
                        const text = await file.text();
                        const jsonData = JSON.parse(text);
                        allData.push(jsonData);
                    }
                    const combined = combineDataFiles(allData);
                    loadData(combined);
                }
            } catch (error) {
                alert('Error loading file(s): ' + error.message);
            }
        });

        // === Combine Multiple Data Files ===
        function combineDataFiles(dataFiles) {
            const allCommits = [];
            const allContributors = new Map();
            const allFiles = new Map();
            const repos = [];

            let totalAdditions = 0;
            let totalDeletions = 0;
            const tagBreakdown = {};
            const monthlyCommits = {};
            const allAuthors = {};

            for (const data of dataFiles) {
                const repoId = data.metadata?.repo_id || data.metadata?.repository || 'unknown';
                repos.push(repoId);

                // Merge authors from metadata
                if (data.metadata?.authors) {
                    Object.assign(allAuthors, data.metadata.authors);
                }

                // Process commits
                for (const commit of data.commits || []) {
                    const enrichedCommit = { ...commit, repo_id: commit.repo_id || repoId };
                    allCommits.push(enrichedCommit);

                    // Tag breakdown
                    const tags = getCommitTags(commit);
                    tags.forEach(tag => {
                        tagBreakdown[tag] = (tagBreakdown[tag] || 0) + 1;
                    });

                    // Monthly
                    const month = commit.timestamp?.substring(0, 7);
                    if (month) {
                        if (!monthlyCommits[month]) monthlyCommits[month] = { total: 0, tags: {} };
                        monthlyCommits[month].total++;
                        tags.forEach(tag => {
                            monthlyCommits[month].tags[tag] = (monthlyCommits[month].tags[tag] || 0) + 1;
                        });
                    }

                    totalAdditions += commit.stats?.additions || 0;
                    totalDeletions += commit.stats?.deletions || 0;
                }

                // Process contributors
                for (const contributor of data.contributors || []) {
                    const key = contributor.author_id || contributor.email?.toLowerCase();
                    if (!allContributors.has(key)) {
                        allContributors.set(key, {
                            ...contributor,
                            repos: new Set([repoId])
                        });
                    } else {
                        const existing = allContributors.get(key);
                        existing.commits += contributor.commits;
                        existing.additions += contributor.additions;
                        existing.deletions += contributor.deletions;
                        existing.repos.add(repoId);
                        for (const [type, count] of Object.entries(contributor.types || {})) {
                            existing.types[type] = (existing.types[type] || 0) + count;
                        }
                    }
                }

                // Process files
                for (const file of data.files || []) {
                    const key = `${repoId}:${file.path}`;
                    if (!allFiles.has(key)) {
                        allFiles.set(key, { ...file, repo_id: repoId });
                    }
                }
            }

            // Sort commits by timestamp
            allCommits.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Convert contributors
            const contributors = Array.from(allContributors.values())
                .map(c => ({
                    ...c,
                    repos: Array.from(c.repos),
                    repoCount: c.repos.size
                }))
                .sort((a, b) => b.commits - a.commits);

            // Get date range
            const timestamps = allCommits.map(c => c.timestamp).filter(Boolean).sort();

            return {
                metadata: {
                    repository: `Combined (${repos.length} repos)`,
                    repos,
                    authors: allAuthors
                },
                commits: allCommits,
                contributors,
                files: Array.from(allFiles.values()),
                summary: {
                    totalCommits: allCommits.length,
                    totalContributors: contributors.length,
                    totalAdditions,
                    totalDeletions,
                    netLinesChanged: totalAdditions - totalDeletions,
                    tagBreakdown,
                    monthlyCommits,
                    dateRange: {
                        earliest: timestamps[0] || null,
                        latest: timestamps[timestamps.length - 1] || null
                    }
                }
            };
        }

        // === Auto-load data.json if present ===
        function showLoading(show) {
            const content = document.getElementById('loader-content');
            const spinner = document.getElementById('loader-spinner');
            if (show) {
                content.classList.add('hidden');
                spinner.classList.remove('hidden');
            } else {
                content.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }

        async function tryAutoLoad() {
            showLoading(true);
            try {
                // Try to load from same directory
                const response = await fetch('data.json');
                if (response.ok) {
                    const jsonData = await response.json();
                    loadData(jsonData);
                    return;
                }
            } catch (e) {
                // Try reports folder
                try {
                    const response = await fetch('../reports/repo-tor/data.json');
                    if (response.ok) {
                        const jsonData = await response.json();
                        loadData(jsonData);
                        return;
                    }
                } catch (e2) {
                    // No auto-load available
                }
            }
            // No data found, show file picker
            showLoading(false);
        }

        // === Utilities ===
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // === Toast Notification ===
        function showToast(message, duration = 3000) {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            // Trigger animation
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // === URL State Management (Shareable Links) ===
        function getStateFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return {
                tag: params.get('tag') || '',
                author: params.get('author') || '',
                repo: params.get('repo') || '',
                dateFrom: params.get('from') || '',
                dateTo: params.get('to') || '',
                tab: params.get('tab') || 'overview',
                period: params.get('period') || '7days',
                tz: params.get('tz') || 'local'
            };
        }

        function buildShareableUrl() {
            const url = new URL(window.location.href.split('?')[0]);
            const params = new URLSearchParams();

            // Add current tab
            const activeTab = document.querySelector('.tab-btn.border-blue-500')?.dataset.tab || 'summary';
            if (activeTab !== 'summary') params.set('tab', activeTab);

            // Add filters (only if set)
            if (filters.tag) params.set('tag', filters.tag);
            if (filters.author) params.set('author', filters.author);
            if (filters.repo) params.set('repo', filters.repo);
            if (filters.dateFrom) params.set('from', filters.dateFrom);
            if (filters.dateTo) params.set('to', filters.dateTo);

            // Add summary period if on overview tab
            if (activeTab === 'overview' && summaryPeriod !== '7days') {
                params.set('period', summaryPeriod);
            }

            // Add timezone if on activity tab (which includes timing) and not local
            if (activeTab === 'activity' && useUTC) {
                params.set('tz', 'utc');
            }

            const paramStr = params.toString();
            return paramStr ? `${url}?${paramStr}` : url.toString();
        }

        function applyUrlState() {
            const state = getStateFromUrl();

            // Apply filters
            filters.tag = state.tag;
            filters.author = state.author;
            filters.repo = state.repo;
            filters.dateFrom = state.dateFrom;
            filters.dateTo = state.dateTo;

            // Update filter UI
            document.getElementById('filter-tag').value = state.tag;
            document.getElementById('filter-author').value = state.author;
            document.getElementById('filter-repo').value = state.repo;
            document.getElementById('filter-date-from').value = state.dateFrom;
            document.getElementById('filter-date-to').value = state.dateTo;

            // Apply summary period
            if (state.period) {
                summaryPeriod = state.period;
                document.getElementById('summary-period').value = state.period;
            }

            // Apply timezone
            if (state.tz === 'utc') {
                useUTC = true;
                document.getElementById('timezone-select').value = 'utc';
            }

            // Switch to specified tab
            if (state.tab) {
                const tabBtn = document.querySelector(`.tab-btn[data-tab="${state.tab}"]`);
                if (tabBtn) tabBtn.click();
            }
        }

        function copyShareableLink() {
            const url = buildShareableUrl();
            navigator.clipboard.writeText(url).then(() => {
                showToast('Link copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const input = document.createElement('input');
                input.value = url;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                showToast('Link copied to clipboard!');
            });
        }

        // === PDF Export ===
        async function exportToPdf() {
            const exportBtn = document.getElementById('btn-export-pdf');
            const originalText = exportBtn.innerHTML;
            exportBtn.innerHTML = `
                <svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
                <span class="hidden sm:inline">Generating...</span>
            `;
            exportBtn.disabled = true;

            try {
                // Get current active tab
                const activeTab = document.querySelector('.tab-btn.border-blue-500')?.dataset.tab || 'summary';
                const tabContent = document.getElementById(`tab-${activeTab}`);

                // Create a container for PDF content
                const pdfContent = document.createElement('div');
                pdfContent.style.cssText = 'background: white; padding: 20px; max-width: 1000px;';

                // Add header
                const header = document.createElement('div');
                header.innerHTML = `
                    <h1 style="font-size: 24px; font-weight: bold; color: #111827; margin-bottom: 8px;">
                        ${document.getElementById('repo-name').textContent}
                    </h1>
                    <p style="color: #6b7280; font-size: 14px; margin-bottom: 16px;">
                        ${document.getElementById('repo-subtitle').textContent}
                    </p>
                    <p style="color: #9ca3af; font-size: 12px; margin-bottom: 24px;">
                        Generated: ${new Date().toLocaleString()} | Tab: ${activeTab.charAt(0).toUpperCase() + activeTab.slice(1)}
                        ${hasActiveFilters() ? ' | Filtered view' : ''}
                    </p>
                `;
                pdfContent.appendChild(header);

                // Add summary stats
                const stats = document.createElement('div');
                stats.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            <p style="color: #6b7280; font-size: 12px; text-transform: uppercase;">Files Changed</p>
                            <p style="font-size: 24px; font-weight: bold;">${document.getElementById('stat-files').textContent}</p>
                        </div>
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            <p style="color: #6b7280; font-size: 12px; text-transform: uppercase;">Avg Complexity</p>
                            <p style="font-size: 24px; font-weight: bold;">${document.getElementById('stat-complexity').textContent}</p>
                        </div>
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            <p style="color: #6b7280; font-size: 12px; text-transform: uppercase;">Top Work Type</p>
                            <p style="font-size: 24px; font-weight: bold;">${document.getElementById('stat-top-tag').textContent}</p>
                        </div>
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            <p style="color: #6b7280; font-size: 12px; text-transform: uppercase;">Contributors</p>
                            <p style="font-size: 24px; font-weight: bold;">${document.getElementById('stat-contributors').textContent}</p>
                        </div>
                    </div>
                `;
                pdfContent.appendChild(stats);

                // Clone the current tab content
                const contentClone = tabContent.cloneNode(true);
                contentClone.classList.remove('hidden');
                // Remove any interactive elements
                contentClone.querySelectorAll('select, button, input').forEach(el => {
                    if (el.tagName === 'SELECT') {
                        const span = document.createElement('span');
                        span.textContent = el.options[el.selectedIndex]?.text || '';
                        span.style.cssText = 'font-weight: 500;';
                        el.replaceWith(span);
                    } else if (el.tagName === 'BUTTON') {
                        el.remove();
                    }
                });
                pdfContent.appendChild(contentClone);

                // Temporarily add to DOM for rendering
                pdfContent.style.position = 'absolute';
                pdfContent.style.left = '-9999px';
                document.body.appendChild(pdfContent);

                // Generate PDF
                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: `git-analytics-${activeTab}-${new Date().toISOString().split('T')[0]}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        logging: false
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: 'a4',
                        orientation: 'landscape'
                    }
                };

                await html2pdf().set(opt).from(pdfContent).save();

                // Cleanup
                document.body.removeChild(pdfContent);
                showToast('PDF exported successfully!');
            } catch (error) {
                console.error('PDF export error:', error);
                showToast('Export failed. Please try again.');
            } finally {
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
            }
        }

        function hasActiveFilters() {
            return filters.tag || filters.author || filters.repo || filters.dateFrom || filters.dateTo;
        }

        // Setup export/share button handlers
        function setupExportButtons() {
            document.getElementById('export-buttons').classList.remove('hidden');
            document.getElementById('btn-share').addEventListener('click', copyShareableLink);
            document.getElementById('btn-export-pdf').addEventListener('click', exportToPdf);
            document.getElementById('btn-theme').addEventListener('click', toggleDarkMode);
            document.getElementById('btn-sanitize').addEventListener('click', toggleSanitizeMode);
        }

        // Initialize
        initDarkMode();
        initSanitizeMode();
        initDetailPane();
        tryAutoLoad();
    </script>
</body>
</html>
