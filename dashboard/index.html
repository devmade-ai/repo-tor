<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Git Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Tag classes */
        .tag-feature { background-color: #10b981; color: white; }
        .tag-bugfix { background-color: #ef4444; color: white; }
        .tag-refactor { background-color: #8b5cf6; color: white; }
        .tag-docs { background-color: #3b82f6; color: white; }
        .tag-test { background-color: #f59e0b; color: white; }
        .tag-config { background-color: #64748b; color: white; }
        .tag-style { background-color: #ec4899; color: white; }
        .tag-cleanup { background-color: #6b7280; color: white; }
        .tag-security { background-color: #dc2626; color: white; }
        .tag-performance { background-color: #06b6d4; color: white; }
        .tag-dependency { background-color: #84cc16; color: white; }
        .tag-other { background-color: #9ca3af; color: white; }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .timeline-dot:hover {
            transform: scale(1.5);
        }

        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            padding: 1.5rem;
        }

        .tag {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .tag-security { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .tag-breaking { background-color: #fef3c7; color: #d97706; border: 1px solid #fde68a; }
        .tag-dependency { background-color: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }

        .filter-select {
            padding: 0.375rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background-color: white;
            min-width: 120px;
        }
        .filter-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .filter-input {
            padding: 0.375rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        .filter-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* Hide scrollbar for mobile tabs */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* Work pattern badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.625rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        .badge-after-hours {
            background-color: #fef3c7;
            color: #92400e;
        }
        .badge-weekend {
            background-color: #e0e7ff;
            color: #3730a3;
        }
        .badge-holiday {
            background-color: #fce7f3;
            color: #9d174d;
        }

        /* Export/Share buttons */
        .btn-icon {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        .btn-secondary:hover {
            background-color: #f9fafb;
        }
        .btn-icon svg {
            width: 1rem;
            height: 1rem;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background-color: #1f2937;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            z-index: 1000;
            opacity: 0;
            transform: translateY(1rem);
            transition: all 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Print styles for PDF */
        @media print {
            body { background: white !important; }
            .no-print { display: none !important; }
            .card { box-shadow: none !important; border: 1px solid #e5e7eb; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900" id="repo-name">Git Analytics Dashboard</h1>
                    <p class="text-gray-500 mt-1" id="repo-subtitle">Loading data...</p>
                </div>
                <div id="export-buttons" class="hidden flex gap-2 no-print">
                    <button id="btn-share" class="btn-icon btn-secondary" title="Copy shareable link">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
                        </svg>
                        <span class="hidden sm:inline">Share</span>
                    </button>
                    <button id="btn-export-pdf" class="btn-icon btn-primary" title="Export as PDF">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        <span class="hidden sm:inline">Export PDF</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Data Loader -->
        <div id="loader" class="card text-center py-12">
            <p class="text-gray-500">Select data file(s) to load:</p>
            <input type="file" id="file-input" accept=".json" multiple class="mt-4 text-sm">
            <p class="text-sm text-gray-400 mt-2">Select multiple files to combine data from different repositories</p>
            <p class="text-sm text-gray-400 mt-1">Or place your data.json in the same directory as this file</p>
        </div>

        <!-- Dashboard Content (hidden until data loads) -->
        <div id="dashboard" class="hidden">
            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="card">
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Files Changed</p>
                    <p class="text-3xl font-bold text-gray-900" id="stat-files">0</p>
                    <p class="text-xs text-gray-400" id="stat-files-sub"></p>
                </div>
                <div class="card">
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Avg Complexity</p>
                    <p class="text-3xl font-bold text-gray-900" id="stat-complexity">-</p>
                    <p class="text-xs text-gray-400" id="stat-complexity-sub"></p>
                </div>
                <div class="card">
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Top Work Type</p>
                    <p class="text-2xl font-bold text-gray-900" id="stat-top-tag">-</p>
                    <p class="text-xs text-gray-400" id="stat-top-tag-sub"></p>
                </div>
                <div class="card">
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Contributors</p>
                    <p class="text-3xl font-bold text-gray-900" id="stat-contributors">0</p>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="flex border-b border-gray-200 mb-6 overflow-x-auto -mx-4 px-4 md:mx-0 md:px-0 scrollbar-hide">
                <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600 whitespace-nowrap" data-tab="summary">Summary</button>
                <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="timeline">Timeline</button>
                <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="progress">Progress</button>
                <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="contributors">Contributors</button>
                <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="security">Security</button>
                <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="tags">By Tag</button>
                <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="timing">Timing</button>
            </div>

            <!-- Tab Content -->
            <div id="tab-summary" class="tab-content">
                <!-- Period Selector -->
                <div class="card mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold">Executive Summary</h2>
                            <p class="text-xs text-gray-500">High-level overview for quick scanning</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-gray-500">Compare:</label>
                            <select id="summary-period" class="filter-select text-sm">
                                <option value="week">This Week vs Last Week</option>
                                <option value="month">This Month vs Last Month</option>
                                <option value="quarter">This Quarter vs Last Quarter</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats with Trends -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="card">
                        <p class="text-sm text-gray-500 uppercase tracking-wide">Features Built</p>
                        <p class="text-3xl font-bold text-green-600" id="summary-features">0</p>
                        <p class="text-sm mt-1" id="summary-features-trend"></p>
                    </div>
                    <div class="card">
                        <p class="text-sm text-gray-500 uppercase tracking-wide">Bugs Fixed</p>
                        <p class="text-3xl font-bold text-amber-600" id="summary-fixes">0</p>
                        <p class="text-sm mt-1" id="summary-fixes-trend"></p>
                    </div>
                    <div class="card">
                        <p class="text-sm text-gray-500 uppercase tracking-wide">Avg Complexity</p>
                        <p class="text-3xl font-bold text-gray-900" id="summary-complexity">-</p>
                        <p class="text-sm mt-1" id="summary-complexity-trend"></p>
                    </div>
                    <div class="card">
                        <p class="text-sm text-gray-500 uppercase tracking-wide">Files Touched</p>
                        <p class="text-3xl font-bold text-gray-900" id="summary-files">0</p>
                        <p class="text-sm mt-1" id="summary-files-trend"></p>
                    </div>
                </div>

                <!-- Work Breakdown and Highlights -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4">Work Breakdown</h3>
                        <div class="h-48">
                            <canvas id="summary-breakdown-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4">Key Highlights</h3>
                        <div id="summary-highlights" class="space-y-3"></div>
                    </div>
                </div>

                <!-- Activity Snapshot -->
                <div class="card">
                    <h3 class="text-lg font-semibold mb-4">Activity Snapshot</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="summary-activity">
                    </div>
                </div>
            </div>

            <div id="tab-timeline" class="tab-content hidden">
                <!-- Filters -->
                <div class="card mb-6">
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:flex lg:flex-wrap items-end gap-3 lg:gap-4">
                        <div class="flex flex-col gap-1">
                            <label class="text-xs text-gray-500">Tag</label>
                            <select id="filter-tag" class="filter-select w-full">
                                <option value="">All Tags</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-xs text-gray-500">Author</label>
                            <select id="filter-author" class="filter-select w-full">
                                <option value="">All Authors</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1" id="repo-filter-container" style="display: none;">
                            <label class="text-xs text-gray-500">Repo</label>
                            <select id="filter-repo" class="filter-select w-full">
                                <option value="">All Repos</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-xs text-gray-500">From</label>
                            <input type="date" id="filter-date-from" class="filter-input w-full">
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-xs text-gray-500">To</label>
                            <input type="date" id="filter-date-to" class="filter-input w-full">
                        </div>
                        <button id="clear-filters" class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded border border-gray-200 col-span-2 sm:col-span-1">
                            Clear Filters
                        </button>
                    </div>
                    <!-- Work Pattern Legend -->
                    <div class="mt-3 pt-3 border-t border-gray-100 flex flex-wrap items-center gap-3 text-xs text-gray-500">
                        <span>Work patterns:</span>
                        <span class="badge badge-after-hours">After Hours</span>
                        <span class="text-gray-400">before 8am or after 5pm</span>
                        <span class="badge badge-weekend">Weekend</span>
                        <span class="text-gray-400">Sat/Sun</span>
                        <span class="badge badge-holiday">Holiday</span>
                        <span class="text-gray-400">SA public holidays</span>
                    </div>
                </div>

                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold">Changes</h2>
                        <span id="commit-count" class="text-sm text-gray-500"></span>
                    </div>
                    <div id="commit-list" class="space-y-3 max-h-[600px] overflow-y-auto"></div>
                </div>
            </div>

            <div id="tab-progress" class="tab-content hidden">
                <div class="card mb-6">
                    <h2 class="text-lg font-semibold mb-4">Work Type Trend</h2>
                    <p class="text-xs text-gray-500 -mt-2 mb-4">Features vs bug fixes over time</p>
                    <div class="h-64">
                        <canvas id="feat-fix-chart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-lg font-semibold mb-4">Complexity Over Time</h2>
                    <p class="text-xs text-gray-500 -mt-2 mb-4">Average complexity by month</p>
                    <div class="h-64">
                        <canvas id="complexity-trend-chart"></canvas>
                    </div>
                </div>
            </div>

            <div id="tab-contributors" class="tab-content hidden">
                <div class="card mb-6">
                    <h2 class="text-lg font-semibold mb-4">Who Does What</h2>
                    <p class="text-xs text-gray-500 -mt-2 mb-4">Work type distribution by contributor</p>
                    <div id="contributor-work-types" class="space-y-4"></div>
                </div>
                <div class="card">
                    <h2 class="text-lg font-semibold mb-4">Complexity by Contributor</h2>
                    <p class="text-xs text-gray-500 -mt-2 mb-4">Who handles complex vs simple changes</p>
                    <div class="h-64">
                        <canvas id="contributor-complexity-chart"></canvas>
                    </div>
                </div>
            </div>

            <div id="tab-security" class="tab-content hidden">
                <div class="card mb-6">
                    <h2 class="text-lg font-semibold mb-4">Security-Related Commits</h2>
                    <p class="text-sm text-gray-500 mb-4">Commits tagged with security, or containing security-related keywords</p>
                    <div id="security-count" class="text-4xl font-bold text-red-600 mb-4">0</div>
                    <div id="security-list" class="space-y-3"></div>
                </div>
            </div>

            <div id="tab-tags" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <h2 class="text-lg font-semibold mb-4">Commits by Tag</h2>
                        <p class="text-xs text-gray-500 -mt-2 mb-4">A commit can have multiple tags</p>
                        <div class="h-64">
                            <canvas id="tags-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-lg font-semibold mb-4">Tag Breakdown</h2>
                        <p class="text-xs text-gray-500 -mt-2 mb-4">Tag occurrences (total may exceed commit count)</p>
                        <div id="tag-breakdown" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <div id="tab-timing" class="tab-content hidden">
                <div class="card mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-lg font-semibold">When Work Happens</h2>
                            <p class="text-xs text-gray-500">Commit distribution by time of day and day of week</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-gray-500">Timezone:</label>
                            <select id="timezone-select" class="filter-select text-sm">
                                <option value="local">Local</option>
                                <option value="utc">UTC</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <h2 class="text-lg font-semibold mb-4">Commits by Hour of Day</h2>
                        <p class="text-xs text-gray-500 -mt-2 mb-4">Distribution across 24 hours (0-23)</p>
                        <div class="h-64">
                            <canvas id="hour-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-lg font-semibold mb-4">Commits by Day of Week</h2>
                        <p class="text-xs text-gray-500 -mt-2 mb-4">Distribution across weekdays</p>
                        <div class="h-64">
                            <canvas id="day-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === Global State ===
        let data = null;
        let charts = {};
        let filters = {
            tag: '',
            author: '',
            repo: '',
            dateFrom: '',
            dateTo: ''
        };
        let useUTC = false;

        // === South African Public Holidays ===
        // Format: 'YYYY-MM-DD' for fixed dates, calculated for moveable feasts
        const SA_HOLIDAYS = {
            // Fixed holidays (apply every year)
            fixed: [
                { month: 1, day: 1, name: "New Year's Day" },
                { month: 3, day: 21, name: "Human Rights Day" },
                { month: 4, day: 27, name: "Freedom Day" },
                { month: 5, day: 1, name: "Workers' Day" },
                { month: 6, day: 16, name: "Youth Day" },
                { month: 8, day: 9, name: "National Women's Day" },
                { month: 9, day: 24, name: "Heritage Day" },
                { month: 12, day: 16, name: "Day of Reconciliation" },
                { month: 12, day: 25, name: "Christmas Day" },
                { month: 12, day: 26, name: "Day of Goodwill" }
            ],
            // Easter-based holidays (Good Friday, Family Day) - pre-calculated for 2024-2027
            easter: {
                2024: { goodFriday: '2024-03-29', familyDay: '2024-04-01' },
                2025: { goodFriday: '2025-04-18', familyDay: '2025-04-21' },
                2026: { goodFriday: '2026-04-03', familyDay: '2026-04-06' },
                2027: { goodFriday: '2027-03-26', familyDay: '2027-03-29' }
            }
        };

        // Build holiday lookup set for quick checking
        function buildHolidaySet() {
            const holidays = new Set();
            // Add fixed holidays for years 2020-2030
            for (let year = 2020; year <= 2030; year++) {
                SA_HOLIDAYS.fixed.forEach(h => {
                    const dateStr = `${year}-${String(h.month).padStart(2, '0')}-${String(h.day).padStart(2, '0')}`;
                    holidays.add(dateStr);
                    // If holiday falls on Sunday, Monday is observed
                    const date = new Date(year, h.month - 1, h.day);
                    if (date.getDay() === 0) {
                        const monday = new Date(date);
                        monday.setDate(monday.getDate() + 1);
                        holidays.add(monday.toISOString().substring(0, 10));
                    }
                });
            }
            // Add Easter-based holidays
            Object.values(SA_HOLIDAYS.easter).forEach(e => {
                holidays.add(e.goodFriday);
                holidays.add(e.familyDay);
            });
            return holidays;
        }
        const holidaySet = buildHolidaySet();

        // === Work Pattern Helpers ===
        function getWorkPattern(commit) {
            const date = new Date(commit.timestamp);
            const hour = useUTC ? date.getUTCHours() : date.getHours();
            const dayOfWeek = useUTC ? date.getUTCDay() : date.getDay();
            const dateStr = commit.timestamp.substring(0, 10);

            return {
                isAfterHours: hour < 8 || hour >= 17,
                isWeekend: dayOfWeek === 0 || dayOfWeek === 6,
                isHoliday: holidaySet.has(dateStr),
                hour,
                dayOfWeek,
                dateStr
            };
        }

        function getWorkPatternBadges(commit) {
            const pattern = getWorkPattern(commit);
            const badges = [];

            if (pattern.isHoliday) {
                badges.push('<span class="badge badge-holiday">Holiday</span>');
            }
            if (pattern.isWeekend) {
                badges.push('<span class="badge badge-weekend">Weekend</span>');
            } else if (pattern.isAfterHours) {
                badges.push('<span class="badge badge-after-hours">After Hours</span>');
            }

            return badges.join(' ');
        }

        // === Tag Colors ===
        const TAG_COLORS = {
            feature: '#10b981',
            bugfix: '#ef4444',
            refactor: '#8b5cf6',
            docs: '#3b82f6',
            test: '#f59e0b',
            config: '#64748b',
            style: '#ec4899',
            cleanup: '#6b7280',
            security: '#dc2626',
            performance: '#06b6d4',
            dependency: '#84cc16',
            other: '#9ca3af'
        };

        // === Tag Helper Functions ===
        function getCommitTags(commit) {
            if (commit.tags && commit.tags.length > 0) {
                return commit.tags;
            }
            return ['other'];
        }

        function getAllTags(commits) {
            const tagSet = new Set();
            commits.forEach(c => {
                getCommitTags(c).forEach(tag => tagSet.add(tag));
            });
            return [...tagSet].sort();
        }

        function getTagColor(tag) {
            return TAG_COLORS[tag] || TAG_COLORS.other;
        }

        function getTagClass(tag) {
            return TAG_COLORS[tag] ? `tag-${tag}` : 'tag-other';
        }

        // === Author Resolution ===
        function getAuthorName(commit) {
            // Try to resolve from metadata.authors using author_id
            if (commit.author_id && data.metadata?.authors?.[commit.author_id]) {
                return data.metadata.authors[commit.author_id].name;
            }
            // Fall back to embedded author object
            return commit.author?.name || commit.author_id || 'Unknown';
        }

        function getAuthorEmail(commit) {
            // Try to resolve from metadata.authors using author_id
            if (commit.author_id && data.metadata?.authors?.[commit.author_id]) {
                return data.metadata.authors[commit.author_id].email;
            }
            // Fall back to embedded author object or author_id
            return commit.author?.email || commit.author_id || 'unknown';
        }

        // === Summary Stats ===
        function updateSummaryStats() {
            // Files changed - count unique files across all commits
            const allFiles = new Set();
            data.commits.forEach(c => {
                if (c.files) {
                    c.files.forEach(f => allFiles.add(f.path || f));
                }
            });
            const totalFiles = data.files?.length || allFiles.size || 0;
            document.getElementById('stat-files').textContent = totalFiles.toLocaleString();
            document.getElementById('stat-files-sub').textContent = `across ${data.summary.totalCommits} changes`;

            // Average complexity
            const complexities = data.commits.map(c => c.complexity).filter(c => c != null);
            if (complexities.length > 0) {
                const avgComplexity = (complexities.reduce((a, b) => a + b, 0) / complexities.length).toFixed(1);
                document.getElementById('stat-complexity').textContent = avgComplexity;
                // Complexity distribution
                const high = complexities.filter(c => c >= 4).length;
                const low = complexities.filter(c => c <= 2).length;
                document.getElementById('stat-complexity-sub').textContent = `${high} complex, ${low} simple`;
            } else {
                document.getElementById('stat-complexity').textContent = '-';
                document.getElementById('stat-complexity-sub').textContent = 'not available';
            }

            // Top work type (most common tag)
            const tagCounts = {};
            data.commits.forEach(c => {
                getCommitTags(c).forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });
            const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);
            if (sortedTags.length > 0) {
                const [topTag, topCount] = sortedTags[0];
                const pct = Math.round((topCount / data.commits.length) * 100);
                document.getElementById('stat-top-tag').textContent = topTag;
                document.getElementById('stat-top-tag-sub').textContent = `${pct}% of changes`;
            }

            // Contributors
            document.getElementById('stat-contributors').textContent = data.summary.totalContributors;
        }

        // === Filter Functions ===
        function getFilteredCommits() {
            if (!data || !data.commits) return [];

            return data.commits.filter(commit => {
                // Tag filter - check if any of commit's tags match
                if (filters.tag) {
                    const commitTags = getCommitTags(commit);
                    if (!commitTags.includes(filters.tag)) return false;
                }

                // Author filter - check both author_id and author.email
                if (filters.author) {
                    const authorEmail = getAuthorEmail(commit);
                    if (authorEmail !== filters.author) return false;
                }

                // Repo filter
                if (filters.repo && commit.repo_id !== filters.repo) return false;

                // Date range filter
                if (filters.dateFrom) {
                    const commitDate = commit.timestamp?.substring(0, 10);
                    if (commitDate < filters.dateFrom) return false;
                }
                if (filters.dateTo) {
                    const commitDate = commit.timestamp?.substring(0, 10);
                    if (commitDate > filters.dateTo) return false;
                }

                return true;
            });
        }

        function populateFilters() {
            // Tag filter
            const tagSelect = document.getElementById('filter-tag');
            const tags = getAllTags(data.commits);
            tagSelect.innerHTML = '<option value="">All Tags</option>' +
                tags.map(t => `<option value="${t}">${t}</option>`).join('');

            // Author filter - use author resolution
            const authorSelect = document.getElementById('filter-author');
            const authorMap = {};
            data.commits.forEach(c => {
                const email = getAuthorEmail(c);
                const name = getAuthorName(c);
                if (email && !authorMap[email]) {
                    authorMap[email] = name;
                }
            });
            const authors = Object.keys(authorMap).sort();
            authorSelect.innerHTML = '<option value="">All Authors</option>' +
                authors.map(email => `<option value="${email}">${escapeHtml(authorMap[email] || email)}</option>`).join('');

            // Repo filter (only show if aggregated data)
            const repos = [...new Set(data.commits.map(c => c.repo_id).filter(Boolean))];
            const repoContainer = document.getElementById('repo-filter-container');
            if (repos.length > 1) {
                repoContainer.style.display = 'flex';
                const repoSelect = document.getElementById('filter-repo');
                repoSelect.innerHTML = '<option value="">All Repos</option>' +
                    repos.sort().map(r => `<option value="${r}">${r}</option>`).join('');
            } else {
                repoContainer.style.display = 'none';
            }

            // Date range defaults
            if (data.summary?.dateRange) {
                const fromInput = document.getElementById('filter-date-from');
                const toInput = document.getElementById('filter-date-to');
                if (data.summary.dateRange.earliest) {
                    fromInput.min = data.summary.dateRange.earliest.substring(0, 10);
                }
                if (data.summary.dateRange.latest) {
                    toInput.max = data.summary.dateRange.latest.substring(0, 10);
                }
            }
        }

        function setupFilterListeners() {
            document.getElementById('filter-tag').addEventListener('change', (e) => {
                filters.tag = e.target.value;
                applyFilters();
            });

            document.getElementById('filter-author').addEventListener('change', (e) => {
                filters.author = e.target.value;
                applyFilters();
            });

            document.getElementById('filter-repo').addEventListener('change', (e) => {
                filters.repo = e.target.value;
                applyFilters();
            });

            document.getElementById('filter-date-from').addEventListener('change', (e) => {
                filters.dateFrom = e.target.value;
                applyFilters();
            });

            document.getElementById('filter-date-to').addEventListener('change', (e) => {
                filters.dateTo = e.target.value;
                applyFilters();
            });

            document.getElementById('clear-filters').addEventListener('click', () => {
                filters = { tag: '', author: '', repo: '', dateFrom: '', dateTo: '' };
                document.getElementById('filter-tag').value = '';
                document.getElementById('filter-author').value = '';
                document.getElementById('filter-repo').value = '';
                document.getElementById('filter-date-from').value = '';
                document.getElementById('filter-date-to').value = '';
                applyFilters();
            });
        }

        function applyFilters() {
            renderTimeline();
            updateFilteredStats();
        }

        function updateFilteredStats() {
            const filtered = getFilteredCommits();
            const total = data.commits.length;
            const filteredEl = document.getElementById('stat-commits-filtered');

            if (filtered.length !== total) {
                filteredEl.textContent = `(${filtered.length} shown)`;
            } else {
                filteredEl.textContent = '';
            }
        }

        // === Data Loading ===
        async function loadData(jsonData) {
            data = jsonData;
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');

            // Update header
            document.getElementById('repo-name').textContent = data.metadata.repository;
            document.getElementById('repo-subtitle').textContent =
                `${data.summary.totalCommits} commits from ${data.summary.totalContributors} contributors | ` +
                `${formatDate(data.summary.dateRange.earliest)} - ${formatDate(data.summary.dateRange.latest)}`;

            // Update stats - focus on meaningful metrics
            updateSummaryStats();

            // Populate and setup filters
            populateFilters();
            setupFilterListeners();

            // Setup export/share buttons
            setupExportButtons();

            // Apply URL state (filters, tab, etc.) if present
            applyUrlState();

            // Render all views
            renderSummary();
            renderTimeline();
            renderProgress();
            renderContributors();
            renderSecurity();
            renderTags();
            renderTiming();
            setupSummaryPeriodToggle();
            setupTimezoneToggle();

            // Apply filters from URL after render
            if (hasActiveFilters()) {
                applyFilters();
            }
        }

        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            return new Date(isoString).toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric'
            });
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // === Timeline Tab ===
        function renderTimeline() {
            const filteredCommits = getFilteredCommits();

            // Update count
            document.getElementById('commit-count').textContent =
                `Showing ${Math.min(filteredCommits.length, 100)} of ${filteredCommits.length}`;

            // Commit List - show tags, complexity, work patterns (no +/- lines)
            const listHtml = filteredCommits.slice(0, 100).map(commit => {
                const tags = getCommitTags(commit);
                const tagBadges = tags.slice(0, 3).map(t =>
                    `<span class="tag ${getTagClass(t)} shrink-0">${t}</span>`
                ).join(' ');
                const extraTags = tags.length > 3 ? `<span class="tag tag-other shrink-0">+${tags.length - 3}</span>` : '';
                const workPatternBadges = getWorkPatternBadges(commit);
                const complexityBadge = commit.complexity != null
                    ? `<span class="text-xs px-1.5 py-0.5 rounded ${commit.complexity >= 4 ? 'bg-purple-100 text-purple-700' : commit.complexity >= 2 ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'}">${commit.complexity}/5</span>`
                    : '';

                return `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-start gap-2 sm:gap-3">
                        <div class="flex flex-wrap gap-1 shrink-0">
                            ${tagBadges}${extraTags}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 break-words sm:truncate">${escapeHtml(commit.subject)}</p>
                        </div>
                        ${complexityBadge}
                    </div>
                    <div class="mt-1 flex flex-wrap items-center gap-x-2 gap-y-1 text-xs text-gray-500">
                        <span>${escapeHtml(getAuthorName(commit))}</span>
                        <span>·</span>
                        <span>${formatDate(commit.timestamp)}</span>
                        ${commit.repo_id ? `<span class="text-gray-400">· ${commit.repo_id}</span>` : ''}
                        ${workPatternBadges ? `<span class="ml-1">${workPatternBadges}</span>` : ''}
                    </div>
                </div>
            `}).join('');
            document.getElementById('commit-list').innerHTML = listHtml || '<p class="text-gray-500">No changes match the current filters</p>';
        }

        // === Progress Tab ===
        function renderProgress() {
            const months = Object.keys(data.summary.monthlyCommits).sort();

            // Feature vs Bug Fix Trend
            const monthlyTagCounts = {};
            const monthlyComplexity = {};
            data.commits.forEach(commit => {
                const month = commit.timestamp?.substring(0, 7);
                if (!month) return;
                if (!monthlyTagCounts[month]) monthlyTagCounts[month] = { feature: 0, bugfix: 0 };
                if (!monthlyComplexity[month]) monthlyComplexity[month] = { total: 0, count: 0 };
                const tags = getCommitTags(commit);
                if (tags.includes('feature')) monthlyTagCounts[month].feature++;
                if (tags.includes('bugfix')) monthlyTagCounts[month].bugfix++;
                if (commit.complexity != null) {
                    monthlyComplexity[month].total += commit.complexity;
                    monthlyComplexity[month].count++;
                }
            });
            const featData = months.map(m => monthlyTagCounts[m]?.feature || 0);
            const fixData = months.map(m => monthlyTagCounts[m]?.bugfix || 0);

            if (charts.featFix) charts.featFix.destroy();
            charts.featFix = new Chart(document.getElementById('feat-fix-chart'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Features',
                            data: featData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Bug Fixes',
                            data: fixData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Complexity Over Time
            const complexityData = months.map(m => {
                const mc = monthlyComplexity[m];
                return mc && mc.count > 0 ? (mc.total / mc.count) : null;
            });

            if (charts.complexityTrend) charts.complexityTrend.destroy();
            charts.complexityTrend = new Chart(document.getElementById('complexity-trend-chart'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Avg Complexity',
                        data: complexityData,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            min: 1,
                            max: 5,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        // === Contributors Tab ===
        function renderContributors() {
            // Build per-contributor stats from commits
            const contributorStats = {};
            data.commits.forEach(commit => {
                const email = getAuthorEmail(commit);
                const name = getAuthorName(commit);
                if (!contributorStats[email]) {
                    contributorStats[email] = {
                        name,
                        email,
                        tags: {},
                        complexities: []
                    };
                }
                getCommitTags(commit).forEach(tag => {
                    contributorStats[email].tags[tag] = (contributorStats[email].tags[tag] || 0) + 1;
                });
                if (commit.complexity != null) {
                    contributorStats[email].complexities.push(commit.complexity);
                }
            });

            // Sort by total changes
            const sorted = Object.values(contributorStats).sort((a, b) => {
                const aTotal = Object.values(a.tags).reduce((s, v) => s + v, 0);
                const bTotal = Object.values(b.tags).reduce((s, v) => s + v, 0);
                return bTotal - aTotal;
            });

            // Who Does What - work type breakdown per contributor
            const workTypesHtml = sorted.slice(0, 8).map(c => {
                const totalTags = Object.values(c.tags).reduce((s, v) => s + v, 0);
                const tagBars = Object.entries(c.tags)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([tag, count]) => {
                        const pct = Math.round((count / totalTags) * 100);
                        return `<div class="flex items-center gap-2">
                            <span class="tag tag-${tag} text-xs">${tag}</span>
                            <div class="flex-1 bg-gray-200 rounded-full h-2">
                                <div class="h-2 rounded-full" style="width: ${pct}%; background-color: ${getTagColor(tag)}"></div>
                            </div>
                            <span class="text-xs text-gray-500 w-8">${pct}%</span>
                        </div>`;
                    }).join('');
                return `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="font-medium text-gray-900 mb-2">${escapeHtml(c.name)}</p>
                        <div class="space-y-1">${tagBars}</div>
                    </div>
                `;
            }).join('');
            document.getElementById('contributor-work-types').innerHTML = workTypesHtml || '<p class="text-gray-500">No contributor data</p>';

            // Complexity by Contributor chart
            const top8 = sorted.slice(0, 8);
            const names = top8.map(c => c.name);
            const avgComplexities = top8.map(c => {
                if (c.complexities.length === 0) return 0;
                return c.complexities.reduce((a, b) => a + b, 0) / c.complexities.length;
            });

            if (charts.contributorComplexity) charts.contributorComplexity.destroy();
            charts.contributorComplexity = new Chart(document.getElementById('contributor-complexity-chart'), {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [{
                        label: 'Avg Complexity',
                        data: avgComplexities,
                        backgroundColor: avgComplexities.map(c => c >= 3.5 ? '#8b5cf6' : c >= 2.5 ? '#3b82f6' : '#94a3b8')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { min: 0, max: 5, ticks: { stepSize: 1 } }
                    }
                }
            });
        }

        // === Security Tab ===
        function renderSecurity() {
            // Use security_events from summary if available, otherwise compute
            let securityCommits;
            if (data.summary?.security_events?.length > 0) {
                // Map security_events back to full commits for display
                const securityShas = new Set(data.summary.security_events.map(e => e.sha));
                securityCommits = data.commits.filter(c => securityShas.has(c.sha));
            } else {
                securityCommits = data.commits.filter(c =>
                    c.type === 'security' || (c.tags || []).includes('security')
                );
            }

            document.getElementById('security-count').textContent = securityCommits.length;

            const listHtml = securityCommits.length > 0
                ? securityCommits.map(commit => `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex items-start gap-3">
                            <span class="tag tag-security">security</span>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">${escapeHtml(commit.subject)}</p>
                                <p class="text-sm text-gray-600 mt-1">${escapeHtml(commit.body || '').substring(0, 200) || 'No description'}</p>
                                <p class="text-xs text-gray-500 mt-2">
                                    ${commit.sha} by ${escapeHtml(getAuthorName(commit))} on ${formatDate(commit.timestamp)}
                                    ${commit.repo_id ? `in ${commit.repo_id}` : ''}
                                </p>
                            </div>
                        </div>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-center py-8">No security-related commits found</p>';

            document.getElementById('security-list').innerHTML = listHtml;
        }

        // === Tags Tab ===
        function renderTags() {
            // Build tag breakdown from commits (counting each tag occurrence)
            const tagBreakdown = {};
            data.commits.forEach(commit => {
                const tags = getCommitTags(commit);
                tags.forEach(tag => {
                    tagBreakdown[tag] = (tagBreakdown[tag] || 0) + 1;
                });
            });

            // Sort tags by count (descending) for consistent display
            const sortedTags = Object.entries(tagBreakdown)
                .map(([tag, count]) => ({ tag, count }))
                .sort((a, b) => b.count - a.count);

            const tags = sortedTags.map(t => t.tag);
            const counts = sortedTags.map(t => t.count);
            const colors = tags.map(t => getTagColor(t));
            const total = counts.reduce((a, b) => a + b, 0);

            // Tags Pie Chart
            if (charts.tags) charts.tags.destroy();
            charts.tags = new Chart(document.getElementById('tags-chart'), {
                type: 'doughnut',
                data: {
                    labels: tags,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });

            const breakdownHtml = sortedTags.map(({ tag, count }) => `
                <div class="flex items-center gap-3">
                    <span class="tag ${getTagClass(tag)}">${tag}</span>
                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full" style="width: ${(count / total * 100).toFixed(1)}%; background-color: ${getTagColor(tag)}"></div>
                    </div>
                    <span class="text-sm text-gray-600">${count} (${(count / total * 100).toFixed(1)}%)</span>
                </div>
            `).join('');
            document.getElementById('tag-breakdown').innerHTML = breakdownHtml;
        }

        // === Timing Tab ===
        const DAY_NAMES = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const DAY_NAMES_SHORT = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        function getCommitDateTime(commit) {
            const date = new Date(commit.timestamp);
            if (useUTC) {
                return {
                    hour: date.getUTCHours(),
                    dayOfWeek: date.getUTCDay()
                };
            }
            return {
                hour: date.getHours(),
                dayOfWeek: date.getDay()
            };
        }

        function renderTiming() {
            // Aggregate commits by hour (0-23)
            const byHour = new Array(24).fill(0);
            // Aggregate commits by day of week (0=Sun, 6=Sat)
            const byDay = new Array(7).fill(0);

            data.commits.forEach(commit => {
                const { hour, dayOfWeek } = getCommitDateTime(commit);
                byHour[hour]++;
                byDay[dayOfWeek]++;
            });

            // Hour Chart
            const hourLabels = Array.from({ length: 24 }, (_, i) =>
                i.toString().padStart(2, '0') + ':00'
            );

            if (charts.hour) charts.hour.destroy();
            charts.hour = new Chart(document.getElementById('hour-chart'), {
                type: 'bar',
                data: {
                    labels: hourLabels,
                    datasets: [{
                        label: 'Commits',
                        data: byHour,
                        backgroundColor: byHour.map((_, i) =>
                            (i >= 8 && i < 17) ? '#3b82f6' : '#94a3b8'
                        ),
                        borderRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: (ctx) => {
                                    const hour = ctx.dataIndex;
                                    if (hour >= 8 && hour < 17) return 'Work hours';
                                    return 'After hours';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                callback: function(value, index) {
                                    // Show every 3rd label to reduce clutter
                                    return index % 3 === 0 ? this.getLabelForValue(value) : '';
                                }
                            }
                        },
                        y: { beginAtZero: true }
                    }
                }
            });

            // Day of Week Chart - reorder to start with Monday
            const mondayFirstOrder = [1, 2, 3, 4, 5, 6, 0]; // Mon-Sun
            const dayLabels = mondayFirstOrder.map(i => DAY_NAMES_SHORT[i]);
            const dayData = mondayFirstOrder.map(i => byDay[i]);

            if (charts.day) charts.day.destroy();
            charts.day = new Chart(document.getElementById('day-chart'), {
                type: 'bar',
                data: {
                    labels: dayLabels,
                    datasets: [{
                        label: 'Commits',
                        data: dayData,
                        backgroundColor: dayData.map((_, i) =>
                            (i < 5) ? '#3b82f6' : '#94a3b8'  // Mon-Fri blue, Sat-Sun gray
                        ),
                        borderRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: (ctx) => {
                                    return ctx.dataIndex < 5 ? 'Weekday' : 'Weekend';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function setupTimezoneToggle() {
            document.getElementById('timezone-select').addEventListener('change', (e) => {
                useUTC = e.target.value === 'utc';
                renderTiming();
            });
        }

        // === Executive Summary Tab ===
        let summaryPeriod = 'week';

        function getPeriodDates(period) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let currentStart, currentEnd, previousStart, previousEnd;

            // Helper to set time to end of day (23:59:59.999)
            function endOfDay(date) {
                const d = new Date(date);
                d.setHours(23, 59, 59, 999);
                return d;
            }

            if (period === 'week') {
                // Get Monday of this week
                const dayOfWeek = today.getDay();
                const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                currentStart = new Date(today);
                currentStart.setDate(today.getDate() + mondayOffset);
                currentEnd = endOfDay(today);
                previousStart = new Date(currentStart);
                previousStart.setDate(previousStart.getDate() - 7);
                previousEnd = new Date(currentStart);
                previousEnd.setDate(previousEnd.getDate() - 1);
                previousEnd = endOfDay(previousEnd);
            } else if (period === 'month') {
                currentStart = new Date(today.getFullYear(), today.getMonth(), 1);
                currentEnd = endOfDay(today);
                previousStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                previousEnd = endOfDay(new Date(today.getFullYear(), today.getMonth(), 0));
            } else { // quarter
                const quarter = Math.floor(today.getMonth() / 3);
                currentStart = new Date(today.getFullYear(), quarter * 3, 1);
                currentEnd = endOfDay(today);
                previousStart = new Date(today.getFullYear(), (quarter - 1) * 3, 1);
                previousEnd = endOfDay(new Date(today.getFullYear(), quarter * 3, 0));
            }

            return {
                current: { start: currentStart, end: currentEnd },
                previous: { start: previousStart, end: previousEnd }
            };
        }

        function getCommitsInRange(commits, start, end) {
            return commits.filter(c => {
                const date = new Date(c.timestamp);
                return date >= start && date <= end;
            });
        }

        function getTrendHtml(current, previous, label) {
            if (previous === 0) {
                return current > 0
                    ? `<span class="text-green-600">+${current} new</span>`
                    : `<span class="text-gray-400">No change</span>`;
            }
            const change = current - previous;
            const pct = Math.round((change / previous) * 100);
            if (change > 0) {
                return `<span class="text-green-600">↑ ${pct}% vs ${label}</span>`;
            } else if (change < 0) {
                return `<span class="text-red-600">↓ ${Math.abs(pct)}% vs ${label}</span>`;
            }
            return `<span class="text-gray-400">No change</span>`;
        }

        function renderSummary() {
            const periods = getPeriodDates(summaryPeriod);
            const periodLabel = summaryPeriod === 'week' ? 'last week'
                : summaryPeriod === 'month' ? 'last month' : 'last quarter';

            const currentCommits = getCommitsInRange(data.commits, periods.current.start, periods.current.end);
            const previousCommits = getCommitsInRange(data.commits, periods.previous.start, periods.previous.end);

            // Count metrics for current period
            const countTag = (commits, tag) => commits.filter(c =>
                getCommitTags(c).includes(tag)
            ).length;

            const currentFeatures = countTag(currentCommits, 'feature');
            const previousFeatures = countTag(previousCommits, 'feature');
            const currentFixes = countTag(currentCommits, 'bugfix');
            const previousFixes = countTag(previousCommits, 'bugfix');

            // Complexity metrics
            const getAvgComplexity = (commits) => {
                const complexities = commits.map(c => c.complexity).filter(c => c != null);
                return complexities.length > 0
                    ? (complexities.reduce((a, b) => a + b, 0) / complexities.length)
                    : 0;
            };
            const currentComplexity = getAvgComplexity(currentCommits);
            const previousComplexity = getAvgComplexity(previousCommits);

            // Files touched
            const getFilesCount = (commits) => {
                const files = new Set();
                commits.forEach(c => {
                    if (c.files) c.files.forEach(f => files.add(f.path || f));
                });
                return files.size;
            };
            const currentFiles = getFilesCount(currentCommits);
            const previousFiles = getFilesCount(previousCommits);

            // Update stats - focus on what matters
            document.getElementById('summary-features').textContent = currentFeatures;
            document.getElementById('summary-features-trend').innerHTML = getTrendHtml(currentFeatures, previousFeatures, periodLabel);

            document.getElementById('summary-fixes').textContent = currentFixes;
            document.getElementById('summary-fixes-trend').innerHTML = getTrendHtml(currentFixes, previousFixes, periodLabel);

            document.getElementById('summary-complexity').textContent = currentComplexity > 0 ? currentComplexity.toFixed(1) : '-';
            document.getElementById('summary-complexity-trend').innerHTML = currentComplexity > 0
                ? getTrendHtml(Math.round(currentComplexity * 10), Math.round(previousComplexity * 10), periodLabel)
                : '<span class="text-gray-400">No data</span>';

            document.getElementById('summary-files').textContent = currentFiles;
            document.getElementById('summary-files-trend').innerHTML = getTrendHtml(currentFiles, previousFiles, periodLabel);

            // Work breakdown chart
            const tagCounts = {};
            currentCommits.forEach(c => {
                getCommitTags(c).forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });
            const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);

            if (charts.summaryBreakdown) charts.summaryBreakdown.destroy();
            charts.summaryBreakdown = new Chart(document.getElementById('summary-breakdown-chart'), {
                type: 'doughnut',
                data: {
                    labels: sortedTags.map(t => t[0]),
                    datasets: [{
                        data: sortedTags.map(t => t[1]),
                        backgroundColor: sortedTags.map(t => getTagColor(t[0]))
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });

            // Key highlights - focus on meaningful insights
            const highlights = [];

            // Complexity breakdown
            const complexChanges = currentCommits.filter(c => c.complexity >= 4).length;
            const simpleChanges = currentCommits.filter(c => c.complexity != null && c.complexity <= 2).length;
            if (complexChanges > 0 || simpleChanges > 0) {
                highlights.push({
                    label: 'Complex Changes',
                    value: `${complexChanges} high complexity`,
                    subvalue: `${simpleChanges} simple`
                });
            }

            // Most active repo (if aggregated)
            const repoCounts = {};
            currentCommits.forEach(c => {
                if (c.repo_id) {
                    repoCounts[c.repo_id] = (repoCounts[c.repo_id] || 0) + 1;
                }
            });
            const repos = Object.keys(repoCounts);
            if (repos.length > 1) {
                const topRepo = Object.entries(repoCounts).sort((a, b) => b[1] - a[1])[0];
                const topPct = Math.round((topRepo[1] / currentCommits.length) * 100);
                highlights.push({
                    label: 'Most Active Repo',
                    value: topRepo[0],
                    subvalue: `${topPct}% of work`
                });
            }

            // Work pattern summary
            const afterHoursCount = currentCommits.filter(c => getWorkPattern(c).isAfterHours).length;
            const weekendCount = currentCommits.filter(c => getWorkPattern(c).isWeekend).length;
            const afterHoursPct = currentCommits.length > 0
                ? Math.round((afterHoursCount / currentCommits.length) * 100)
                : 0;
            if (afterHoursPct > 0 || weekendCount > 0) {
                highlights.push({
                    label: 'Off-Hours Work',
                    value: `${afterHoursPct}% after hours`,
                    subvalue: `${weekendCount} weekend`
                });
            }

            // Refactoring ratio
            const refactorCount = currentCommits.filter(c => getCommitTags(c).includes('refactor')).length;
            const testCount = currentCommits.filter(c => getCommitTags(c).includes('test')).length;
            if (refactorCount > 0 || testCount > 0) {
                highlights.push({
                    label: 'Quality Work',
                    value: `${refactorCount} refactors`,
                    subvalue: `${testCount} tests`
                });
            }

            document.getElementById('summary-highlights').innerHTML = highlights.length > 0
                ? highlights.map(h => `
                    <div class="p-3 bg-gray-50 rounded">
                        <p class="text-xs text-gray-500 mb-1">${h.label}</p>
                        <p class="text-sm font-semibold text-gray-900">${h.value}</p>
                        ${h.subvalue ? `<p class="text-xs text-gray-500">${h.subvalue}</p>` : ''}
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No activity in this period</p>';

            // Activity snapshot - work pattern indicators (useful for burnout detection)
            const holidayCount = currentCommits.filter(c => getWorkPattern(c).isHoliday).length;

            document.getElementById('summary-activity').innerHTML = `
                <div class="text-center p-3 bg-amber-50 rounded">
                    <p class="text-2xl font-bold text-amber-600">${afterHoursCount}</p>
                    <p class="text-xs text-gray-500">After-hours</p>
                </div>
                <div class="text-center p-3 bg-indigo-50 rounded">
                    <p class="text-2xl font-bold text-indigo-600">${weekendCount}</p>
                    <p class="text-xs text-gray-500">Weekend</p>
                </div>
                <div class="text-center p-3 bg-pink-50 rounded">
                    <p class="text-2xl font-bold text-pink-600">${holidayCount}</p>
                    <p class="text-xs text-gray-500">Holiday</p>
                </div>
                <div class="text-center p-3 bg-purple-50 rounded">
                    <p class="text-2xl font-bold text-purple-600">${complexChanges}</p>
                    <p class="text-xs text-gray-500">Complex</p>
                </div>
            `;
        }

        function setupSummaryPeriodToggle() {
            document.getElementById('summary-period').addEventListener('change', (e) => {
                summaryPeriod = e.target.value;
                renderSummary();
            });
        }

        // === Tab Navigation ===
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Update button styles
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('border-blue-500', 'text-blue-600');
                    b.classList.add('border-transparent', 'text-gray-500');
                });
                btn.classList.remove('border-transparent', 'text-gray-500');
                btn.classList.add('border-blue-500', 'text-blue-600');

                // Show/hide tabs
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                document.getElementById(`tab-${btn.dataset.tab}`).classList.remove('hidden');
            });
        });

        // === File Input Handler ===
        document.getElementById('file-input').addEventListener('change', async (e) => {
            const files = e.target.files;
            if (!files || files.length === 0) return;

            try {
                if (files.length === 1) {
                    // Single file - load directly
                    const text = await files[0].text();
                    const jsonData = JSON.parse(text);
                    loadData(jsonData);
                } else {
                    // Multiple files - combine them
                    const allData = [];
                    for (const file of files) {
                        const text = await file.text();
                        const jsonData = JSON.parse(text);
                        allData.push(jsonData);
                    }
                    const combined = combineDataFiles(allData);
                    loadData(combined);
                }
            } catch (error) {
                alert('Error loading file(s): ' + error.message);
            }
        });

        // === Combine Multiple Data Files ===
        function combineDataFiles(dataFiles) {
            const allCommits = [];
            const allContributors = new Map();
            const allFiles = new Map();
            const repos = [];

            let totalAdditions = 0;
            let totalDeletions = 0;
            const tagBreakdown = {};
            const monthlyCommits = {};
            const allAuthors = {};

            for (const data of dataFiles) {
                const repoId = data.metadata?.repo_id || data.metadata?.repository || 'unknown';
                repos.push(repoId);

                // Merge authors from metadata
                if (data.metadata?.authors) {
                    Object.assign(allAuthors, data.metadata.authors);
                }

                // Process commits
                for (const commit of data.commits || []) {
                    const enrichedCommit = { ...commit, repo_id: commit.repo_id || repoId };
                    allCommits.push(enrichedCommit);

                    // Tag breakdown
                    const tags = getCommitTags(commit);
                    tags.forEach(tag => {
                        tagBreakdown[tag] = (tagBreakdown[tag] || 0) + 1;
                    });

                    // Monthly
                    const month = commit.timestamp?.substring(0, 7);
                    if (month) {
                        if (!monthlyCommits[month]) monthlyCommits[month] = { total: 0, tags: {} };
                        monthlyCommits[month].total++;
                        tags.forEach(tag => {
                            monthlyCommits[month].tags[tag] = (monthlyCommits[month].tags[tag] || 0) + 1;
                        });
                    }

                    totalAdditions += commit.stats?.additions || 0;
                    totalDeletions += commit.stats?.deletions || 0;
                }

                // Process contributors
                for (const contributor of data.contributors || []) {
                    const key = contributor.author_id || contributor.email?.toLowerCase();
                    if (!allContributors.has(key)) {
                        allContributors.set(key, {
                            ...contributor,
                            repos: new Set([repoId])
                        });
                    } else {
                        const existing = allContributors.get(key);
                        existing.commits += contributor.commits;
                        existing.additions += contributor.additions;
                        existing.deletions += contributor.deletions;
                        existing.repos.add(repoId);
                        for (const [type, count] of Object.entries(contributor.types || {})) {
                            existing.types[type] = (existing.types[type] || 0) + count;
                        }
                    }
                }

                // Process files
                for (const file of data.files || []) {
                    const key = `${repoId}:${file.path}`;
                    if (!allFiles.has(key)) {
                        allFiles.set(key, { ...file, repo_id: repoId });
                    }
                }
            }

            // Sort commits by timestamp
            allCommits.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Convert contributors
            const contributors = Array.from(allContributors.values())
                .map(c => ({
                    ...c,
                    repos: Array.from(c.repos),
                    repoCount: c.repos.size
                }))
                .sort((a, b) => b.commits - a.commits);

            // Get date range
            const timestamps = allCommits.map(c => c.timestamp).filter(Boolean).sort();

            return {
                metadata: {
                    repository: `Combined (${repos.length} repos)`,
                    repos,
                    authors: allAuthors
                },
                commits: allCommits,
                contributors,
                files: Array.from(allFiles.values()),
                summary: {
                    totalCommits: allCommits.length,
                    totalContributors: contributors.length,
                    totalAdditions,
                    totalDeletions,
                    netLinesChanged: totalAdditions - totalDeletions,
                    tagBreakdown,
                    monthlyCommits,
                    dateRange: {
                        earliest: timestamps[0] || null,
                        latest: timestamps[timestamps.length - 1] || null
                    }
                }
            };
        }

        // === Auto-load data.json if present ===
        async function tryAutoLoad() {
            try {
                // Try to load from same directory
                const response = await fetch('data.json');
                if (response.ok) {
                    const jsonData = await response.json();
                    loadData(jsonData);
                }
            } catch (e) {
                // Try reports folder
                try {
                    const response = await fetch('../reports/repo-tor/data.json');
                    if (response.ok) {
                        const jsonData = await response.json();
                        loadData(jsonData);
                    }
                } catch (e2) {
                    // No auto-load available
                }
            }
        }

        // === Utilities ===
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // === Toast Notification ===
        function showToast(message, duration = 3000) {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            // Trigger animation
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // === URL State Management (Shareable Links) ===
        function getStateFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return {
                tag: params.get('tag') || '',
                author: params.get('author') || '',
                repo: params.get('repo') || '',
                dateFrom: params.get('from') || '',
                dateTo: params.get('to') || '',
                tab: params.get('tab') || 'summary',
                period: params.get('period') || 'week',
                tz: params.get('tz') || 'local'
            };
        }

        function buildShareableUrl() {
            const url = new URL(window.location.href.split('?')[0]);
            const params = new URLSearchParams();

            // Add current tab
            const activeTab = document.querySelector('.tab-btn.border-blue-500')?.dataset.tab || 'summary';
            if (activeTab !== 'summary') params.set('tab', activeTab);

            // Add filters (only if set)
            if (filters.tag) params.set('tag', filters.tag);
            if (filters.author) params.set('author', filters.author);
            if (filters.repo) params.set('repo', filters.repo);
            if (filters.dateFrom) params.set('from', filters.dateFrom);
            if (filters.dateTo) params.set('to', filters.dateTo);

            // Add summary period if on summary tab
            if (activeTab === 'summary' && summaryPeriod !== 'week') {
                params.set('period', summaryPeriod);
            }

            // Add timezone if on timing tab and not local
            if (activeTab === 'timing' && useUTC) {
                params.set('tz', 'utc');
            }

            const paramStr = params.toString();
            return paramStr ? `${url}?${paramStr}` : url.toString();
        }

        function applyUrlState() {
            const state = getStateFromUrl();

            // Apply filters
            filters.tag = state.tag;
            filters.author = state.author;
            filters.repo = state.repo;
            filters.dateFrom = state.dateFrom;
            filters.dateTo = state.dateTo;

            // Update filter UI
            document.getElementById('filter-tag').value = state.tag;
            document.getElementById('filter-author').value = state.author;
            document.getElementById('filter-repo').value = state.repo;
            document.getElementById('filter-date-from').value = state.dateFrom;
            document.getElementById('filter-date-to').value = state.dateTo;

            // Apply summary period
            if (state.period) {
                summaryPeriod = state.period;
                document.getElementById('summary-period').value = state.period;
            }

            // Apply timezone
            if (state.tz === 'utc') {
                useUTC = true;
                document.getElementById('timezone-select').value = 'utc';
            }

            // Switch to specified tab
            if (state.tab) {
                const tabBtn = document.querySelector(`.tab-btn[data-tab="${state.tab}"]`);
                if (tabBtn) tabBtn.click();
            }
        }

        function copyShareableLink() {
            const url = buildShareableUrl();
            navigator.clipboard.writeText(url).then(() => {
                showToast('Link copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const input = document.createElement('input');
                input.value = url;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                showToast('Link copied to clipboard!');
            });
        }

        // === PDF Export ===
        async function exportToPdf() {
            const exportBtn = document.getElementById('btn-export-pdf');
            const originalText = exportBtn.innerHTML;
            exportBtn.innerHTML = `
                <svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
                <span class="hidden sm:inline">Generating...</span>
            `;
            exportBtn.disabled = true;

            try {
                // Get current active tab
                const activeTab = document.querySelector('.tab-btn.border-blue-500')?.dataset.tab || 'summary';
                const tabContent = document.getElementById(`tab-${activeTab}`);

                // Create a container for PDF content
                const pdfContent = document.createElement('div');
                pdfContent.style.cssText = 'background: white; padding: 20px; max-width: 1000px;';

                // Add header
                const header = document.createElement('div');
                header.innerHTML = `
                    <h1 style="font-size: 24px; font-weight: bold; color: #111827; margin-bottom: 8px;">
                        ${document.getElementById('repo-name').textContent}
                    </h1>
                    <p style="color: #6b7280; font-size: 14px; margin-bottom: 16px;">
                        ${document.getElementById('repo-subtitle').textContent}
                    </p>
                    <p style="color: #9ca3af; font-size: 12px; margin-bottom: 24px;">
                        Generated: ${new Date().toLocaleString()} | Tab: ${activeTab.charAt(0).toUpperCase() + activeTab.slice(1)}
                        ${hasActiveFilters() ? ' | Filtered view' : ''}
                    </p>
                `;
                pdfContent.appendChild(header);

                // Add summary stats
                const stats = document.createElement('div');
                stats.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            <p style="color: #6b7280; font-size: 12px; text-transform: uppercase;">Files Changed</p>
                            <p style="font-size: 24px; font-weight: bold;">${document.getElementById('stat-files').textContent}</p>
                        </div>
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            <p style="color: #6b7280; font-size: 12px; text-transform: uppercase;">Avg Complexity</p>
                            <p style="font-size: 24px; font-weight: bold;">${document.getElementById('stat-complexity').textContent}</p>
                        </div>
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            <p style="color: #6b7280; font-size: 12px; text-transform: uppercase;">Top Work Type</p>
                            <p style="font-size: 24px; font-weight: bold;">${document.getElementById('stat-top-tag').textContent}</p>
                        </div>
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            <p style="color: #6b7280; font-size: 12px; text-transform: uppercase;">Contributors</p>
                            <p style="font-size: 24px; font-weight: bold;">${document.getElementById('stat-contributors').textContent}</p>
                        </div>
                    </div>
                `;
                pdfContent.appendChild(stats);

                // Clone the current tab content
                const contentClone = tabContent.cloneNode(true);
                contentClone.classList.remove('hidden');
                // Remove any interactive elements
                contentClone.querySelectorAll('select, button, input').forEach(el => {
                    if (el.tagName === 'SELECT') {
                        const span = document.createElement('span');
                        span.textContent = el.options[el.selectedIndex]?.text || '';
                        span.style.cssText = 'font-weight: 500;';
                        el.replaceWith(span);
                    } else if (el.tagName === 'BUTTON') {
                        el.remove();
                    }
                });
                pdfContent.appendChild(contentClone);

                // Temporarily add to DOM for rendering
                pdfContent.style.position = 'absolute';
                pdfContent.style.left = '-9999px';
                document.body.appendChild(pdfContent);

                // Generate PDF
                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: `git-analytics-${activeTab}-${new Date().toISOString().split('T')[0]}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        logging: false
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: 'a4',
                        orientation: 'landscape'
                    }
                };

                await html2pdf().set(opt).from(pdfContent).save();

                // Cleanup
                document.body.removeChild(pdfContent);
                showToast('PDF exported successfully!');
            } catch (error) {
                console.error('PDF export error:', error);
                showToast('Export failed. Please try again.');
            } finally {
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
            }
        }

        function hasActiveFilters() {
            return filters.tag || filters.author || filters.repo || filters.dateFrom || filters.dateTo;
        }

        // Setup export/share button handlers
        function setupExportButtons() {
            document.getElementById('export-buttons').classList.remove('hidden');
            document.getElementById('btn-share').addEventListener('click', copyShareableLink);
            document.getElementById('btn-export-pdf').addEventListener('click', exportToPdf);
        }

        // Initialize
        tryAutoLoad();
    </script>
</body>
</html>
