<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Git Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Tag classes */
        .tag-feature { background-color: #10b981; color: white; }
        .tag-bugfix { background-color: #ef4444; color: white; }
        .tag-refactor { background-color: #8b5cf6; color: white; }
        .tag-docs { background-color: #3b82f6; color: white; }
        .tag-test { background-color: #f59e0b; color: white; }
        .tag-config { background-color: #64748b; color: white; }
        .tag-style { background-color: #ec4899; color: white; }
        .tag-cleanup { background-color: #6b7280; color: white; }
        .tag-security { background-color: #dc2626; color: white; }
        .tag-performance { background-color: #06b6d4; color: white; }
        .tag-dependency { background-color: #84cc16; color: white; }
        .tag-other { background-color: #9ca3af; color: white; }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .timeline-dot:hover {
            transform: scale(1.5);
        }

        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            padding: 1.5rem;
        }

        .tag {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .tag-security { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .tag-breaking { background-color: #fef3c7; color: #d97706; border: 1px solid #fde68a; }
        .tag-dependency { background-color: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }

        .filter-select {
            padding: 0.375rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background-color: white;
            min-width: 120px;
        }
        .filter-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .filter-input {
            padding: 0.375rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        .filter-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* Hide scrollbar for mobile tabs */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* Work pattern badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.625rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        .badge-after-hours {
            background-color: #fef3c7;
            color: #92400e;
        }
        .badge-weekend {
            background-color: #e0e7ff;
            color: #3730a3;
        }
        .badge-holiday {
            background-color: #fce7f3;
            color: #9d174d;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900" id="repo-name">Git Analytics Dashboard</h1>
            <p class="text-gray-500 mt-1" id="repo-subtitle">Loading data...</p>
        </header>

        <!-- Data Loader -->
        <div id="loader" class="card text-center py-12">
            <p class="text-gray-500">Select data file(s) to load:</p>
            <input type="file" id="file-input" accept=".json" multiple class="mt-4 text-sm">
            <p class="text-sm text-gray-400 mt-2">Select multiple files to combine data from different repositories</p>
            <p class="text-sm text-gray-400 mt-1">Or place your data.json in the same directory as this file</p>
        </div>

        <!-- Dashboard Content (hidden until data loads) -->
        <div id="dashboard" class="hidden">
            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="card">
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Commits</p>
                    <p class="text-3xl font-bold text-gray-900" id="stat-commits">0</p>
                    <p class="text-xs text-gray-400" id="stat-commits-filtered"></p>
                </div>
                <div class="card">
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Contributors</p>
                    <p class="text-3xl font-bold text-gray-900" id="stat-contributors">0</p>
                </div>
                <div class="card">
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Lines Added</p>
                    <p class="text-3xl font-bold text-green-600" id="stat-additions">0</p>
                </div>
                <div class="card">
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Lines Removed</p>
                    <p class="text-3xl font-bold text-red-600" id="stat-deletions">0</p>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="flex border-b border-gray-200 mb-6 overflow-x-auto -mx-4 px-4 md:mx-0 md:px-0 scrollbar-hide">
                <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600 whitespace-nowrap" data-tab="timeline">Timeline</button>
                <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="progress">Progress</button>
                <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="contributors">Contributors</button>
                <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="security">Security</button>
                <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="tags">By Tag</button>
                <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="timing">Timing</button>
            </div>

            <!-- Tab Content -->
            <div id="tab-timeline" class="tab-content">
                <!-- Filters -->
                <div class="card mb-6">
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:flex lg:flex-wrap items-end gap-3 lg:gap-4">
                        <div class="flex flex-col gap-1">
                            <label class="text-xs text-gray-500">Tag</label>
                            <select id="filter-tag" class="filter-select w-full">
                                <option value="">All Tags</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-xs text-gray-500">Author</label>
                            <select id="filter-author" class="filter-select w-full">
                                <option value="">All Authors</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1" id="repo-filter-container" style="display: none;">
                            <label class="text-xs text-gray-500">Repo</label>
                            <select id="filter-repo" class="filter-select w-full">
                                <option value="">All Repos</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-xs text-gray-500">From</label>
                            <input type="date" id="filter-date-from" class="filter-input w-full">
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-xs text-gray-500">To</label>
                            <input type="date" id="filter-date-to" class="filter-input w-full">
                        </div>
                        <button id="clear-filters" class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded border border-gray-200 col-span-2 sm:col-span-1">
                            Clear Filters
                        </button>
                    </div>
                    <!-- Work Pattern Legend -->
                    <div class="mt-3 pt-3 border-t border-gray-100 flex flex-wrap items-center gap-3 text-xs text-gray-500">
                        <span>Work patterns:</span>
                        <span class="badge badge-after-hours">After Hours</span>
                        <span class="text-gray-400">before 8am or after 5pm</span>
                        <span class="badge badge-weekend">Weekend</span>
                        <span class="text-gray-400">Sat/Sun</span>
                        <span class="badge badge-holiday">Holiday</span>
                        <span class="text-gray-400">SA public holidays</span>
                    </div>
                </div>

                <div class="card mb-6">
                    <h2 class="text-lg font-semibold mb-4">Commit Timeline</h2>
                    <div class="h-48 md:h-64">
                        <canvas id="timeline-chart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold">Recent Commits</h2>
                        <span id="commit-count" class="text-sm text-gray-500"></span>
                    </div>
                    <div id="commit-list" class="space-y-3 max-h-96 overflow-y-auto"></div>
                </div>
            </div>

            <div id="tab-progress" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <h2 class="text-lg font-semibold mb-4">Monthly Commit Volume</h2>
                        <div class="h-64">
                            <canvas id="monthly-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-lg font-semibold mb-4">Cumulative Growth (Lines of Code)</h2>
                        <div class="h-64">
                            <canvas id="growth-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card mt-6">
                    <h2 class="text-lg font-semibold mb-4">Feature vs Bug Fix Trend</h2>
                    <div class="h-64">
                        <canvas id="feat-fix-chart"></canvas>
                    </div>
                </div>
            </div>

            <div id="tab-contributors" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <h2 class="text-lg font-semibold mb-4">Commits by Contributor</h2>
                        <div class="h-64">
                            <canvas id="contributors-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-lg font-semibold mb-4">Lines Changed by Contributor</h2>
                        <div class="h-64">
                            <canvas id="contributors-lines-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card mt-6">
                    <h2 class="text-lg font-semibold mb-4">Contributor Details</h2>
                    <div id="contributor-list" class="space-y-3"></div>
                </div>
            </div>

            <div id="tab-security" class="tab-content hidden">
                <div class="card mb-6">
                    <h2 class="text-lg font-semibold mb-4">Security-Related Commits</h2>
                    <p class="text-sm text-gray-500 mb-4">Commits tagged with security, or containing security-related keywords</p>
                    <div id="security-count" class="text-4xl font-bold text-red-600 mb-4">0</div>
                    <div id="security-list" class="space-y-3"></div>
                </div>
            </div>

            <div id="tab-tags" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <h2 class="text-lg font-semibold mb-4">Commits by Tag</h2>
                        <p class="text-xs text-gray-500 -mt-2 mb-4">A commit can have multiple tags</p>
                        <div class="h-64">
                            <canvas id="tags-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-lg font-semibold mb-4">Tag Breakdown</h2>
                        <p class="text-xs text-gray-500 -mt-2 mb-4">Tag occurrences (total may exceed commit count)</p>
                        <div id="tag-breakdown" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <div id="tab-timing" class="tab-content hidden">
                <div class="card mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-lg font-semibold">When Work Happens</h2>
                            <p class="text-xs text-gray-500">Commit distribution by time of day and day of week</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-gray-500">Timezone:</label>
                            <select id="timezone-select" class="filter-select text-sm">
                                <option value="local">Local</option>
                                <option value="utc">UTC</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <h2 class="text-lg font-semibold mb-4">Commits by Hour of Day</h2>
                        <p class="text-xs text-gray-500 -mt-2 mb-4">Distribution across 24 hours (0-23)</p>
                        <div class="h-64">
                            <canvas id="hour-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-lg font-semibold mb-4">Commits by Day of Week</h2>
                        <p class="text-xs text-gray-500 -mt-2 mb-4">Distribution across weekdays</p>
                        <div class="h-64">
                            <canvas id="day-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === Global State ===
        let data = null;
        let charts = {};
        let filters = {
            tag: '',
            author: '',
            repo: '',
            dateFrom: '',
            dateTo: ''
        };
        let useUTC = false;

        // === South African Public Holidays ===
        // Format: 'YYYY-MM-DD' for fixed dates, calculated for moveable feasts
        const SA_HOLIDAYS = {
            // Fixed holidays (apply every year)
            fixed: [
                { month: 1, day: 1, name: "New Year's Day" },
                { month: 3, day: 21, name: "Human Rights Day" },
                { month: 4, day: 27, name: "Freedom Day" },
                { month: 5, day: 1, name: "Workers' Day" },
                { month: 6, day: 16, name: "Youth Day" },
                { month: 8, day: 9, name: "National Women's Day" },
                { month: 9, day: 24, name: "Heritage Day" },
                { month: 12, day: 16, name: "Day of Reconciliation" },
                { month: 12, day: 25, name: "Christmas Day" },
                { month: 12, day: 26, name: "Day of Goodwill" }
            ],
            // Easter-based holidays (Good Friday, Family Day) - pre-calculated for 2024-2027
            easter: {
                2024: { goodFriday: '2024-03-29', familyDay: '2024-04-01' },
                2025: { goodFriday: '2025-04-18', familyDay: '2025-04-21' },
                2026: { goodFriday: '2026-04-03', familyDay: '2026-04-06' },
                2027: { goodFriday: '2027-03-26', familyDay: '2027-03-29' }
            }
        };

        // Build holiday lookup set for quick checking
        function buildHolidaySet() {
            const holidays = new Set();
            // Add fixed holidays for years 2020-2030
            for (let year = 2020; year <= 2030; year++) {
                SA_HOLIDAYS.fixed.forEach(h => {
                    const dateStr = `${year}-${String(h.month).padStart(2, '0')}-${String(h.day).padStart(2, '0')}`;
                    holidays.add(dateStr);
                    // If holiday falls on Sunday, Monday is observed
                    const date = new Date(year, h.month - 1, h.day);
                    if (date.getDay() === 0) {
                        const monday = new Date(date);
                        monday.setDate(monday.getDate() + 1);
                        holidays.add(monday.toISOString().substring(0, 10));
                    }
                });
            }
            // Add Easter-based holidays
            Object.values(SA_HOLIDAYS.easter).forEach(e => {
                holidays.add(e.goodFriday);
                holidays.add(e.familyDay);
            });
            return holidays;
        }
        const holidaySet = buildHolidaySet();

        // === Work Pattern Helpers ===
        function getWorkPattern(commit) {
            const date = new Date(commit.timestamp);
            const hour = useUTC ? date.getUTCHours() : date.getHours();
            const dayOfWeek = useUTC ? date.getUTCDay() : date.getDay();
            const dateStr = commit.timestamp.substring(0, 10);

            return {
                isAfterHours: hour < 8 || hour >= 17,
                isWeekend: dayOfWeek === 0 || dayOfWeek === 6,
                isHoliday: holidaySet.has(dateStr),
                hour,
                dayOfWeek,
                dateStr
            };
        }

        function getWorkPatternBadges(commit) {
            const pattern = getWorkPattern(commit);
            const badges = [];

            if (pattern.isHoliday) {
                badges.push('<span class="badge badge-holiday">Holiday</span>');
            }
            if (pattern.isWeekend) {
                badges.push('<span class="badge badge-weekend">Weekend</span>');
            } else if (pattern.isAfterHours) {
                badges.push('<span class="badge badge-after-hours">After Hours</span>');
            }

            return badges.join(' ');
        }

        // === Tag Colors ===
        const TAG_COLORS = {
            feature: '#10b981',
            bugfix: '#ef4444',
            refactor: '#8b5cf6',
            docs: '#3b82f6',
            test: '#f59e0b',
            config: '#64748b',
            style: '#ec4899',
            cleanup: '#6b7280',
            security: '#dc2626',
            performance: '#06b6d4',
            dependency: '#84cc16',
            other: '#9ca3af'
        };

        // === Tag Helper Functions ===
        function getCommitTags(commit) {
            if (commit.tags && commit.tags.length > 0) {
                return commit.tags;
            }
            return ['other'];
        }

        function getAllTags(commits) {
            const tagSet = new Set();
            commits.forEach(c => {
                getCommitTags(c).forEach(tag => tagSet.add(tag));
            });
            return [...tagSet].sort();
        }

        function getTagColor(tag) {
            return TAG_COLORS[tag] || TAG_COLORS.other;
        }

        function getTagClass(tag) {
            return TAG_COLORS[tag] ? `tag-${tag}` : 'tag-other';
        }

        // === Author Resolution ===
        function getAuthorName(commit) {
            // Try to resolve from metadata.authors using author_id
            if (commit.author_id && data.metadata?.authors?.[commit.author_id]) {
                return data.metadata.authors[commit.author_id].name;
            }
            // Fall back to embedded author object
            return commit.author?.name || commit.author_id || 'Unknown';
        }

        function getAuthorEmail(commit) {
            // Try to resolve from metadata.authors using author_id
            if (commit.author_id && data.metadata?.authors?.[commit.author_id]) {
                return data.metadata.authors[commit.author_id].email;
            }
            // Fall back to embedded author object or author_id
            return commit.author?.email || commit.author_id || 'unknown';
        }

        // === Filter Functions ===
        function getFilteredCommits() {
            if (!data || !data.commits) return [];

            return data.commits.filter(commit => {
                // Tag filter - check if any of commit's tags match
                if (filters.tag) {
                    const commitTags = getCommitTags(commit);
                    if (!commitTags.includes(filters.tag)) return false;
                }

                // Author filter - check both author_id and author.email
                if (filters.author) {
                    const authorEmail = getAuthorEmail(commit);
                    if (authorEmail !== filters.author) return false;
                }

                // Repo filter
                if (filters.repo && commit.repo_id !== filters.repo) return false;

                // Date range filter
                if (filters.dateFrom) {
                    const commitDate = commit.timestamp?.substring(0, 10);
                    if (commitDate < filters.dateFrom) return false;
                }
                if (filters.dateTo) {
                    const commitDate = commit.timestamp?.substring(0, 10);
                    if (commitDate > filters.dateTo) return false;
                }

                return true;
            });
        }

        function populateFilters() {
            // Tag filter
            const tagSelect = document.getElementById('filter-tag');
            const tags = getAllTags(data.commits);
            tagSelect.innerHTML = '<option value="">All Tags</option>' +
                tags.map(t => `<option value="${t}">${t}</option>`).join('');

            // Author filter - use author resolution
            const authorSelect = document.getElementById('filter-author');
            const authorMap = {};
            data.commits.forEach(c => {
                const email = getAuthorEmail(c);
                const name = getAuthorName(c);
                if (email && !authorMap[email]) {
                    authorMap[email] = name;
                }
            });
            const authors = Object.keys(authorMap).sort();
            authorSelect.innerHTML = '<option value="">All Authors</option>' +
                authors.map(email => `<option value="${email}">${escapeHtml(authorMap[email] || email)}</option>`).join('');

            // Repo filter (only show if aggregated data)
            const repos = [...new Set(data.commits.map(c => c.repo_id).filter(Boolean))];
            const repoContainer = document.getElementById('repo-filter-container');
            if (repos.length > 1) {
                repoContainer.style.display = 'flex';
                const repoSelect = document.getElementById('filter-repo');
                repoSelect.innerHTML = '<option value="">All Repos</option>' +
                    repos.sort().map(r => `<option value="${r}">${r}</option>`).join('');
            } else {
                repoContainer.style.display = 'none';
            }

            // Date range defaults
            if (data.summary?.dateRange) {
                const fromInput = document.getElementById('filter-date-from');
                const toInput = document.getElementById('filter-date-to');
                if (data.summary.dateRange.earliest) {
                    fromInput.min = data.summary.dateRange.earliest.substring(0, 10);
                }
                if (data.summary.dateRange.latest) {
                    toInput.max = data.summary.dateRange.latest.substring(0, 10);
                }
            }
        }

        function setupFilterListeners() {
            document.getElementById('filter-tag').addEventListener('change', (e) => {
                filters.tag = e.target.value;
                applyFilters();
            });

            document.getElementById('filter-author').addEventListener('change', (e) => {
                filters.author = e.target.value;
                applyFilters();
            });

            document.getElementById('filter-repo').addEventListener('change', (e) => {
                filters.repo = e.target.value;
                applyFilters();
            });

            document.getElementById('filter-date-from').addEventListener('change', (e) => {
                filters.dateFrom = e.target.value;
                applyFilters();
            });

            document.getElementById('filter-date-to').addEventListener('change', (e) => {
                filters.dateTo = e.target.value;
                applyFilters();
            });

            document.getElementById('clear-filters').addEventListener('click', () => {
                filters = { tag: '', author: '', repo: '', dateFrom: '', dateTo: '' };
                document.getElementById('filter-tag').value = '';
                document.getElementById('filter-author').value = '';
                document.getElementById('filter-repo').value = '';
                document.getElementById('filter-date-from').value = '';
                document.getElementById('filter-date-to').value = '';
                applyFilters();
            });
        }

        function applyFilters() {
            renderTimeline();
            updateFilteredStats();
        }

        function updateFilteredStats() {
            const filtered = getFilteredCommits();
            const total = data.commits.length;
            const filteredEl = document.getElementById('stat-commits-filtered');

            if (filtered.length !== total) {
                filteredEl.textContent = `(${filtered.length} shown)`;
            } else {
                filteredEl.textContent = '';
            }
        }

        // === Data Loading ===
        async function loadData(jsonData) {
            data = jsonData;
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');

            // Update header
            document.getElementById('repo-name').textContent = data.metadata.repository;
            document.getElementById('repo-subtitle').textContent =
                `${data.summary.totalCommits} commits from ${data.summary.totalContributors} contributors | ` +
                `${formatDate(data.summary.dateRange.earliest)} - ${formatDate(data.summary.dateRange.latest)}`;

            // Update stats
            document.getElementById('stat-commits').textContent = data.summary.totalCommits.toLocaleString();
            document.getElementById('stat-contributors').textContent = data.summary.totalContributors;
            document.getElementById('stat-additions').textContent = formatNumber(data.summary.totalAdditions);
            document.getElementById('stat-deletions').textContent = formatNumber(data.summary.totalDeletions);

            // Populate and setup filters
            populateFilters();
            setupFilterListeners();

            // Render all views
            renderTimeline();
            renderProgress();
            renderContributors();
            renderSecurity();
            renderTags();
            renderTiming();
            setupTimezoneToggle();
        }

        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            return new Date(isoString).toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric'
            });
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // === Timeline Tab ===
        function renderTimeline() {
            const filteredCommits = getFilteredCommits();

            // Aggregate commits by date
            const byDate = {};
            filteredCommits.forEach(commit => {
                const date = commit.timestamp.substring(0, 10);
                if (!byDate[date]) byDate[date] = [];
                byDate[date].push(commit);
            });

            const dates = Object.keys(byDate).sort().reverse(); // Newest at top
            const counts = dates.map(d => byDate[d].length);

            // Timeline Chart (horizontal bar)
            if (charts.timeline) charts.timeline.destroy();
            charts.timeline = new Chart(document.getElementById('timeline-chart'), {
                type: 'bar',
                data: {
                    labels: dates.map(d => d.substring(5)), // MM-DD format
                    datasets: [{
                        label: 'Commits',
                        data: counts,
                        backgroundColor: '#3b82f6',
                        borderRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            ticks: {
                                autoSkip: true,
                                maxTicksLimit: 12
                            }
                        },
                        x: { beginAtZero: true }
                    }
                }
            });

            // Update commit count
            document.getElementById('commit-count').textContent =
                `Showing ${Math.min(filteredCommits.length, 50)} of ${filteredCommits.length} commits`;

            // Commit List
            const listHtml = filteredCommits.slice(0, 50).map(commit => {
                const tags = getCommitTags(commit);
                const tagBadges = tags.slice(0, 3).map(t =>
                    `<span class="tag ${getTagClass(t)} shrink-0">${t}</span>`
                ).join(' ');
                const extraTags = tags.length > 3 ? `<span class="tag tag-other shrink-0">+${tags.length - 3}</span>` : '';
                const workPatternBadges = getWorkPatternBadges(commit);

                return `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-start gap-2 sm:gap-3">
                        <div class="flex flex-wrap gap-1 shrink-0">
                            ${tagBadges}${extraTags}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 break-words sm:truncate">${escapeHtml(commit.subject)}</p>
                        </div>
                        <span class="text-xs text-gray-400 shrink-0 hidden sm:inline">
                            <span class="text-green-600">+${commit.stats?.additions || 0}</span>
                            <span class="text-red-600">-${commit.stats?.deletions || 0}</span>
                        </span>
                    </div>
                    <div class="mt-1 flex flex-wrap items-center gap-x-2 gap-y-1 text-xs text-gray-500">
                        <span class="font-mono">${commit.sha}</span>
                        <span class="hidden sm:inline">by</span>
                        <span class="sm:hidden">·</span>
                        <span>${escapeHtml(getAuthorName(commit))}</span>
                        <span class="hidden sm:inline">on</span>
                        <span class="sm:hidden">·</span>
                        <span>${formatDate(commit.timestamp)}</span>
                        ${commit.repo_id ? `<span class="text-gray-400">in ${commit.repo_id}</span>` : ''}
                        ${workPatternBadges ? `<span class="ml-1">${workPatternBadges}</span>` : ''}
                        <span class="sm:hidden text-gray-400">
                            <span class="text-green-600">+${commit.stats?.additions || 0}</span>
                            <span class="text-red-600">-${commit.stats?.deletions || 0}</span>
                        </span>
                    </div>
                </div>
            `}).join('');
            document.getElementById('commit-list').innerHTML = listHtml || '<p class="text-gray-500">No commits match the current filters</p>';
        }

        // === Progress Tab ===
        function renderProgress() {
            const months = Object.keys(data.summary.monthlyCommits).sort();
            const monthlyTotals = months.map(m => data.summary.monthlyCommits[m].total);

            // Monthly Commits Chart
            if (charts.monthly) charts.monthly.destroy();
            charts.monthly = new Chart(document.getElementById('monthly-chart'), {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Commits',
                        data: monthlyTotals,
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // Cumulative Growth Chart
            const sortedCommits = [...data.commits].sort((a, b) =>
                new Date(a.timestamp) - new Date(b.timestamp)
            );

            let cumulative = 0;
            const growthData = [];
            const growthLabels = [];

            sortedCommits.forEach((commit, i) => {
                cumulative += commit.stats.additions - commit.stats.deletions;
                if (i % Math.max(1, Math.floor(sortedCommits.length / 50)) === 0) {
                    growthLabels.push(commit.timestamp.substring(0, 10));
                    growthData.push(cumulative);
                }
            });

            if (charts.growth) charts.growth.destroy();
            charts.growth = new Chart(document.getElementById('growth-chart'), {
                type: 'line',
                data: {
                    labels: growthLabels,
                    datasets: [{
                        label: 'Net Lines',
                        data: growthData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { maxTicksLimit: 10 } }
                    }
                }
            });

            // Feature vs Bug Fix Trend
            const monthlyTagCounts = {};
            data.commits.forEach(commit => {
                const month = commit.timestamp?.substring(0, 7);
                if (!month) return;
                if (!monthlyTagCounts[month]) monthlyTagCounts[month] = { feature: 0, bugfix: 0 };
                const tags = getCommitTags(commit);
                if (tags.includes('feature')) monthlyTagCounts[month].feature++;
                if (tags.includes('bugfix')) monthlyTagCounts[month].bugfix++;
            });
            const featData = months.map(m => monthlyTagCounts[m]?.feature || 0);
            const fixData = months.map(m => monthlyTagCounts[m]?.bugfix || 0);

            if (charts.featFix) charts.featFix.destroy();
            charts.featFix = new Chart(document.getElementById('feat-fix-chart'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Features',
                            data: featData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Bug Fixes',
                            data: fixData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // === Contributors Tab ===
        function renderContributors() {
            const top10 = data.contributors.slice(0, 10);
            const names = top10.map(c => c.primaryName);
            const commits = top10.map(c => c.commits);
            const lines = top10.map(c => c.additions + c.deletions);

            // Commits by Contributor
            if (charts.contributors) charts.contributors.destroy();
            charts.contributors = new Chart(document.getElementById('contributors-chart'), {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [{
                        label: 'Commits',
                        data: commits,
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } }
                }
            });

            // Lines by Contributor
            if (charts.contributorsLines) charts.contributorsLines.destroy();
            charts.contributorsLines = new Chart(document.getElementById('contributors-lines-chart'), {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [{
                        label: 'Lines Changed',
                        data: lines,
                        backgroundColor: '#f59e0b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } }
                }
            });

            // Contributor List
            const listHtml = data.contributors.map(c => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-medium text-gray-900">${escapeHtml(c.primaryName)}</p>
                        <p class="text-xs text-gray-500">${escapeHtml(c.email)}${c.repos ? ` (${c.repos.length} repos)` : ''}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold">${c.commits} commits</p>
                        <p class="text-xs text-gray-500">
                            <span class="text-green-600">+${formatNumber(c.additions)}</span>
                            <span class="text-red-600">-${formatNumber(c.deletions)}</span>
                        </p>
                    </div>
                </div>
            `).join('');
            document.getElementById('contributor-list').innerHTML = listHtml;
        }

        // === Security Tab ===
        function renderSecurity() {
            // Use security_events from summary if available, otherwise compute
            let securityCommits;
            if (data.summary?.security_events?.length > 0) {
                // Map security_events back to full commits for display
                const securityShas = new Set(data.summary.security_events.map(e => e.sha));
                securityCommits = data.commits.filter(c => securityShas.has(c.sha));
            } else {
                securityCommits = data.commits.filter(c =>
                    c.type === 'security' || (c.tags || []).includes('security')
                );
            }

            document.getElementById('security-count').textContent = securityCommits.length;

            const listHtml = securityCommits.length > 0
                ? securityCommits.map(commit => `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex items-start gap-3">
                            <span class="tag tag-security">security</span>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">${escapeHtml(commit.subject)}</p>
                                <p class="text-sm text-gray-600 mt-1">${escapeHtml(commit.body || '').substring(0, 200) || 'No description'}</p>
                                <p class="text-xs text-gray-500 mt-2">
                                    ${commit.sha} by ${escapeHtml(getAuthorName(commit))} on ${formatDate(commit.timestamp)}
                                    ${commit.repo_id ? `in ${commit.repo_id}` : ''}
                                </p>
                            </div>
                        </div>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-center py-8">No security-related commits found</p>';

            document.getElementById('security-list').innerHTML = listHtml;
        }

        // === Tags Tab ===
        function renderTags() {
            // Build tag breakdown from commits (counting each tag occurrence)
            const tagBreakdown = {};
            data.commits.forEach(commit => {
                const tags = getCommitTags(commit);
                tags.forEach(tag => {
                    tagBreakdown[tag] = (tagBreakdown[tag] || 0) + 1;
                });
            });

            const tags = Object.keys(tagBreakdown);
            const counts = tags.map(t => tagBreakdown[t]);
            const colors = tags.map(t => getTagColor(t));

            // Tags Pie Chart
            if (charts.tags) charts.tags.destroy();
            charts.tags = new Chart(document.getElementById('tags-chart'), {
                type: 'doughnut',
                data: {
                    labels: tags,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });

            // Tag Breakdown List
            const total = counts.reduce((a, b) => a + b, 0);
            const sortedTags = tags.map((t, i) => ({ tag: t, count: counts[i] }))
                .sort((a, b) => b.count - a.count);

            const breakdownHtml = sortedTags.map(({ tag, count }) => `
                <div class="flex items-center gap-3">
                    <span class="tag ${getTagClass(tag)}">${tag}</span>
                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full" style="width: ${(count / total * 100).toFixed(1)}%; background-color: ${getTagColor(tag)}"></div>
                    </div>
                    <span class="text-sm text-gray-600">${count} (${(count / total * 100).toFixed(1)}%)</span>
                </div>
            `).join('');
            document.getElementById('tag-breakdown').innerHTML = breakdownHtml;
        }

        // === Timing Tab ===
        const DAY_NAMES = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const DAY_NAMES_SHORT = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        function getCommitDateTime(commit) {
            const date = new Date(commit.timestamp);
            if (useUTC) {
                return {
                    hour: date.getUTCHours(),
                    dayOfWeek: date.getUTCDay()
                };
            }
            return {
                hour: date.getHours(),
                dayOfWeek: date.getDay()
            };
        }

        function renderTiming() {
            // Aggregate commits by hour (0-23)
            const byHour = new Array(24).fill(0);
            // Aggregate commits by day of week (0=Sun, 6=Sat)
            const byDay = new Array(7).fill(0);

            data.commits.forEach(commit => {
                const { hour, dayOfWeek } = getCommitDateTime(commit);
                byHour[hour]++;
                byDay[dayOfWeek]++;
            });

            // Hour Chart
            const hourLabels = Array.from({ length: 24 }, (_, i) =>
                i.toString().padStart(2, '0') + ':00'
            );

            if (charts.hour) charts.hour.destroy();
            charts.hour = new Chart(document.getElementById('hour-chart'), {
                type: 'bar',
                data: {
                    labels: hourLabels,
                    datasets: [{
                        label: 'Commits',
                        data: byHour,
                        backgroundColor: byHour.map((_, i) =>
                            (i >= 8 && i < 17) ? '#3b82f6' : '#94a3b8'
                        ),
                        borderRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: (ctx) => {
                                    const hour = ctx.dataIndex;
                                    if (hour >= 8 && hour < 17) return 'Work hours';
                                    return 'After hours';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                callback: function(value, index) {
                                    // Show every 3rd label to reduce clutter
                                    return index % 3 === 0 ? this.getLabelForValue(value) : '';
                                }
                            }
                        },
                        y: { beginAtZero: true }
                    }
                }
            });

            // Day of Week Chart - reorder to start with Monday
            const mondayFirstOrder = [1, 2, 3, 4, 5, 6, 0]; // Mon-Sun
            const dayLabels = mondayFirstOrder.map(i => DAY_NAMES_SHORT[i]);
            const dayData = mondayFirstOrder.map(i => byDay[i]);

            if (charts.day) charts.day.destroy();
            charts.day = new Chart(document.getElementById('day-chart'), {
                type: 'bar',
                data: {
                    labels: dayLabels,
                    datasets: [{
                        label: 'Commits',
                        data: dayData,
                        backgroundColor: dayData.map((_, i) =>
                            (i < 5) ? '#3b82f6' : '#94a3b8'  // Mon-Fri blue, Sat-Sun gray
                        ),
                        borderRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: (ctx) => {
                                    return ctx.dataIndex < 5 ? 'Weekday' : 'Weekend';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function setupTimezoneToggle() {
            document.getElementById('timezone-select').addEventListener('change', (e) => {
                useUTC = e.target.value === 'utc';
                renderTiming();
            });
        }

        // === Tab Navigation ===
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Update button styles
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('border-blue-500', 'text-blue-600');
                    b.classList.add('border-transparent', 'text-gray-500');
                });
                btn.classList.remove('border-transparent', 'text-gray-500');
                btn.classList.add('border-blue-500', 'text-blue-600');

                // Show/hide tabs
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                document.getElementById(`tab-${btn.dataset.tab}`).classList.remove('hidden');
            });
        });

        // === File Input Handler ===
        document.getElementById('file-input').addEventListener('change', async (e) => {
            const files = e.target.files;
            if (!files || files.length === 0) return;

            try {
                if (files.length === 1) {
                    // Single file - load directly
                    const text = await files[0].text();
                    const jsonData = JSON.parse(text);
                    loadData(jsonData);
                } else {
                    // Multiple files - combine them
                    const allData = [];
                    for (const file of files) {
                        const text = await file.text();
                        const jsonData = JSON.parse(text);
                        allData.push(jsonData);
                    }
                    const combined = combineDataFiles(allData);
                    loadData(combined);
                }
            } catch (error) {
                alert('Error loading file(s): ' + error.message);
            }
        });

        // === Combine Multiple Data Files ===
        function combineDataFiles(dataFiles) {
            const allCommits = [];
            const allContributors = new Map();
            const allFiles = new Map();
            const repos = [];

            let totalAdditions = 0;
            let totalDeletions = 0;
            const tagBreakdown = {};
            const monthlyCommits = {};
            const allAuthors = {};

            for (const data of dataFiles) {
                const repoId = data.metadata?.repo_id || data.metadata?.repository || 'unknown';
                repos.push(repoId);

                // Merge authors from metadata
                if (data.metadata?.authors) {
                    Object.assign(allAuthors, data.metadata.authors);
                }

                // Process commits
                for (const commit of data.commits || []) {
                    const enrichedCommit = { ...commit, repo_id: commit.repo_id || repoId };
                    allCommits.push(enrichedCommit);

                    // Tag breakdown
                    const tags = getCommitTags(commit);
                    tags.forEach(tag => {
                        tagBreakdown[tag] = (tagBreakdown[tag] || 0) + 1;
                    });

                    // Monthly
                    const month = commit.timestamp?.substring(0, 7);
                    if (month) {
                        if (!monthlyCommits[month]) monthlyCommits[month] = { total: 0, tags: {} };
                        monthlyCommits[month].total++;
                        tags.forEach(tag => {
                            monthlyCommits[month].tags[tag] = (monthlyCommits[month].tags[tag] || 0) + 1;
                        });
                    }

                    totalAdditions += commit.stats?.additions || 0;
                    totalDeletions += commit.stats?.deletions || 0;
                }

                // Process contributors
                for (const contributor of data.contributors || []) {
                    const key = contributor.author_id || contributor.email?.toLowerCase();
                    if (!allContributors.has(key)) {
                        allContributors.set(key, {
                            ...contributor,
                            repos: new Set([repoId])
                        });
                    } else {
                        const existing = allContributors.get(key);
                        existing.commits += contributor.commits;
                        existing.additions += contributor.additions;
                        existing.deletions += contributor.deletions;
                        existing.repos.add(repoId);
                        for (const [type, count] of Object.entries(contributor.types || {})) {
                            existing.types[type] = (existing.types[type] || 0) + count;
                        }
                    }
                }

                // Process files
                for (const file of data.files || []) {
                    const key = `${repoId}:${file.path}`;
                    if (!allFiles.has(key)) {
                        allFiles.set(key, { ...file, repo_id: repoId });
                    }
                }
            }

            // Sort commits by timestamp
            allCommits.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Convert contributors
            const contributors = Array.from(allContributors.values())
                .map(c => ({
                    ...c,
                    repos: Array.from(c.repos),
                    repoCount: c.repos.size
                }))
                .sort((a, b) => b.commits - a.commits);

            // Get date range
            const timestamps = allCommits.map(c => c.timestamp).filter(Boolean).sort();

            return {
                metadata: {
                    repository: `Combined (${repos.length} repos)`,
                    repos,
                    authors: allAuthors
                },
                commits: allCommits,
                contributors,
                files: Array.from(allFiles.values()),
                summary: {
                    totalCommits: allCommits.length,
                    totalContributors: contributors.length,
                    totalAdditions,
                    totalDeletions,
                    netLinesChanged: totalAdditions - totalDeletions,
                    tagBreakdown,
                    monthlyCommits,
                    dateRange: {
                        earliest: timestamps[0] || null,
                        latest: timestamps[timestamps.length - 1] || null
                    }
                }
            };
        }

        // === Auto-load data.json if present ===
        async function tryAutoLoad() {
            try {
                // Try to load from same directory
                const response = await fetch('data.json');
                if (response.ok) {
                    const jsonData = await response.json();
                    loadData(jsonData);
                }
            } catch (e) {
                // Try reports folder
                try {
                    const response = await fetch('../reports/repo-tor/data.json');
                    if (response.ok) {
                        const jsonData = await response.json();
                        loadData(jsonData);
                    }
                } catch (e2) {
                    // No auto-load available
                }
            }
        }

        // === Utilities ===
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        tryAutoLoad();
    </script>
</body>
</html>
