<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Git Analytics Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Dark Theme */
        :root {
            color-scheme: dark;

            /* Primary Palette */
            --color-primary: #2D68FF;
            --color-background: #1B1B1B;
            --color-foreground: #FFFFFF;
            --color-card: #2a2a2a;
            --color-secondary: #767676;
            --color-border: #333333;

            /* Extended Palette */
            --color-primary-dark: #121213;
            --color-primary-light: #2a2a2a;
            --color-secondary-dark: #333333;
            --color-secondary-light: #222222;

            /* Semantic Colors */
            --color-success: #16A34A;
            --color-error: #EF4444;
            --color-warning: #EAB308;

            /* Mapped Variables (for compatibility) */
            --bg-primary: #1B1B1B;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #333333;
            --bg-hover: #222222;
            --text-primary: #FFFFFF;
            --text-secondary: #e5e7eb;
            --text-tertiary: #767676;
            --text-muted: #767676;
            --border-color: #333333;
            --border-light: #2a2a2a;
            --shadow: none;
            --chart-grid: rgba(255, 255, 255, 0.1);

            /* Spacing (8px base) */
            --spacing-base: 8px;
            --section-gap: 24px;
            --card-gap: 16px;
            --content-padding: 24px;

            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-full: 9999px;
        }

        /* Base styles */
        * {
            font-family: 'Figtree', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Tag classes - adjusted for dark theme */
        /* Additive (green family) */
        .tag-feature { background-color: rgba(22, 163, 74, 0.2); color: #16A34A; border: 1px solid rgba(22, 163, 74, 0.3); }
        .tag-enhancement { background-color: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); }
        .tag-seed { background-color: rgba(74, 222, 128, 0.2); color: #4ade80; border: 1px solid rgba(74, 222, 128, 0.3); }
        .tag-init { background-color: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
        /* Problems/Fixes (red family) */
        .tag-bugfix { background-color: rgba(239, 68, 68, 0.2); color: #EF4444; border: 1px solid rgba(239, 68, 68, 0.3); }
        .tag-fix { background-color: rgba(239, 68, 68, 0.2); color: #EF4444; border: 1px solid rgba(239, 68, 68, 0.3); }
        .tag-security { background-color: rgba(220, 38, 38, 0.2); color: #f87171; border: 1px solid rgba(220, 38, 38, 0.3); }
        .tag-hotfix { background-color: rgba(248, 113, 113, 0.2); color: #f87171; border: 1px solid rgba(248, 113, 113, 0.3); }
        /* Removal/Revert (orange/amber) */
        .tag-removal { background-color: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); }
        .tag-revert { background-color: rgba(251, 146, 60, 0.2); color: #fb923c; border: 1px solid rgba(251, 146, 60, 0.3); }
        .tag-deprecate { background-color: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3); }
        /* Refactoring (purple family) */
        .tag-refactor { background-color: rgba(139, 92, 246, 0.2); color: #a78bfa; border: 1px solid rgba(139, 92, 246, 0.3); }
        .tag-naming { background-color: rgba(167, 139, 250, 0.2); color: #a78bfa; border: 1px solid rgba(167, 139, 250, 0.3); }
        .tag-cleanup { background-color: rgba(124, 58, 237, 0.2); color: #a78bfa; border: 1px solid rgba(124, 58, 237, 0.3); }
        /* Documentation (blue) */
        .tag-docs { background-color: rgba(45, 104, 255, 0.2); color: #2D68FF; border: 1px solid rgba(45, 104, 255, 0.3); }
        /* Testing (yellow) */
        .tag-test { background-color: rgba(234, 179, 8, 0.2); color: #EAB308; border: 1px solid rgba(234, 179, 8, 0.3); }
        .tag-test-unit { background-color: rgba(250, 204, 21, 0.2); color: #facc15; border: 1px solid rgba(250, 204, 21, 0.3); }
        .tag-test-e2e { background-color: rgba(253, 224, 71, 0.2); color: #fde047; border: 1px solid rgba(253, 224, 71, 0.3); }
        /* DevOps/Build (orange) */
        .tag-build { background-color: rgba(249, 115, 22, 0.2); color: #f97316; border: 1px solid rgba(249, 115, 22, 0.3); }
        .tag-ci { background-color: rgba(251, 146, 60, 0.2); color: #fb923c; border: 1px solid rgba(251, 146, 60, 0.3); }
        .tag-deploy { background-color: rgba(234, 88, 12, 0.2); color: #ea580c; border: 1px solid rgba(234, 88, 12, 0.3); }
        /* Config/Chore (slate) */
        .tag-config { background-color: rgba(100, 116, 139, 0.2); color: #94a3b8; border: 1px solid rgba(100, 116, 139, 0.3); }
        .tag-chore { background-color: rgba(148, 163, 184, 0.2); color: #94a3b8; border: 1px solid rgba(148, 163, 184, 0.3); }
        /* Style/UX (pink family) */
        .tag-style { background-color: rgba(236, 72, 153, 0.2); color: #f472b6; border: 1px solid rgba(236, 72, 153, 0.3); }
        .tag-ux { background-color: rgba(244, 114, 182, 0.2); color: #f472b6; border: 1px solid rgba(244, 114, 182, 0.3); }
        .tag-ui { background-color: rgba(232, 121, 249, 0.2); color: #e879f9; border: 1px solid rgba(232, 121, 249, 0.3); }
        .tag-accessibility { background-color: rgba(217, 70, 239, 0.2); color: #d946ef; border: 1px solid rgba(217, 70, 239, 0.3); }
        /* Performance (cyan) */
        .tag-performance { background-color: rgba(6, 182, 212, 0.2); color: #22d3ee; border: 1px solid rgba(6, 182, 212, 0.3); }
        .tag-perf { background-color: rgba(34, 211, 238, 0.2); color: #22d3ee; border: 1px solid rgba(34, 211, 238, 0.3); }
        /* Dependencies (lime) */
        .tag-dependency { background-color: rgba(132, 204, 22, 0.2); color: #a3e635; border: 1px solid rgba(132, 204, 22, 0.3); }
        .tag-deps { background-color: rgba(163, 230, 53, 0.2); color: #a3e635; border: 1px solid rgba(163, 230, 53, 0.3); }
        /* Fallback */
        .tag-other { background-color: rgba(156, 163, 175, 0.2); color: #d1d5db; border: 1px solid rgba(156, 163, 175, 0.3); }
        /* Dynamic tag - uses CSS custom properties set via inline style */
        .tag-dynamic { background-color: var(--tag-bg); color: var(--tag-color); border: 1px solid var(--tag-border); }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .timeline-dot:hover {
            transform: scale(1.5);
        }

        .card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            padding: 24px;
        }

        /* Text color utilities using CSS variables for dark mode support */
        .text-themed-primary { color: var(--text-primary); }
        .text-themed-secondary { color: var(--text-secondary); }
        .text-themed-tertiary { color: var(--text-tertiary); }
        .text-themed-muted { color: var(--text-muted); }
        .bg-themed-primary { background-color: var(--bg-primary); }
        .bg-themed-secondary { background-color: var(--bg-secondary); }
        .bg-themed-tertiary { background-color: var(--bg-tertiary); }
        .border-themed { border-color: var(--border-color); }

        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 500;
        }

        /* Special alert-style tags */
        .tag-breaking { background-color: rgba(234, 179, 8, 0.1); color: #EAB308; border: 1px solid rgba(234, 179, 8, 0.3); }

        .filter-select {
            height: 40px;
            padding: 0 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            min-width: 0;
            max-width: 100%;
        }
        .filter-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(45, 104, 255, 0.2);
        }

        .filter-input {
            height: 40px;
            padding: 0 24px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        .filter-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(45, 104, 255, 0.2);
        }

        /* Hide scrollbar for mobile tabs */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* Work pattern badges - dark theme */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        .badge-after-hours {
            background-color: rgba(234, 179, 8, 0.2);
            color: #EAB308;
        }
        .badge-weekend {
            background-color: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }
        .badge-holiday {
            background-color: rgba(236, 72, 153, 0.2);
            color: #f472b6;
        }

        /* Export/Share buttons - dark theme */
        .btn-icon {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            height: 40px;
            padding: 0 32px;
            font-size: 14px;
            font-weight: 500;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: rgba(45, 104, 255, 0.9);
        }
        .btn-secondary {
            background-color: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover {
            background-color: var(--bg-secondary);
        }
        .btn-icon svg {
            width: 16px;
            height: 16px;
        }

        /* Toast notification - dark theme */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(16px);
            transition: all 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Icon buttons - dark theme */
        .btn-theme {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn-theme:hover {
            background-color: var(--bg-hover);
            color: var(--text-primary);
        }
        .btn-theme svg {
            width: 20px;
            height: 20px;
        }

        /* Print styles for PDF */
        @media print {
            body { background: white !important; }
            .no-print { display: none !important; }
            .card { box-shadow: none !important; border: 1px solid #e5e7eb; }
        }

        /* Heatmap styles - dark theme */
        .heatmap-grid {
            display: grid;
            grid-template-columns: 50px repeat(7, 1fr);
            gap: 2px;
            min-width: 400px;
        }
        .heatmap-cell {
            aspect-ratio: 1;
            min-width: 28px;
            min-height: 28px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--text-secondary);
            cursor: default;
            transition: transform 0.1s;
        }
        .heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 1;
        }
        .heatmap-label {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 11px;
            color: var(--text-tertiary);
        }
        .heatmap-header {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        /* Heatmap intensity levels - primary blue */
        .heatmap-0 { background-color: var(--bg-tertiary); }
        .heatmap-1 { background-color: rgba(45, 104, 255, 0.15); }
        .heatmap-2 { background-color: rgba(45, 104, 255, 0.35); }
        .heatmap-3 { background-color: rgba(45, 104, 255, 0.6); color: white; }
        .heatmap-4 { background-color: var(--color-primary); color: white; }

        /* Tailwind gray class overrides for dark theme */
        .bg-gray-50 { background-color: var(--bg-tertiary) !important; }
        .bg-gray-100 { background-color: var(--bg-primary) !important; }
        .text-gray-900 { color: var(--text-primary) !important; }
        .text-gray-700 { color: var(--text-secondary) !important; }
        .text-gray-600 { color: var(--text-secondary) !important; }
        .text-gray-500 { color: var(--text-tertiary) !important; }
        .text-gray-400 { color: var(--text-muted) !important; }
        .border-gray-200 { border-color: var(--border-color) !important; }
        .border-gray-100 { border-color: var(--border-light) !important; }
        .hover\:text-gray-900:hover { color: var(--text-primary) !important; }
        .hover\:text-gray-700:hover { color: var(--text-secondary) !important; }
        .hover\:bg-gray-100:hover { background-color: var(--bg-hover) !important; }

        /* Semantic card backgrounds for dark theme */
        .bg-amber-50 { background-color: rgba(234, 179, 8, 0.1) !important; }
        .bg-indigo-50 { background-color: rgba(45, 104, 255, 0.1) !important; }
        .bg-pink-50 { background-color: rgba(236, 72, 153, 0.1) !important; }
        .bg-purple-50 { background-color: rgba(139, 92, 246, 0.1) !important; }
        .bg-red-50 { background-color: rgba(239, 68, 68, 0.1) !important; }
        .bg-green-50 { background-color: rgba(22, 163, 74, 0.1) !important; }
        .bg-blue-50 { background-color: rgba(45, 104, 255, 0.1) !important; }

        /* Semantic text colors */
        .text-green-600 { color: var(--color-success) !important; }
        .text-red-600 { color: var(--color-error) !important; }
        .text-amber-600 { color: var(--color-warning) !important; }
        .text-blue-600 { color: var(--color-primary) !important; }
        .border-blue-500 { border-color: var(--color-primary) !important; }

        /* Tab button styling - dark theme */
        .tab-btn {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            color: var(--text-tertiary);
            white-space: nowrap;
            transition: all 0.15s;
        }
        .tab-btn:hover {
            color: var(--text-secondary);
        }
        .tab-btn.border-blue-500 {
            border-color: var(--color-primary) !important;
            color: var(--color-primary) !important;
        }

        /* Collapsible sections - dark theme */
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 12px 0;
            user-select: none;
        }
        .collapsible-header:hover {
            opacity: 0.8;
        }
        .collapsible-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .collapsible-chevron {
            width: 20px;
            height: 20px;
            transition: transform 0.2s ease;
            color: var(--text-tertiary);
            flex-shrink: 0;
        }
        .collapsible-header[aria-expanded="true"] .collapsible-chevron {
            transform: rotate(180deg);
        }
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.2s ease;
            max-height: 0;
            opacity: 0;
        }
        .collapsible-content.expanded {
            max-height: 2000px;
            opacity: 1;
        }
        .collapsible-subtitle {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-left: auto;
            margin-right: 8px;
        }

        /* Loading states - dark theme */
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--color-primary);
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: var(--bg-secondary);
            opacity: 0.8;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-lg);
            z-index: 10;
        }
        .card-loading {
            position: relative;
            min-height: 100px;
        }
        .skeleton {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-hover) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: var(--radius-sm);
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Detail Pane - Slide-out panel for drill-down (dark theme) */
        .detail-pane-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 998;
        }
        .detail-pane-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .detail-pane {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 480px;
            height: 100%;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            transform: translateX(100%);
            transition: transform 0.3s ease, visibility 0.3s ease;
            z-index: 999;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            visibility: hidden;
        }
        .detail-pane.open {
            transform: translateX(0);
            visibility: visible;
        }

        .detail-pane-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .detail-pane-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .detail-pane-subtitle {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }
        .detail-pane-close {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all 0.15s;
        }
        .detail-pane-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .detail-pane-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .detail-pane-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 48px;
        }

        /* Detail pane commit list - dark theme */
        .detail-commit {
            padding: 12px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            margin-bottom: 12px;
            transition: background 0.15s;
        }
        .detail-commit:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .detail-commit-message {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        .detail-commit-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 12px;
            color: var(--text-tertiary);
        }
        .detail-commit-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        /* Mobile: Bottom sheet variant */
        @media (max-width: 640px) {
            .detail-pane {
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                max-width: none;
                height: 85vh;
                max-height: 85vh;
                border-radius: var(--radius-lg) var(--radius-lg) 0 0;
                border-left: none;
                border-top: 1px solid var(--border-color);
                transform: translateY(100%);
                visibility: hidden;
            }
            .detail-pane.open {
                transform: translateY(0);
                visibility: visible;
            }
            .detail-pane-header {
                padding: 12px 16px;
            }
            .detail-pane-header::before {
                content: '';
                position: absolute;
                top: 8px;
                left: 50%;
                transform: translateX(-50%);
                width: 32px;
                height: 4px;
                background: var(--border-color);
                border-radius: 2px;
            }
            .detail-pane-content {
                padding: 16px;
            }
        }

        /* Stat card label styling - prevent awkward wrapping */
        .stat-label {
            font-size: 12px;
            line-height: 1.3;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        @media (min-width: 640px) {
            .stat-label {
                font-size: 14px;
                white-space: nowrap;
            }
        }

        /* Sticky tabs bar - dark theme */
        .tabs-bar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            margin: 0 -16px;
            padding: 0 16px;
            overflow: hidden;
        }
        @media (min-width: 768px) {
            .tabs-bar {
                margin: 0 -32px;
                padding: 0 32px;
            }
        }

        /* Filter toggle button - dark theme */
        .filter-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid transparent;
            flex-shrink: 0;
        }
        .filter-toggle:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .filter-toggle.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        .filter-toggle svg {
            width: 20px;
            height: 20px;
        }

        /* Dashboard layout with sidebar */
        .dashboard-layout {
            display: flex;
            gap: 24px;
            position: relative;
        }

        /* Filter sidebar - dark theme */
        .filter-sidebar {
            width: 280px;
            flex-shrink: 0;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .filter-sidebar.collapsed {
            width: 0;
            margin-left: -24px;
        }
        .filter-sidebar-inner {
            width: 280px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }
        .filter-sidebar-inner .filter-group {
            margin-bottom: 16px;
        }
        .filter-sidebar-inner .filter-group:last-child {
            margin-bottom: 0;
        }
        .filter-sidebar-inner label {
            display: block;
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 4px;
        }
        .filter-sidebar-inner select,
        .filter-sidebar-inner input {
            width: 100%;
        }

        /* Tab content area */
        .tab-content-area {
            flex: 1;
            min-width: 0;
        }

        /* Mobile: Filter sidebar as overlay */
        @media (max-width: 768px) {
            .filter-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                z-index: 200;
                width: 300px;
                max-width: 85vw;
                transform: translateX(-100%);
                margin: 0;
            }
            .filter-sidebar.collapsed {
                width: 300px;
                max-width: 85vw;
                margin-left: 0;
            }
            .filter-sidebar.open {
                transform: translateX(0);
            }
            .filter-sidebar-inner {
                width: 100%;
                height: 100%;
                border-radius: 0;
                overflow-y: auto;
                padding-top: 24px;
            }
            .filter-sidebar-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.8);
                z-index: 199;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }
            .filter-sidebar-overlay.open {
                opacity: 1;
                visibility: visible;
            }
        }

        /* Filter badge on toggle button - dark theme */
        .filter-toggle .filter-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: var(--color-primary);
            border-radius: 50%;
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-themed-primary" id="repo-name">Git Analytics Dashboard</h1>
                    <p class="text-themed-tertiary mt-1" id="repo-subtitle">Loading data...</p>
                </div>
                <div id="export-buttons" class="hidden flex items-center gap-2 no-print">
                    <button id="btn-sanitize" class="btn-theme" title="Toggle private mode (hide names/messages)">
                        <svg id="icon-eye" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.64 0 8.577 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.64 0-8.577-3.007-9.963-7.178z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <svg id="icon-eye-slash" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hidden">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
                        </svg>
                    </button>
                    <!-- Theme toggle hidden: dark theme is dark-only -->
                    <button id="btn-theme" class="btn-theme hidden" title="Toggle dark mode">
                        <svg id="icon-sun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hidden">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                        </svg>
                        <svg id="icon-moon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                        </svg>
                    </button>
                    <button id="btn-share" class="btn-icon btn-secondary" title="Copy shareable link">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
                        </svg>
                        <span class="hidden sm:inline">Share</span>
                    </button>
                    <button id="btn-export-pdf" class="btn-icon btn-primary" title="Export as PDF">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        <span class="hidden sm:inline">Export PDF</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Data Loader -->
        <div id="loader" class="card text-center py-12">
            <div id="loader-content">
                <p class="text-themed-tertiary">Select data file(s) to load:</p>
                <input type="file" id="file-input" accept=".json" multiple class="mt-4 text-sm">
                <p class="text-sm text-themed-muted mt-2">Select multiple files to combine data from different repositories</p>
                <p class="text-sm text-themed-muted mt-1">Or place your data.json in the same directory as this file</p>
            </div>
            <div id="loader-spinner" class="hidden">
                <div class="loading-spinner mb-3"></div>
                <p class="text-themed-tertiary">Loading dashboard data...</p>
            </div>
        </div>

        <!-- Dashboard Content (hidden until data loads) -->
        <div id="dashboard" class="hidden">
            <!-- Sticky Tabs Bar -->
            <div class="tabs-bar">
                <div class="flex items-center gap-2 py-2">
                    <button id="filter-toggle" class="filter-toggle relative no-print" title="Toggle filters">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                        </svg>
                        <span id="filter-badge" class="filter-badge hidden"></span>
                    </button>
                    <div class="flex overflow-x-auto scrollbar-hide flex-1 min-w-0">
                        <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600 whitespace-nowrap flex-shrink-0" data-tab="overview">Overview</button>
                        <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-themed-tertiary hover:text-themed-secondary whitespace-nowrap flex-shrink-0" data-tab="activity">Activity</button>
                        <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-themed-tertiary hover:text-themed-secondary whitespace-nowrap flex-shrink-0" data-tab="work">Breakdown</button>
                        <button class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-themed-tertiary hover:text-themed-secondary whitespace-nowrap flex-shrink-0" data-tab="health">Risk</button>
                    </div>
                </div>
            </div>

            <!-- Filter Sidebar Overlay (mobile) -->
            <div id="filter-overlay" class="filter-sidebar-overlay"></div>

            <!-- Main Content with Sidebar -->
            <div class="dashboard-layout mt-6">
                <!-- Filter Sidebar -->
                <aside id="filter-sidebar" class="filter-sidebar collapsed">
                    <div class="filter-sidebar-inner">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm font-medium text-themed-secondary">Filters</span>
                            <button id="clear-filters" class="px-2 py-1 text-xs text-themed-secondary hover:text-themed-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded border border-themed">
                                Clear
                            </button>
                        </div>
                        <div class="filter-group">
                            <label>View Level</label>
                            <select id="view-level-selector" class="filter-select">
                                <option value="developer">Developer</option>
                                <option value="management">Management</option>
                                <option value="executive">Executive</option>
                            </select>
                            <p class="text-xs text-themed-tertiary mt-1">Controls data granularity</p>
                        </div>
                        <hr class="border-themed my-3">
                        <div class="filter-group">
                            <label>Tag</label>
                            <select id="filter-tag" class="filter-select">
                                <option value="">All Tags</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Author</label>
                            <select id="filter-author" class="filter-select">
                                <option value="">All Authors</option>
                            </select>
                        </div>
                        <div class="filter-group" id="repo-filter-container" style="display: none;">
                            <label>Repo</label>
                            <select id="filter-repo" class="filter-select">
                                <option value="">All Repos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>From</label>
                            <input type="date" id="filter-date-from" class="filter-input">
                        </div>
                        <div class="filter-group">
                            <label>To</label>
                            <input type="date" id="filter-date-to" class="filter-input">
                        </div>
                        <div id="filter-indicator" class="hidden mt-3 px-2 py-1 text-xs font-medium bg-blue-100 text-blue-700 rounded text-center"></div>
                    </div>
                </aside>

                <!-- Tab Content Area -->
                <main class="tab-content-area">
                    <div id="tab-overview" class="tab-content">
                <!-- Period Selector -->
                <div class="card mb-6">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <div>
                            <h2 class="text-lg font-semibold text-themed-primary">Executive Summary</h2>
                            <p class="text-xs text-themed-tertiary">High-level overview for quick scanning</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-themed-tertiary">Compare:</label>
                            <select id="summary-period" class="filter-select text-sm">
                                <option value="7days">Last 7 Days</option>
                                <option value="30days">Last 30 Days</option>
                                <option value="quarter">This Quarter</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats with Trends -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-summary-card="features">
                        <p class="text-sm text-themed-tertiary uppercase tracking-wide">Features Built</p>
                        <p class="text-3xl font-bold text-green-600" id="summary-features">0</p>
                        <p class="text-sm mt-1" id="summary-features-trend"></p>
                    </div>
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-summary-card="fixes">
                        <p class="text-sm text-themed-tertiary uppercase tracking-wide">Bugs Fixed</p>
                        <p class="text-3xl font-bold text-amber-600" id="summary-fixes">0</p>
                        <p class="text-sm mt-1" id="summary-fixes-trend"></p>
                    </div>
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-summary-card="urgency">
                        <p class="text-sm text-themed-tertiary uppercase tracking-wide">Avg Urgency</p>
                        <p class="text-3xl font-bold text-themed-primary" id="summary-urgency">-</p>
                        <p class="text-sm mt-1" id="summary-urgency-trend"></p>
                    </div>
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-summary-card="planned">
                        <p class="text-sm text-themed-tertiary uppercase tracking-wide">% Planned</p>
                        <p class="text-3xl font-bold text-green-600" id="summary-planned">0%</p>
                        <p class="text-sm mt-1" id="summary-planned-trend"></p>
                    </div>
                </div>

                <!-- Additional Stats (from global metrics) -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                    <div class="card">
                        <p class="stat-label text-themed-tertiary">Files Changed</p>
                        <p class="text-3xl font-bold text-themed-primary" id="stat-files">0</p>
                        <p class="text-xs text-themed-muted" id="stat-files-sub"></p>
                    </div>
                    <div class="card">
                        <p class="stat-label text-themed-tertiary">Avg Complexity</p>
                        <p class="text-3xl font-bold text-themed-primary" id="stat-complexity">-</p>
                        <p class="text-xs text-themed-muted" id="stat-complexity-sub"></p>
                    </div>
                    <div class="card">
                        <p class="stat-label text-themed-tertiary">Contributors</p>
                        <p class="text-3xl font-bold text-themed-primary" id="stat-contributors">0</p>
                    </div>
                </div>

                <!-- Work Breakdown and Highlights -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="card" data-section="work-breakdown">
                        <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                            <div class="collapsible-title">
                                <h3 class="text-lg font-semibold text-themed-primary">Work Breakdown</h3>
                            </div>
                            <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="collapsible-content">
                            <div class="h-56 pt-2">
                                <canvas id="summary-breakdown-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card" data-section="highlights">
                        <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                            <div class="collapsible-title">
                                <h3 class="text-lg font-semibold text-themed-primary">Key Highlights</h3>
                            </div>
                            <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="collapsible-content">
                            <div id="summary-highlights" class="space-y-3 pt-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Activity Snapshot -->
                <div class="card" data-section="activity-snapshot">
                    <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                        <div class="collapsible-title">
                            <h3 class="text-lg font-semibold text-themed-primary">Activity Snapshot</h3>
                        </div>
                        <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="collapsible-content">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 pt-2" id="summary-activity">
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-activity" class="tab-content hidden">
                <!-- Activity Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-activity-card="total">
                        <p class="text-sm text-themed-tertiary uppercase tracking-wide">Total Commits</p>
                        <p class="text-3xl font-bold text-themed-primary" id="activity-total-commits">0</p>
                        <p class="text-xs text-themed-muted" id="activity-date-range"></p>
                    </div>
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-activity-card="days">
                        <p class="text-sm text-themed-tertiary uppercase tracking-wide">Active Days</p>
                        <p class="text-3xl font-bold text-blue-600" id="activity-active-days">0</p>
                        <p class="text-xs text-themed-muted" id="activity-days-sub"></p>
                    </div>
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-activity-card="contributors">
                        <p class="text-sm text-themed-tertiary uppercase tracking-wide">Contributors</p>
                        <p class="text-3xl font-bold text-green-600" id="activity-contributors">0</p>
                        <p class="text-xs text-themed-muted">active in period</p>
                    </div>
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-activity-card="avg">
                        <p class="text-sm text-themed-tertiary uppercase tracking-wide">Avg / Day</p>
                        <p class="text-3xl font-bold text-amber-600" id="activity-avg-per-day">0</p>
                        <p class="text-xs text-themed-muted">commits per active day</p>
                    </div>
                </div>

                <!-- Activity Timeline Chart -->
                <div class="card mb-6" data-section="activity-timeline">
                    <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                        <div class="collapsible-title">
                            <h2 class="text-lg font-semibold text-themed-primary">Activity Timeline</h2>
                        </div>
                        <span class="collapsible-subtitle">Commits by date across all projects</span>
                        <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="collapsible-content">
                        <div class="h-48 md:h-64 pt-2">
                            <canvas id="activity-timeline-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card mb-6" data-section="changes-list">
                    <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                        <div class="collapsible-title">
                            <h2 class="text-lg font-semibold text-themed-primary">Changes</h2>
                        </div>
                        <span id="commit-count" class="collapsible-subtitle"></span>
                        <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="collapsible-content">
                        <div id="commit-list" class="space-y-3 max-h-[600px] overflow-y-auto pt-2"></div>
                    </div>
                </div>
            </div>

            <div id="tab-progress" class="tab-content hidden">
                <!-- Work Breakdown Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-work-card="features">
                        <p class="text-sm text-themed-tertiary uppercase tracking-wide">Features</p>
                        <p class="text-3xl font-bold text-green-600" id="work-features">0</p>
                        <p class="text-xs text-themed-muted">new functionality</p>
                    </div>
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-work-card="bugfixes">
                        <p class="text-sm text-themed-tertiary uppercase tracking-wide">Bug Fixes</p>
                        <p class="text-3xl font-bold text-red-600" id="work-bugfixes">0</p>
                        <p class="text-xs text-themed-muted">issues resolved</p>
                    </div>
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-work-card="refactors">
                        <p class="text-sm text-themed-tertiary uppercase tracking-wide">Refactors</p>
                        <p class="text-3xl font-bold text-purple-600" id="work-refactors">0</p>
                        <p class="text-xs text-themed-muted">code improvements</p>
                    </div>
                    <div class="card">
                        <p class="text-sm text-themed-tertiary uppercase tracking-wide">Avg Complexity</p>
                        <p class="text-3xl font-bold text-themed-primary" id="work-avg-complexity">-</p>
                        <p class="text-xs text-themed-muted">1 (trivial) to 5 (complex)</p>
                    </div>
                </div>

                <div class="card mb-6" data-section="work-type-trend">
                    <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                        <div class="collapsible-title">
                            <h2 class="text-lg font-semibold text-themed-primary">Work Type Trend</h2>
                        </div>
                        <span class="collapsible-subtitle">Features vs bug fixes over time</span>
                        <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="collapsible-content">
                        <div class="h-64 pt-2">
                            <canvas id="feat-fix-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card mb-6" data-section="complexity-trend">
                    <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                        <div class="collapsible-title">
                            <h2 class="text-lg font-semibold text-themed-primary">Complexity Over Time</h2>
                        </div>
                        <span class="collapsible-subtitle">Average complexity by month</span>
                        <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="collapsible-content">
                        <div class="h-64 pt-2">
                            <canvas id="complexity-trend-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-contributors" class="tab-content hidden">
                <div class="card mb-6" data-section="who-does-what">
                    <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                        <div class="collapsible-title">
                            <h2 class="text-lg font-semibold text-themed-primary">Who Does What</h2>
                        </div>
                        <span class="collapsible-subtitle">Work type distribution by contributor</span>
                        <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="collapsible-content">
                        <div id="contributor-work-types" class="space-y-4 pt-2"></div>
                    </div>
                </div>
                <div class="card mb-6" data-section="complexity-by-contributor">
                    <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                        <div class="collapsible-title">
                            <h2 class="text-lg font-semibold text-themed-primary">Complexity by Contributor</h2>
                        </div>
                        <span class="collapsible-subtitle">Who handles complex vs simple changes</span>
                        <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="collapsible-content">
                        <div class="h-64 pt-2">
                            <canvas id="contributor-complexity-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-security" class="tab-content hidden">
                <!-- Operational Health Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-health-card="security">
                        <p class="text-sm text-themed-tertiary uppercase tracking-wide">Security</p>
                        <p class="text-3xl font-bold text-red-600" id="health-security-count">0</p>
                        <p class="text-xs text-themed-muted">security commits</p>
                    </div>
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-health-card="reactive">
                        <p class="text-sm text-themed-tertiary uppercase tracking-wide">Reactive</p>
                        <p class="text-3xl font-bold text-amber-600" id="health-reactive-pct">0%</p>
                        <p class="text-xs text-themed-muted">urgency 4-5</p>
                    </div>
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-health-card="weekend">
                        <p class="text-sm text-themed-tertiary uppercase tracking-wide">Weekend</p>
                        <p class="text-3xl font-bold text-indigo-600" id="health-weekend-pct">0%</p>
                        <p class="text-xs text-themed-muted">Sat/Sun commits</p>
                    </div>
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" data-health-card="afterhours">
                        <p class="text-sm text-themed-tertiary uppercase tracking-wide">After Hours</p>
                        <p class="text-3xl font-bold text-purple-600" id="health-afterhours-pct">0%</p>
                        <p class="text-xs text-themed-muted">outside work hours</p>
                    </div>
                </div>

                <!-- Security Commits -->
                <div class="card mb-6" data-section="security-commits">
                    <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                        <div class="collapsible-title">
                            <h2 class="text-lg font-semibold text-themed-primary">Security-Related Commits</h2>
                        </div>
                        <span class="collapsible-subtitle">Security-tagged commits</span>
                        <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="collapsible-content">
                        <div id="security-list" class="space-y-3 pt-2"></div>
                    </div>
                </div>

                <!-- Urgency Distribution -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="card" data-section="urgency-distribution">
                        <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                            <div class="collapsible-title">
                                <h2 class="text-lg font-semibold text-themed-primary">Urgency Distribution</h2>
                            </div>
                            <span class="collapsible-subtitle">Planned vs Normal vs Reactive</span>
                            <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="collapsible-content">
                            <div id="urgency-breakdown" class="space-y-3 pt-2"></div>
                        </div>
                    </div>
                    <div class="card" data-section="impact-distribution">
                        <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                            <div class="collapsible-title">
                                <h2 class="text-lg font-semibold text-themed-primary">Impact Distribution</h2>
                            </div>
                            <span class="collapsible-subtitle">Where effort is directed</span>
                            <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="collapsible-content">
                            <div id="impact-breakdown" class="space-y-3 pt-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Trend Charts -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="card" data-section="urgency-trend">
                        <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                            <div class="collapsible-title">
                                <h2 class="text-lg font-semibold text-themed-primary">Urgency Trend</h2>
                            </div>
                            <span class="collapsible-subtitle">Avg urgency by month (lower is better)</span>
                            <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="collapsible-content">
                            <div class="h-48 pt-2">
                                <canvas id="urgency-trend-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card" data-section="impact-trend">
                        <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                            <div class="collapsible-title">
                                <h2 class="text-lg font-semibold text-themed-primary">Impact Over Time</h2>
                            </div>
                            <span class="collapsible-subtitle">Impact categories by month</span>
                            <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="collapsible-content">
                            <div class="h-48 pt-2">
                                <canvas id="impact-trend-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contributor Health -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="card" data-section="urgency-by-contributor">
                        <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                            <div class="collapsible-title">
                                <h2 class="text-lg font-semibold text-themed-primary">Urgency by Contributor</h2>
                            </div>
                            <span class="collapsible-subtitle">Reactive vs planned work</span>
                            <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="collapsible-content">
                            <div id="urgency-by-contributor" class="space-y-3 pt-2"></div>
                        </div>
                    </div>
                    <div class="card" data-section="impact-by-contributor">
                        <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                            <div class="collapsible-title">
                                <h2 class="text-lg font-semibold text-themed-primary">Impact by Contributor</h2>
                            </div>
                            <span class="collapsible-subtitle">Where each person's effort goes</span>
                            <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="collapsible-content">
                            <div id="impact-by-contributor" class="space-y-3 pt-2"></div>
                        </div>
                    </div>
                </div>

            </div>

            <div id="tab-tags" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="card" data-section="commits-by-tag">
                        <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                            <div class="collapsible-title">
                                <h2 class="text-lg font-semibold text-themed-primary">Commits by Tag</h2>
                            </div>
                            <span class="collapsible-subtitle">Multiple tags per commit</span>
                            <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="collapsible-content">
                            <div class="h-80 pt-2">
                                <canvas id="tags-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card" data-section="tag-breakdown">
                        <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                            <div class="collapsible-title">
                                <h2 class="text-lg font-semibold text-themed-primary">Tag Breakdown</h2>
                            </div>
                            <span class="collapsible-subtitle">Tag occurrences</span>
                            <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="collapsible-content">
                            <div id="tag-breakdown" class="space-y-2 pt-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-timing" class="tab-content hidden">
                <div class="card mb-6">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <div>
                            <h2 class="text-lg font-semibold text-themed-primary">When Work Happens</h2>
                            <p class="text-xs text-themed-tertiary">Commit distribution by time of day and day of week</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-themed-tertiary">Timezone:</label>
                            <select id="timezone-select" class="filter-select text-sm">
                                <option value="local">Local</option>
                                <option value="utc">UTC</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Heatmap -->
                <div class="card mb-6" data-section="activity-heatmap">
                    <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                        <div class="collapsible-title">
                            <h2 class="text-lg font-semibold text-themed-primary">Activity Heatmap</h2>
                        </div>
                        <span class="collapsible-subtitle">Hour  day of week</span>
                        <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="collapsible-content">
                        <div id="heatmap-container" class="overflow-x-auto pt-2">
                            <div id="heatmap" class="heatmap-grid"></div>
                        </div>
                        <div class="flex items-center justify-center gap-2 mt-4 text-xs text-themed-tertiary">
                            <span>Less</span>
                            <div class="flex gap-0.5">
                                <div class="w-4 h-4 rounded heatmap-0"></div>
                                <div class="w-4 h-4 rounded heatmap-1"></div>
                                <div class="w-4 h-4 rounded heatmap-2"></div>
                                <div class="w-4 h-4 rounded heatmap-3"></div>
                                <div class="w-4 h-4 rounded heatmap-4"></div>
                            </div>
                            <span>More</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="card" data-section="commits-by-hour">
                        <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                            <div class="collapsible-title">
                                <h2 class="text-lg font-semibold text-themed-primary">Commits by Hour of Day</h2>
                            </div>
                            <span class="collapsible-subtitle">24-hour distribution</span>
                            <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="collapsible-content">
                            <div class="h-64 pt-2">
                                <canvas id="hour-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card" data-section="commits-by-day">
                        <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                            <div class="collapsible-title">
                                <h2 class="text-lg font-semibold text-themed-primary">Commits by Day of Week</h2>
                            </div>
                            <span class="collapsible-subtitle">Weekly distribution</span>
                            <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="collapsible-content">
                            <div class="h-64 pt-2">
                                <canvas id="day-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Developer Activity Patterns -->
                <div class="card mb-6" data-section="developer-patterns">
                    <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                        <div class="collapsible-title">
                            <h2 class="text-lg font-semibold text-themed-primary">Developer Activity Patterns</h2>
                        </div>
                        <span class="collapsible-subtitle">When each contributor commits</span>
                        <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="collapsible-content">
                        <div id="developer-patterns" class="space-y-4 pt-2"></div>
                    </div>
                </div>

                <!-- Work Hours Settings (collapsed by default - it's config, not content) -->
                <div class="card" data-section="work-hours-settings">
                    <div class="collapsible-header" aria-expanded="false" onclick="toggleSection(this)">
                        <div class="collapsible-title">
                            <h2 class="text-lg font-semibold text-themed-primary">Work Hours Settings</h2>
                        </div>
                        <span class="collapsible-subtitle">Customize what counts as "work hours"</span>
                        <svg class="collapsible-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="collapsible-content">
                        <div class="flex flex-wrap items-center gap-4 pt-3">
                            <div class="flex items-center gap-2">
                                <label class="text-xs text-themed-tertiary whitespace-nowrap">Start:</label>
                                <select id="work-hour-start" class="filter-select text-sm">
                                    <option value="6">6:00</option>
                                    <option value="7">7:00</option>
                                    <option value="8" selected>8:00</option>
                                    <option value="9">9:00</option>
                                    <option value="10">10:00</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-xs text-themed-tertiary whitespace-nowrap">End:</label>
                                <select id="work-hour-end" class="filter-select text-sm">
                                    <option value="16">16:00</option>
                                    <option value="17" selected>17:00</option>
                                    <option value="18">18:00</option>
                                    <option value="19">19:00</option>
                                    <option value="20">20:00</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                </main>
            </div>

            <!-- Dashboard Footer -->
            <footer id="dashboard-footer" class="mt-8 pt-6 pb-8 border-t border-themed text-center text-sm text-themed-tertiary">
                <span id="footer-summary">Loading...</span>
            </footer>
        </div>

        <!-- Detail Pane (slide-out panel for drill-down) -->
        <div id="detail-overlay" class="detail-pane-overlay"></div>
        <div id="detail-pane" class="detail-pane">
            <div class="detail-pane-header">
                <div>
                    <div class="detail-pane-title" id="detail-title">Details</div>
                    <div class="detail-pane-subtitle" id="detail-subtitle"></div>
                </div>
                <button class="detail-pane-close" id="detail-close" title="Close panel">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="detail-pane-content" id="detail-content">
                <div class="detail-pane-loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // === Global State ===
        let data = null;
        let charts = {};
        let filters = {
            tag: '',
            author: '',
            repo: '',
            dateFrom: '',
            dateTo: ''
        };
        let useUTC = false;
        let isDarkMode = false;
        let workHourStart = 8;
        let workHourEnd = 17;
        let isSanitized = false;
        const anonymousNames = ['Developer A', 'Developer B', 'Developer C', 'Developer D', 'Developer E', 'Developer F', 'Developer G', 'Developer H'];
        const authorAnonMap = new Map();
        let detailPaneOpen = false;

        // === View Level Configuration ===
        // Different data granularity for different audiences
        const VIEW_LEVELS = {
            executive: {
                label: 'Executive',
                contributors: 'total',      // Single aggregate: "45 contributors"
                timing: 'week',             // Weekly buckets only
                drilldown: 'summary',       // Stats only, no commit list
                showAuthorNames: false,
                showCommitMessages: false
            },
            management: {
                label: 'Management',
                contributors: 'repo',       // Group by project
                timing: 'day',              // Daily buckets
                drilldown: 'summary',       // Stats, not individual commits
                showAuthorNames: true,
                showCommitMessages: false
            },
            developer: {
                label: 'Developer',
                contributors: 'individual', // Per-person (current behavior)
                timing: 'hour',             // Hourly detail
                drilldown: 'commits',       // Full commit list
                showAuthorNames: true,
                showCommitMessages: true
            }
        };
        let currentViewLevel = 'developer';

        function getViewConfig() {
            return VIEW_LEVELS[currentViewLevel] || VIEW_LEVELS.developer;
        }

        // === Aggregation Functions for View Levels ===

        /**
         * Aggregate contributors based on view level
         * Returns same data shape, different granularity
         */
        function aggregateContributors(commits) {
            const config = getViewConfig();

            switch (config.contributors) {
                case 'total':
                    // Executive: one entry with totals
                    const uniqueAuthors = new Set(commits.map(c => getAuthorEmail(c)));
                    return [{
                        label: '__total__',
                        displayName: `All Contributors (${uniqueAuthors.size})`,
                        count: commits.length,
                        breakdown: aggregateByTag(commits),
                        complexities: commits.filter(c => c.complexity != null).map(c => c.complexity)
                    }];

                case 'repo':
                    // Management: group by repository
                    const byRepo = {};
                    commits.forEach(c => {
                        const repo = c.repo_id || 'default';
                        if (!byRepo[repo]) {
                            byRepo[repo] = {
                                label: repo,
                                commits: [],
                                authors: new Set(),
                                complexities: []
                            };
                        }
                        byRepo[repo].commits.push(c);
                        byRepo[repo].authors.add(getAuthorEmail(c));
                        if (c.complexity != null) {
                            byRepo[repo].complexities.push(c.complexity);
                        }
                    });
                    return Object.values(byRepo).map(r => ({
                        label: r.label,
                        displayName: `${r.label} (${r.authors.size} contributors)`,
                        count: r.commits.length,
                        breakdown: aggregateByTag(r.commits),
                        complexities: r.complexities
                    })).sort((a, b) => b.count - a.count);

                case 'individual':
                default:
                    // Developer: current behavior - per person
                    const byAuthor = {};
                    commits.forEach(c => {
                        const email = getAuthorEmail(c);
                        const name = getAuthorName(c);
                        if (!byAuthor[email]) {
                            byAuthor[email] = {
                                label: email,
                                displayName: sanitizeName(name, email),
                                commits: [],
                                tags: {},
                                complexities: []
                            };
                        }
                        byAuthor[email].commits.push(c);
                        getCommitTags(c).forEach(tag => {
                            byAuthor[email].tags[tag] = (byAuthor[email].tags[tag] || 0) + 1;
                        });
                        if (c.complexity != null) {
                            byAuthor[email].complexities.push(c.complexity);
                        }
                    });
                    return Object.values(byAuthor).map(a => ({
                        label: a.label,
                        displayName: a.displayName,
                        count: a.commits.length,
                        breakdown: a.tags,
                        complexities: a.complexities,
                        commits: a.commits
                    })).sort((a, b) => b.count - a.count);
            }
        }

        /**
         * Aggregate commits by tag
         */
        function aggregateByTag(commits) {
            const tags = {};
            commits.forEach(c => {
                getCommitTags(c).forEach(tag => {
                    tags[tag] = (tags[tag] || 0) + 1;
                });
            });
            return tags;
        }

        /**
         * Get date range from commits
         */
        function getCommitDateRange(commits) {
            if (!commits || commits.length === 0) {
                return { earliest: 'N/A', latest: 'N/A' };
            }
            const dates = commits.map(c => c.timestamp).filter(Boolean).sort();
            return {
                earliest: dates[0]?.substring(0, 10) || 'N/A',
                latest: dates[dates.length - 1]?.substring(0, 10) || 'N/A'
            };
        }

        /**
         * Aggregate for detail pane drilldown based on view level
         */
        function aggregateForDrilldown(commits, context) {
            const config = getViewConfig();

            if (config.drilldown === 'commits') {
                // Developer: return full commit list
                return { type: 'commits', data: commits };
            }

            // Executive/Management: return summary stats
            const uniqueAuthors = new Set(commits.map(c => getAuthorEmail(c)));
            const tagCounts = aggregateByTag(commits);
            const repos = [...new Set(commits.map(c => c.repo_id).filter(Boolean))];

            return {
                type: 'summary',
                data: {
                    totalCommits: commits.length,
                    contributorCount: uniqueAuthors.size,
                    tagBreakdown: tagCounts,
                    repoCount: repos.length,
                    dateRange: getCommitDateRange(commits),
                    // For management, include repo breakdown
                    ...(config.contributors === 'repo' && {
                        byRepo: repos.map(r => ({
                            name: r,
                            count: commits.filter(c => c.repo_id === r).length
                        })).sort((a, b) => b.count - a.count)
                    })
                }
            };
        }

        /**
         * Render drilldown summary for executive/management views
         */
        function renderDrilldownSummary(summary) {
            const tagBreakdownHtml = Object.entries(summary.tagBreakdown)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([tag, count]) => `
                    <div class="flex justify-between items-center py-1">
                        <span class="tag ${getTagClass(tag)}" style="${getTagStyle(tag)}">${tag}</span>
                        <span class="text-themed-secondary">${count}</span>
                    </div>
                `).join('');

            const repoBreakdownHtml = summary.byRepo
                ? summary.byRepo.map(r => `
                    <div class="flex justify-between items-center py-1">
                        <span class="text-themed-primary">${escapeHtml(r.name)}</span>
                        <span class="text-themed-secondary">${r.count} commits</span>
                    </div>
                `).join('')
                : '';

            return `
                <div class="space-y-6">
                    <!-- Summary Stats -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-themed-tertiary rounded-lg text-center">
                            <div class="text-2xl font-semibold text-themed-primary">${summary.totalCommits}</div>
                            <div class="text-sm text-themed-tertiary">Total Commits</div>
                        </div>
                        <div class="p-4 bg-themed-tertiary rounded-lg text-center">
                            <div class="text-2xl font-semibold text-themed-primary">${summary.contributorCount}</div>
                            <div class="text-sm text-themed-tertiary">Contributors</div>
                        </div>
                    </div>

                    <!-- Date Range -->
                    <div class="text-sm text-themed-tertiary text-center">
                        ${summary.dateRange.earliest}  ${summary.dateRange.latest}
                    </div>

                    <!-- Tag Breakdown -->
                    <div>
                        <h4 class="text-sm font-medium text-themed-primary mb-2">Work Type Breakdown</h4>
                        <div class="space-y-1">${tagBreakdownHtml || '<p class="text-themed-tertiary">No tags</p>'}</div>
                    </div>

                    ${repoBreakdownHtml ? `
                    <!-- Repo Breakdown (Management only) -->
                    <div>
                        <h4 class="text-sm font-medium text-themed-primary mb-2">By Repository</h4>
                        <div class="space-y-1">${repoBreakdownHtml}</div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // === Detail Pane Functions ===
        function openDetailPane(title, subtitle, commits) {
            const overlay = document.getElementById('detail-overlay');
            const pane = document.getElementById('detail-pane');
            const titleEl = document.getElementById('detail-title');
            const subtitleEl = document.getElementById('detail-subtitle');
            const contentEl = document.getElementById('detail-content');

            titleEl.textContent = title;
            subtitleEl.textContent = subtitle || '';

            // Check view level for appropriate drilldown
            const drilldown = aggregateForDrilldown(commits, { title });

            if (drilldown.type === 'commits') {
                // Developer view: show commit list (current behavior)
                if (commits && commits.length > 0) {
                    contentEl.innerHTML = commits.map(commit => renderDetailCommit(commit)).join('');
                } else {
                    contentEl.innerHTML = '<p class="text-themed-tertiary text-center py-8">No commits found</p>';
                }
            } else {
                // Executive/Management: show summary
                contentEl.innerHTML = renderDrilldownSummary(drilldown.data);
            }

            overlay.classList.add('open');
            pane.classList.add('open');
            detailPaneOpen = true;
            document.body.style.overflow = 'hidden';
        }

        function closeDetailPane() {
            const overlay = document.getElementById('detail-overlay');
            const pane = document.getElementById('detail-pane');

            overlay.classList.remove('open');
            pane.classList.remove('open');
            detailPaneOpen = false;
            document.body.style.overflow = '';
        }

        function renderDetailCommit(commit) {
            const tags = getCommitTags(commit);
            const email = getAuthorEmail(commit);
            const authorName = sanitizeName(getAuthorName(commit), email);
            const message = sanitizeMessage(getCommitSubject(commit));
            const date = new Date(commit.timestamp).toLocaleDateString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric'
            });

            const tagsHtml = tags.map(tag =>
                `<span class="tag ${getTagClass(tag)}" style="${getTagStyle(tag)}">${tag}</span>`
            ).join('');

            const urgencyLabel = commit.urgency ? getUrgencyLabel(commit.urgency) : '';
            const impactLabel = commit.impact ? commit.impact : '';

            return `
                <div class="detail-commit">
                    <div class="detail-commit-message">${escapeHtml(message)}</div>
                    <div class="detail-commit-meta">
                        <span>${authorName}</span>
                        <span></span>
                        <span>${date}</span>
                        ${commit.repo_id ? `<span></span><span>${commit.repo_id}</span>` : ''}
                        ${urgencyLabel ? `<span></span><span class="text-amber-600">${urgencyLabel}</span>` : ''}
                        ${impactLabel ? `<span></span><span class="text-blue-600">${impactLabel}</span>` : ''}
                    </div>
                    ${tags.length > 0 ? `<div class="detail-commit-tags">${tagsHtml}</div>` : ''}
                </div>
            `;
        }

        function getUrgencyLabel(urgency) {
            if (urgency <= 2) return 'Planned';
            if (urgency === 3) return 'Normal';
            return 'Reactive';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // === Filter Sidebar Functions ===
        let filterSidebarOpen = false;

        function toggleFilterSidebar() {
            const sidebar = document.getElementById('filter-sidebar');
            const overlay = document.getElementById('filter-overlay');
            const toggle = document.getElementById('filter-toggle');
            const isMobile = window.innerWidth <= 768;

            filterSidebarOpen = !filterSidebarOpen;

            if (filterSidebarOpen) {
                sidebar.classList.remove('collapsed');
                if (isMobile) {
                    sidebar.classList.add('open');
                    overlay.classList.add('open');
                    document.body.style.overflow = 'hidden';
                }
                toggle.classList.add('active');
            } else {
                sidebar.classList.add('collapsed');
                if (isMobile) {
                    sidebar.classList.remove('open');
                    overlay.classList.remove('open');
                    document.body.style.overflow = '';
                }
                toggle.classList.remove('active');
            }
        }

        function closeFilterSidebar() {
            if (!filterSidebarOpen) return;
            filterSidebarOpen = false;
            const sidebar = document.getElementById('filter-sidebar');
            const overlay = document.getElementById('filter-overlay');
            const toggle = document.getElementById('filter-toggle');

            sidebar.classList.add('collapsed');
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
            toggle.classList.remove('active');
            document.body.style.overflow = '';
        }

        function updateFilterBadge() {
            const badge = document.getElementById('filter-badge');
            const hasFilters = filters.tag || filters.author || filters.repo || filters.dateFrom || filters.dateTo;
            if (hasFilters) {
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // === Collapsible Sections ===
        const SECTION_STATE_KEY = 'dashboardSectionState';

        function toggleSection(header) {
            const isExpanded = header.getAttribute('aria-expanded') === 'true';
            const content = header.nextElementSibling;

            header.setAttribute('aria-expanded', !isExpanded);
            content.classList.toggle('expanded', !isExpanded);

            // Save state
            saveSectionState();
        }

        function saveSectionState() {
            const state = {};
            document.querySelectorAll('.collapsible-header').forEach(header => {
                const section = header.closest('[data-section]');
                if (section) {
                    state[section.dataset.section] = header.getAttribute('aria-expanded') === 'true';
                }
            });
            localStorage.setItem(SECTION_STATE_KEY, JSON.stringify(state));
        }

        function loadSectionState() {
            try {
                const stored = localStorage.getItem(SECTION_STATE_KEY);
                if (stored) {
                    const state = JSON.parse(stored);
                    document.querySelectorAll('[data-section]').forEach(section => {
                        const sectionName = section.dataset.section;
                        const header = section.querySelector('.collapsible-header');
                        const content = section.querySelector('.collapsible-content');
                        if (header && content && state[sectionName] !== undefined) {
                            header.setAttribute('aria-expanded', state[sectionName]);
                            content.classList.toggle('expanded', state[sectionName]);
                        }
                    });
                }
            } catch (e) {
                console.warn('Failed to load section state:', e);
            }
        }

        function initCollapsibleSections() {
            // Check if user has saved preferences
            const hasSavedState = localStorage.getItem(SECTION_STATE_KEY);

            if (hasSavedState) {
                // User has preferences - apply them
                document.querySelectorAll('.collapsible-header').forEach(header => {
                    header.setAttribute('aria-expanded', 'false');
                });
                document.querySelectorAll('.collapsible-content').forEach(content => {
                    content.classList.remove('expanded');
                });
                loadSectionState();
            } else {
                // First-time user: expand primary sections by default
                const defaultExpanded = [
                    'work-breakdown', 'highlights',  // Overview tab
                    'activity-timeline',             // Activity tab
                    'work-type-trend',               // Breakdown/Progress tab
                    'commits-by-tag', 'tag-breakdown', // Tags tab
                    'who-does-what',                 // Contributors tab
                    'urgency-distribution', 'impact-distribution', // Health/Risk tab
                    'activity-heatmap'               // Timing tab
                ];

                document.querySelectorAll('[data-section]').forEach(section => {
                    const sectionName = section.dataset.section;
                    const header = section.querySelector('.collapsible-header');
                    const content = section.querySelector('.collapsible-content');
                    if (header && content) {
                        const shouldExpand = defaultExpanded.includes(sectionName);
                        header.setAttribute('aria-expanded', shouldExpand);
                        content.classList.toggle('expanded', shouldExpand);
                    }
                });
            }
        }

        // Initialize detail pane event listeners
        function initDetailPane() {
            const overlay = document.getElementById('detail-overlay');
            const closeBtn = document.getElementById('detail-close');

            overlay.addEventListener('click', closeDetailPane);
            closeBtn.addEventListener('click', closeDetailPane);

            // Close on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && detailPaneOpen) {
                    closeDetailPane();
                }
            });
        }

        // Helper to filter commits by criteria and open detail pane
        function showCommitsInPane(title, subtitle, filterFn) {
            const filtered = getFilteredCommits().filter(filterFn);
            openDetailPane(title, subtitle, filtered);
        }

        // Initialize filter sidebar event listeners
        function initFilterSidebar() {
            const toggle = document.getElementById('filter-toggle');
            const overlay = document.getElementById('filter-overlay');

            toggle.addEventListener('click', toggleFilterSidebar);
            overlay.addEventListener('click', closeFilterSidebar);

            // Close on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && filterSidebarOpen) {
                    closeFilterSidebar();
                }
            });

            // Handle resize - close mobile overlay if switching to desktop
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768 && filterSidebarOpen) {
                    const sidebar = document.getElementById('filter-sidebar');
                    const overlay = document.getElementById('filter-overlay');
                    sidebar.classList.remove('open');
                    overlay.classList.remove('open');
                    document.body.style.overflow = '';
                }
            });
        }

        // === Dark Mode (Dark Theme - Always Dark) ===
        function initDarkMode() {
            // dark theme guide: dark mode only
            isDarkMode = true;
            applyDarkMode();
        }

        function applyDarkMode() {
            // Always apply dark mode for dark theme
            document.documentElement.classList.add('dark');

            // Hide theme toggle icons (dark-only mode)
            const iconSun = document.getElementById('icon-sun');
            const iconMoon = document.getElementById('icon-moon');
            if (iconSun) iconSun.classList.add('hidden');
            if (iconMoon) iconMoon.classList.add('hidden');

            // Chart.js defaults for dark theme
            Chart.defaults.color = '#b0b0b0';  // lighter text for chart labels (improved visibility)
            Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
        }

        function toggleDarkMode() {
            // No-op: dark theme is dark-only
            // Kept for compatibility but does nothing
        }

        // === Sanitization Mode ===
        function initSanitizeMode() {
            isSanitized = localStorage.getItem('sanitized') === 'true';
            applySanitizeMode();
        }

        function applySanitizeMode() {
            document.getElementById('icon-eye').classList.toggle('hidden', isSanitized);
            document.getElementById('icon-eye-slash').classList.toggle('hidden', !isSanitized);

            // Re-render views if data is loaded
            if (data) {
                renderTimeline();
                renderContributors();
                renderTiming();
                renderSummary();
            }
        }

        function toggleSanitizeMode() {
            isSanitized = !isSanitized;
            localStorage.setItem('sanitized', isSanitized);
            applySanitizeMode();
            showToast(isSanitized ? 'Private mode enabled' : 'Private mode disabled');
        }

        function getAnonymousName(email) {
            if (!authorAnonMap.has(email)) {
                const index = authorAnonMap.size % anonymousNames.length;
                authorAnonMap.set(email, anonymousNames[index]);
            }
            return authorAnonMap.get(email);
        }

        function sanitizeName(name, email) {
            if (!isSanitized) return name;
            return getAnonymousName(email);
        }

        function sanitizeMessage(message) {
            if (!isSanitized) return message;
            // Show only the type prefix if conventional commit, otherwise generic
            const match = message.match(/^(feat|fix|docs|style|refactor|test|chore|ci|build|perf|security)(\(.+?\))?:/i);
            if (match) {
                return match[0] + ' [message hidden]';
            }
            return '[Commit message hidden]';
        }

        // Initialize dark mode immediately (dark theme - always dark)
        (function() {
            document.documentElement.classList.add('dark');
        })();

        // === South African Public Holidays ===
        // Format: 'YYYY-MM-DD' for fixed dates, calculated for moveable feasts
        const SA_HOLIDAYS = {
            // Fixed holidays (apply every year)
            fixed: [
                { month: 1, day: 1, name: "New Year's Day" },
                { month: 3, day: 21, name: "Human Rights Day" },
                { month: 4, day: 27, name: "Freedom Day" },
                { month: 5, day: 1, name: "Workers' Day" },
                { month: 6, day: 16, name: "Youth Day" },
                { month: 8, day: 9, name: "National Women's Day" },
                { month: 9, day: 24, name: "Heritage Day" },
                { month: 12, day: 16, name: "Day of Reconciliation" },
                { month: 12, day: 25, name: "Christmas Day" },
                { month: 12, day: 26, name: "Day of Goodwill" }
            ],
            // Easter-based holidays (Good Friday, Family Day) - pre-calculated for 2024-2027
            easter: {
                2024: { goodFriday: '2024-03-29', familyDay: '2024-04-01' },
                2025: { goodFriday: '2025-04-18', familyDay: '2025-04-21' },
                2026: { goodFriday: '2026-04-03', familyDay: '2026-04-06' },
                2027: { goodFriday: '2027-03-26', familyDay: '2027-03-29' }
            }
        };

        // Build holiday lookup set for quick checking
        function buildHolidaySet() {
            const holidays = new Set();
            // Add fixed holidays for years 2020-2030
            for (let year = 2020; year <= 2030; year++) {
                SA_HOLIDAYS.fixed.forEach(h => {
                    const dateStr = `${year}-${String(h.month).padStart(2, '0')}-${String(h.day).padStart(2, '0')}`;
                    holidays.add(dateStr);
                    // If holiday falls on Sunday, Monday is observed
                    const date = new Date(year, h.month - 1, h.day);
                    if (date.getDay() === 0) {
                        const monday = new Date(date);
                        monday.setDate(monday.getDate() + 1);
                        holidays.add(monday.toISOString().substring(0, 10));
                    }
                });
            }
            // Add Easter-based holidays
            Object.values(SA_HOLIDAYS.easter).forEach(e => {
                holidays.add(e.goodFriday);
                holidays.add(e.familyDay);
            });
            return holidays;
        }
        const holidaySet = buildHolidaySet();

        // === Work Pattern Helpers ===
        function getWorkPattern(commit) {
            // Guard against missing timestamp
            if (!commit.timestamp) {
                return { isAfterHours: false, isWeekend: false, isHoliday: false, hour: 0, dayOfWeek: 0, dateStr: '' };
            }
            const date = new Date(commit.timestamp);
            const hour = useUTC ? date.getUTCHours() : date.getHours();
            const dayOfWeek = useUTC ? date.getUTCDay() : date.getDay();
            const dateStr = commit.timestamp.substring(0, 10);

            return {
                isAfterHours: hour < workHourStart || hour >= workHourEnd,
                isWeekend: dayOfWeek === 0 || dayOfWeek === 6,
                isHoliday: holidaySet.has(dateStr),
                hour,
                dayOfWeek,
                dateStr
            };
        }

        function getWorkPatternBadges(commit) {
            const pattern = getWorkPattern(commit);
            const badges = [];

            if (pattern.isHoliday) {
                badges.push('<span class="badge badge-holiday">Holiday</span>');
            }
            if (pattern.isWeekend) {
                badges.push('<span class="badge badge-weekend">Weekend</span>');
            } else if (pattern.isAfterHours) {
                badges.push('<span class="badge badge-after-hours">After Hours</span>');
            }

            return badges.join(' ');
        }

        // === Tag Colors ===
        // Semantic presets for common tags
        const TAG_COLORS = {
            // Additive (green family)
            feature: '#16A34A',
            enhancement: '#22c55e',
            seed: '#4ade80',
            init: '#10b981',
            // Problems/Fixes (red family)
            bugfix: '#ef4444',
            fix: '#ef4444',
            security: '#dc2626',
            hotfix: '#f87171',
            // Removal/Revert (orange/amber)
            removal: '#f59e0b',
            revert: '#fb923c',
            deprecate: '#fbbf24',
            // Refactoring (purple family)
            refactor: '#8b5cf6',
            naming: '#a78bfa',
            cleanup: '#7c3aed',
            // Documentation (blue)
            docs: '#2D68FF',
            // Testing (yellow)
            test: '#EAB308',
            'test-unit': '#facc15',
            'test-e2e': '#fde047',
            // DevOps/Build (orange/slate)
            build: '#f97316',
            ci: '#fb923c',
            deploy: '#ea580c',
            // Config/Chore (slate)
            config: '#64748b',
            chore: '#94a3b8',
            // Style/UX (pink family)
            style: '#ec4899',
            ux: '#f472b6',
            ui: '#e879f9',
            accessibility: '#d946ef',
            // Performance (cyan)
            performance: '#06b6d4',
            perf: '#22d3ee',
            // Dependencies (lime)
            dependency: '#84cc16',
            deps: '#a3e635',
            // Fallback
            other: '#9ca3af'
        };

        // Palette for dynamic tag colors (works well on dark backgrounds)
        const DYNAMIC_TAG_PALETTE = [
            '#f472b6', // pink
            '#a78bfa', // purple
            '#60a5fa', // blue
            '#34d399', // emerald
            '#fbbf24', // amber
            '#fb923c', // orange
            '#f87171', // red
            '#2dd4bf', // teal
            '#a3e635', // lime
            '#e879f9', // fuchsia
        ];

        // Simple hash function for consistent color assignment
        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash);
        }

        function getDynamicTagColor(tag) {
            const index = hashString(tag) % DYNAMIC_TAG_PALETTE.length;
            return DYNAMIC_TAG_PALETTE[index];
        }

        // === Tag Helper Functions ===
        function getCommitTags(commit) {
            if (commit.tags && commit.tags.length > 0) {
                return commit.tags;
            }
            return ['other'];
        }

        function getAllTags(commits) {
            const tagSet = new Set();
            commits.forEach(c => {
                getCommitTags(c).forEach(tag => tagSet.add(tag));
            });
            return [...tagSet].sort();
        }

        function getTagColor(tag) {
            return TAG_COLORS[tag] || getDynamicTagColor(tag);
        }

        function getTagClass(tag) {
            return TAG_COLORS[tag] ? `tag-${tag}` : 'tag-dynamic';
        }

        function getTagStyle(tag) {
            if (TAG_COLORS[tag]) return '';
            const color = getDynamicTagColor(tag);
            // Convert hex to rgba for background
            const r = parseInt(color.slice(1, 3), 16);
            const g = parseInt(color.slice(3, 5), 16);
            const b = parseInt(color.slice(5, 7), 16);
            return `--tag-bg: rgba(${r}, ${g}, ${b}, 0.2); --tag-color: ${color}; --tag-border: rgba(${r}, ${g}, ${b}, 0.3);`;
        }

        // === Author Resolution ===
        function getAuthorName(commit) {
            let name;
            // Try to resolve from metadata.authors using author_id
            if (commit.author_id && data.metadata?.authors?.[commit.author_id]) {
                name = data.metadata.authors[commit.author_id].name;
            } else {
                // Fall back to embedded author object
                name = commit.author?.name || commit.author_id || 'Unknown';
            }
            const email = getAuthorEmail(commit);
            return sanitizeName(name, email);
        }

        function getAuthorEmail(commit) {
            // Try to resolve from metadata.authors using author_id
            if (commit.author_id && data.metadata?.authors?.[commit.author_id]) {
                return data.metadata.authors[commit.author_id].email;
            }
            // Fall back to embedded author object or author_id
            return commit.author?.email || commit.author_id || 'unknown';
        }

        // === Data Format Helpers ===
        function getFilesChanged(commit) {
            // Handle different data formats: stats.filesChanged, filesChanged, files_changed
            return commit.stats?.filesChanged || commit.filesChanged || commit.files_changed || 0;
        }

        function getCommitSubject(commit) {
            // Handle different data formats: subject vs message
            return commit.subject || commit.message || '';
        }

        function getAdditions(commit) {
            // Handle different data formats: stats.additions vs lines_added
            return commit.stats?.additions || commit.lines_added || 0;
        }

        function getDeletions(commit) {
            // Handle different data formats: stats.deletions vs lines_deleted
            return commit.stats?.deletions || commit.lines_deleted || 0;
        }

        // === Summary Stats ===

        function updateSummaryStats() {
            const commits = getFilteredCommits();

            // Files changed - sum of all file changes across commits (not unique files)
            const totalFileChanges = commits.reduce((sum, c) => sum + getFilesChanged(c), 0);
            const uniqueFiles = data.files?.length || 0;
            document.getElementById('stat-files').textContent = totalFileChanges.toLocaleString();
            document.getElementById('stat-files-sub').textContent = uniqueFiles > 0 ? `${uniqueFiles} unique files` : `across ${commits.length} commits`;

            // Average complexity
            const complexities = commits.map(c => c.complexity).filter(c => c != null);
            if (complexities.length > 0) {
                const avgComplexity = (complexities.reduce((a, b) => a + b, 0) / complexities.length).toFixed(1);
                document.getElementById('stat-complexity').textContent = avgComplexity;
                // Complexity distribution
                const high = complexities.filter(c => c >= 4).length;
                const low = complexities.filter(c => c <= 2).length;
                document.getElementById('stat-complexity-sub').textContent = `${high} complex, ${low} simple`;
            } else {
                document.getElementById('stat-complexity').textContent = '-';
                document.getElementById('stat-complexity-sub').textContent = 'not available';
            }

            // Contributors - count unique authors in filtered commits
            const uniqueAuthors = new Set(commits.map(c => getAuthorEmail(c)));
            document.getElementById('stat-contributors').textContent = uniqueAuthors.size;
        }

        // === Filter Functions ===
        function getFilteredCommits() {
            if (!data || !data.commits) return [];

            return data.commits.filter(commit => {
                // Tag filter - check if any of commit's tags match
                if (filters.tag) {
                    const commitTags = getCommitTags(commit);
                    if (!commitTags.includes(filters.tag)) return false;
                }

                // Author filter - check both author_id and author.email
                if (filters.author) {
                    const authorEmail = getAuthorEmail(commit);
                    if (authorEmail !== filters.author) return false;
                }

                // Repo filter
                if (filters.repo && commit.repo_id !== filters.repo) return false;

                // Date range filter
                if (filters.dateFrom) {
                    const commitDate = commit.timestamp?.substring(0, 10);
                    if (commitDate < filters.dateFrom) return false;
                }
                if (filters.dateTo) {
                    const commitDate = commit.timestamp?.substring(0, 10);
                    if (commitDate > filters.dateTo) return false;
                }

                return true;
            });
        }

        function populateFilters() {
            // Tag filter
            const tagSelect = document.getElementById('filter-tag');
            const tags = getAllTags(data.commits);
            tagSelect.innerHTML = '<option value="">All Tags</option>' +
                tags.map(t => `<option value="${t}">${t}</option>`).join('');

            // Author filter - use author resolution
            const authorSelect = document.getElementById('filter-author');
            const authorMap = {};
            data.commits.forEach(c => {
                const email = getAuthorEmail(c);
                const name = getAuthorName(c);
                if (email && !authorMap[email]) {
                    authorMap[email] = name;
                }
            });
            const authors = Object.keys(authorMap).sort();
            authorSelect.innerHTML = '<option value="">All Authors</option>' +
                authors.map(email => `<option value="${email}">${escapeHtml(authorMap[email] || email)}</option>`).join('');

            // Repo filter (only show if aggregated data)
            const repos = [...new Set(data.commits.map(c => c.repo_id).filter(Boolean))];
            const repoContainer = document.getElementById('repo-filter-container');
            if (repos.length > 1) {
                repoContainer.style.display = 'block';
                const repoSelect = document.getElementById('filter-repo');
                repoSelect.innerHTML = '<option value="">All Repos</option>' +
                    repos.sort().map(r => `<option value="${r}">${r}</option>`).join('');
            } else {
                repoContainer.style.display = 'none';
            }

            // Date range defaults
            if (data.summary?.dateRange) {
                const fromInput = document.getElementById('filter-date-from');
                const toInput = document.getElementById('filter-date-to');
                if (data.summary.dateRange.earliest) {
                    fromInput.min = data.summary.dateRange.earliest.substring(0, 10);
                }
                if (data.summary.dateRange.latest) {
                    toInput.max = data.summary.dateRange.latest.substring(0, 10);
                }
            }
        }

        function setupFilterListeners() {
            // View level selector
            document.getElementById('view-level-selector').addEventListener('change', (e) => {
                currentViewLevel = e.target.value;
                localStorage.setItem('viewLevel', currentViewLevel);
                applyFilters();
            });

            // Restore saved view level
            const savedViewLevel = localStorage.getItem('viewLevel');
            if (savedViewLevel && VIEW_LEVELS[savedViewLevel]) {
                currentViewLevel = savedViewLevel;
                document.getElementById('view-level-selector').value = savedViewLevel;
            }

            document.getElementById('filter-tag').addEventListener('change', (e) => {
                filters.tag = e.target.value;
                applyFilters();
            });

            document.getElementById('filter-author').addEventListener('change', (e) => {
                filters.author = e.target.value;
                applyFilters();
            });

            document.getElementById('filter-repo').addEventListener('change', (e) => {
                filters.repo = e.target.value;
                applyFilters();
            });

            document.getElementById('filter-date-from').addEventListener('change', (e) => {
                filters.dateFrom = e.target.value;
                applyFilters();
            });

            document.getElementById('filter-date-to').addEventListener('change', (e) => {
                filters.dateTo = e.target.value;
                applyFilters();
            });

            document.getElementById('clear-filters').addEventListener('click', () => {
                filters = { tag: '', author: '', repo: '', dateFrom: '', dateTo: '' };
                document.getElementById('filter-tag').value = '';
                document.getElementById('filter-author').value = '';
                document.getElementById('filter-repo').value = '';
                document.getElementById('filter-date-from').value = '';
                document.getElementById('filter-date-to').value = '';
                applyFilters();
            });
        }

        function applyFilters() {
            // Update filter indicator
            updateFilterIndicator();
            // Re-render all tabs with filtered data
            updateSummaryStats();
            renderTimeline();
            renderProgress();
            renderContributors();
            renderTags();
            renderHealth();
            renderSecurity();
            renderTiming();
            renderSummary();
            saveFiltersToStorage();
        }

        function updateFilterIndicator() {
            const indicator = document.getElementById('filter-indicator');
            const filtered = getFilteredCommits();
            const total = data?.commits?.length || 0;
            const hasFilters = filters.tag || filters.author || filters.repo || filters.dateFrom || filters.dateTo;

            if (hasFilters && filtered.length !== total) {
                indicator.textContent = `${filtered.length} of ${total}`;
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }

            // Update filter badge on toggle button
            updateFilterBadge();
        }

        // === Filter Persistence ===
        function saveFiltersToStorage() {
            const state = {
                filters,
                summaryPeriod,
                useUTC,
                workHourStart,
                workHourEnd,
                activeTab: document.querySelector('.tab-btn.border-blue-500')?.dataset.tab || 'overview'
            };
            localStorage.setItem('dashboardState', JSON.stringify(state));
        }

        function loadFiltersFromStorage() {
            try {
                const stored = localStorage.getItem('dashboardState');
                if (!stored) return false;

                const state = JSON.parse(stored);

                // Restore filters (only if values are valid options in the new data)
                if (state.filters) {
                    const tagSelect = document.getElementById('filter-tag');
                    const authorSelect = document.getElementById('filter-author');
                    const repoSelect = document.getElementById('filter-repo');

                    // Restore tag filter if it exists in current options
                    if (state.filters.tag && [...tagSelect.options].some(o => o.value === state.filters.tag)) {
                        filters.tag = state.filters.tag;
                        tagSelect.value = filters.tag;
                    } else {
                        filters.tag = '';
                    }

                    // Restore author filter if it exists in current options
                    if (state.filters.author && [...authorSelect.options].some(o => o.value === state.filters.author)) {
                        filters.author = state.filters.author;
                        authorSelect.value = filters.author;
                    } else {
                        filters.author = '';
                    }

                    // Restore repo filter if it exists in current options
                    if (state.filters.repo && [...repoSelect.options].some(o => o.value === state.filters.repo)) {
                        filters.repo = state.filters.repo;
                        repoSelect.value = filters.repo;
                    } else {
                        filters.repo = '';
                    }

                    // Date filters don't need validation
                    filters.dateFrom = state.filters.dateFrom || '';
                    filters.dateTo = state.filters.dateTo || '';
                    document.getElementById('filter-date-from').value = filters.dateFrom;
                    document.getElementById('filter-date-to').value = filters.dateTo;
                }

                // Restore summary period
                if (state.summaryPeriod) {
                    summaryPeriod = state.summaryPeriod;
                    document.getElementById('summary-period').value = summaryPeriod;
                }

                // Restore timezone
                if (state.useUTC !== undefined) {
                    useUTC = state.useUTC;
                    document.getElementById('timezone-select').value = useUTC ? 'utc' : 'local';
                }

                // Restore work hours
                if (state.workHourStart !== undefined) {
                    workHourStart = state.workHourStart;
                    document.getElementById('work-hour-start').value = workHourStart;
                }
                if (state.workHourEnd !== undefined) {
                    workHourEnd = state.workHourEnd;
                    document.getElementById('work-hour-end').value = workHourEnd;
                }

                // Restore active tab
                if (state.activeTab) {
                    const tabBtn = document.querySelector(`.tab-btn[data-tab="${state.activeTab}"]`);
                    if (tabBtn) tabBtn.click();
                }

                return true;
            } catch (e) {
                console.warn('Failed to restore dashboard state:', e);
                return false;
            }
        }

        // === Data Loading ===
        async function loadData(jsonData) {
            data = jsonData;
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');

            // Update header
            document.getElementById('repo-name').textContent = data.metadata.repository;
            document.getElementById('repo-subtitle').textContent =
                `${data.summary.totalCommits} commits from ${data.summary.totalContributors} contributors | ` +
                `${formatDate(data.summary.dateRange.earliest)} - ${formatDate(data.summary.dateRange.latest)}`;

            // Update stats - focus on meaningful metrics
            updateSummaryStats();

            // Populate and setup filters
            populateFilters();
            setupFilterListeners();

            // Setup export/share buttons
            setupExportButtons();

            // Load saved state from localStorage (URL params will override)
            const hasUrlParams = window.location.search.length > 1;
            if (!hasUrlParams) {
                loadFiltersFromStorage();
            }

            // Apply URL state (filters, tab, etc.) if present
            applyUrlState();

            // Render all views
            renderSummary();
            renderTimeline();
            renderProgress();
            renderContributors();
            renderSecurity();
            renderHealth();
            renderTags();
            renderTiming();
            setupSummaryPeriodToggle();
            setupTimezoneToggle();
            setupWorkHoursToggle();

            // Initialize collapsible sections
            initCollapsibleSections();

            // Apply filters from URL after render
            if (hasActiveFilters()) {
                applyFilters();
            }

            // Update footer
            updateFooter();
        }

        function updateFooter() {
            const commitCount = data.summary.totalCommits;
            const dateRange = `${formatDate(data.summary.dateRange.earliest)}  ${formatDate(data.summary.dateRange.latest)}`;
            const loadedAt = new Date().toLocaleString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric',
                hour: 'numeric', minute: '2-digit'
            });
            document.getElementById('footer-summary').textContent =
                `${commitCount} commits  ${dateRange}  Data loaded ${loadedAt}`;
        }

        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            return new Date(isoString).toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric'
            });
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // === Timeline Tab ===
        let activityCardHandlersInitialized = false;

        function renderTimeline() {
            const filteredCommits = getFilteredCommits();
            const config = getViewConfig();

            // === Activity Summary Cards ===
            const totalCommits = filteredCommits.length;
            document.getElementById('activity-total-commits').textContent = totalCommits;

            // Active days (unique dates with commits)
            const uniqueDays = new Set(filteredCommits.map(c => c.timestamp?.substring(0, 10)).filter(Boolean));
            const activeDays = uniqueDays.size;
            document.getElementById('activity-active-days').textContent = activeDays;

            // Date range
            const sortedDates = [...uniqueDays].sort();
            if (sortedDates.length > 0) {
                const earliest = new Date(sortedDates[0]).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const latest = new Date(sortedDates[sortedDates.length - 1]).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                document.getElementById('activity-date-range').textContent = `${earliest}  ${latest}`;
                document.getElementById('activity-days-sub').textContent = `in ${sortedDates.length} day span`;
            } else {
                document.getElementById('activity-date-range').textContent = 'No data';
                document.getElementById('activity-days-sub').textContent = '';
            }

            // Contributors
            const uniqueContributors = new Set(filteredCommits.map(c => getAuthorEmail(c)));
            document.getElementById('activity-contributors').textContent = uniqueContributors.size;

            // Average commits per active day
            const avgPerDay = activeDays > 0 ? (totalCommits / activeDays).toFixed(1) : '0';
            document.getElementById('activity-avg-per-day').textContent = avgPerDay;

            // Add click handlers for activity cards (only once)
            if (!activityCardHandlersInitialized) {
                activityCardHandlersInitialized = true;
                document.querySelectorAll('[data-activity-card]').forEach(el => {
                    el.addEventListener('click', () => {
                        const cardType = el.dataset.activityCard;
                        const currentCommits = getFilteredCommits();
                        if (cardType === 'total') {
                            openDetailPane('All Commits', `${currentCommits.length} commits`, currentCommits);
                        } else if (cardType === 'contributors') {
                            // Show contributor list
                            const contributors = {};
                            currentCommits.forEach(c => {
                                const email = getAuthorEmail(c);
                                if (!contributors[email]) {
                                    contributors[email] = { name: getAuthorName(c), count: 0 };
                                }
                                contributors[email].count++;
                            });
                            const sorted = Object.values(contributors).sort((a, b) => b.count - a.count);
                            const html = sorted.map(c =>
                                `<div class="flex justify-between p-2 bg-themed-tertiary rounded mb-2">
                                    <span class="text-themed-primary">${escapeHtml(c.name)}</span>
                                    <span class="text-themed-tertiary">${c.count} commits</span>
                                </div>`
                            ).join('');
                            document.getElementById('detail-title').textContent = 'Contributors';
                            document.getElementById('detail-subtitle').textContent = `${sorted.length} active`;
                            document.getElementById('detail-content').innerHTML = html;
                            document.getElementById('detail-overlay').classList.add('open');
                            document.getElementById('detail-pane').classList.add('open');
                            detailPaneOpen = true;
                        }
                    });
                });
            }

            // Update count based on view level
            if (config.drilldown === 'commits') {
                document.getElementById('commit-count').textContent =
                    `Showing ${Math.min(filteredCommits.length, 100)} of ${filteredCommits.length}`;
            } else {
                document.getElementById('commit-count').textContent =
                    `${filteredCommits.length} total commits`;
            }

            // Render activity timeline chart
            renderActivityTimeline(filteredCommits);

            // Commit List - different view based on level
            let listHtml;

            if (config.drilldown === 'commits') {
                // Developer view: show individual commits (current behavior)
                listHtml = filteredCommits.slice(0, 100).map(commit => {
                    const tags = getCommitTags(commit);
                    const tagBadges = tags.slice(0, 3).map(t =>
                        `<span class="tag ${getTagClass(t)} shrink-0" style="${getTagStyle(t)}">${t}</span>`
                    ).join(' ');
                    const extraTags = tags.length > 3 ? `<span class="tag tag-other shrink-0">+${tags.length - 3}</span>` : '';
                    const workPatternBadges = getWorkPatternBadges(commit);
                    const complexityBadge = commit.complexity != null
                        ? `<span class="text-xs px-1.5 py-0.5 rounded ${commit.complexity >= 4 ? 'bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300' : commit.complexity >= 2 ? 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' : 'bg-gray-100 text-themed-secondary dark:bg-gray-700'}">${commit.complexity}/5</span>`
                        : '';

                    return `
                    <div class="p-3 bg-themed-tertiary rounded-lg">
                        <div class="flex items-start gap-2 sm:gap-3">
                            <div class="flex flex-wrap gap-1 shrink-0">
                                ${tagBadges}${extraTags}
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-themed-primary break-words sm:truncate">${escapeHtml(sanitizeMessage(getCommitSubject(commit)))}</p>
                            </div>
                            ${complexityBadge}
                        </div>
                        <div class="mt-1 flex flex-wrap items-center gap-x-2 gap-y-1 text-xs text-themed-tertiary">
                            <span>${escapeHtml(getAuthorName(commit))}</span>
                            <span></span>
                            <span>${formatDate(commit.timestamp)}</span>
                            ${commit.repo_id ? `<span class="text-themed-muted"> ${commit.repo_id}</span>` : ''}
                            ${workPatternBadges ? `<span class="ml-1">${workPatternBadges}</span>` : ''}
                        </div>
                    </div>
                `}).join('');
            } else {
                // Executive/Management view: show summary by time period
                const periodData = config.timing === 'week'
                    ? aggregateByWeekPeriod(filteredCommits)
                    : aggregateByDayPeriod(filteredCommits);

                listHtml = periodData.slice(0, 20).map(period => {
                    const tagSummary = Object.entries(period.tags)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 4)
                        .map(([tag, count]) => `<span class="tag ${getTagClass(tag)}" style="${getTagStyle(tag)}">${tag} (${count})</span>`)
                        .join(' ');

                    return `
                    <div class="p-3 bg-themed-tertiary rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" data-period-key="${period.key}">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-themed-primary">${period.label}</span>
                            <span class="text-sm text-themed-secondary">${period.count} commits</span>
                        </div>
                        <div class="flex flex-wrap gap-1">
                            ${tagSummary}
                        </div>
                        ${period.repos && period.repos.length > 1 ? `<div class="text-xs text-themed-tertiary mt-1">${period.repos.length} repos</div>` : ''}
                    </div>
                `;
                }).join('');

                // Add click handlers for period cards
                setTimeout(() => {
                    document.querySelectorAll('[data-period-key]').forEach(el => {
                        el.addEventListener('click', () => {
                            const key = el.dataset.periodKey;
                            const period = periodData.find(p => p.key === key);
                            if (period) {
                                openDetailPane(period.label, `${period.count} commits`, period.commits);
                            }
                        });
                    });
                }, 0);
            }

            document.getElementById('commit-list').innerHTML = listHtml || '<p class="text-themed-tertiary">No changes match the current filters</p>';
        }

        // Helper: aggregate commits by week for executive view
        function aggregateByWeekPeriod(commits) {
            const byWeek = {};
            commits.forEach(c => {
                if (!c.timestamp) return;
                const date = new Date(c.timestamp);
                const weekStart = new Date(date);
                weekStart.setDate(date.getDate() - ((date.getDay() + 6) % 7));
                const key = weekStart.toISOString().substring(0, 10);
                if (!byWeek[key]) {
                    byWeek[key] = { commits: [], tags: {}, repos: new Set() };
                }
                byWeek[key].commits.push(c);
                getCommitTags(c).forEach(tag => {
                    byWeek[key].tags[tag] = (byWeek[key].tags[tag] || 0) + 1;
                });
                if (c.repo_id) byWeek[key].repos.add(c.repo_id);
            });

            return Object.entries(byWeek)
                .sort((a, b) => b[0].localeCompare(a[0]))  // Most recent first
                .map(([key, data]) => ({
                    key,
                    label: `Week of ${new Date(key).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
                    count: data.commits.length,
                    commits: data.commits,
                    tags: data.tags,
                    repos: [...data.repos]
                }));
        }

        // Helper: aggregate commits by day for management view
        function aggregateByDayPeriod(commits) {
            const byDay = {};
            commits.forEach(c => {
                if (!c.timestamp) return;
                const key = c.timestamp.substring(0, 10);
                if (!byDay[key]) {
                    byDay[key] = { commits: [], tags: {}, repos: new Set() };
                }
                byDay[key].commits.push(c);
                getCommitTags(c).forEach(tag => {
                    byDay[key].tags[tag] = (byDay[key].tags[tag] || 0) + 1;
                });
                if (c.repo_id) byDay[key].repos.add(c.repo_id);
            });

            return Object.entries(byDay)
                .sort((a, b) => b[0].localeCompare(a[0]))  // Most recent first
                .map(([key, data]) => ({
                    key,
                    label: new Date(key).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }),
                    count: data.commits.length,
                    commits: data.commits,
                    tags: data.tags,
                    repos: [...data.repos]
                }));
        }

        function renderActivityTimeline(commits) {
            // Group commits by date
            const commitsByDate = {};
            const repoColors = {};
            const repos = [...new Set(commits.map(c => c.repo_id).filter(Boolean))];

            // Assign colors to repos - dark theme palette
            const repoColorPalette = ['#2D68FF', '#16A34A', '#EAB308', '#a78bfa', '#EF4444', '#22d3ee'];
            repos.forEach((repo, i) => {
                repoColors[repo] = repoColorPalette[i % repoColorPalette.length];
            });

            commits.forEach(commit => {
                const dateStr = commit.timestamp?.substring(0, 10);
                if (!dateStr) return;
                if (!commitsByDate[dateStr]) {
                    commitsByDate[dateStr] = { total: 0, byRepo: {} };
                }
                commitsByDate[dateStr].total++;
                if (commit.repo_id) {
                    commitsByDate[dateStr].byRepo[commit.repo_id] = (commitsByDate[dateStr].byRepo[commit.repo_id] || 0) + 1;
                }
            });

            // Sort dates and limit to reasonable range (last 60 dates with activity)
            const sortedDates = Object.keys(commitsByDate).sort().slice(-60);

            if (sortedDates.length === 0) {
                if (charts.activityTimeline) charts.activityTimeline.destroy();
                return;
            }

            // Build datasets
            let datasets;
            if (repos.length > 1) {
                // Multi-repo: stacked bar chart by repo
                datasets = repos.map(repo => ({
                    label: repo,
                    data: sortedDates.map(d => commitsByDate[d]?.byRepo[repo] || 0),
                    backgroundColor: repoColors[repo],
                    borderRadius: 2
                }));
            } else {
                // Single repo: simple bar chart
                datasets = [{
                    label: 'Commits',
                    data: sortedDates.map(d => commitsByDate[d]?.total || 0),
                    backgroundColor: '#2D68FF',
                    borderRadius: 2
                }];
            }

            // Format date labels (show month/day for readability)
            const labels = sortedDates.map(d => {
                const date = new Date(d);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            if (charts.activityTimeline) charts.activityTimeline.destroy();
            charts.activityTimeline = new Chart(document.getElementById('activity-timeline-chart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: repos.length > 1,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            stacked: repos.length > 1,
                            ticks: {
                                maxRotation: 45,
                                callback: function(value, index) {
                                    // Show fewer labels on smaller datasets
                                    const step = Math.ceil(sortedDates.length / 15);
                                    return index % step === 0 ? this.getLabelForValue(value) : '';
                                }
                            }
                        },
                        y: {
                            stacked: repos.length > 1,
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        // === Progress Tab ===
        let workCardHandlersInitialized = false;

        function renderProgress() {
            const commits = getFilteredCommits();

            // === Work Summary Cards ===
            // Count tags across all commits
            let featureCount = 0, bugfixCount = 0, refactorCount = 0;
            let complexitySum = 0, complexityCount = 0;

            commits.forEach(commit => {
                const tags = getCommitTags(commit);
                if (tags.includes('feature')) featureCount++;
                if (tags.includes('bugfix') || tags.includes('fix')) bugfixCount++;
                if (tags.includes('refactor')) refactorCount++;
                if (commit.complexity != null) {
                    complexitySum += commit.complexity;
                    complexityCount++;
                }
            });

            document.getElementById('work-features').textContent = featureCount;
            document.getElementById('work-bugfixes').textContent = bugfixCount;
            document.getElementById('work-refactors').textContent = refactorCount;
            document.getElementById('work-avg-complexity').textContent =
                complexityCount > 0 ? (complexitySum / complexityCount).toFixed(1) : '-';

            // Add click handlers for work cards (only once)
            if (!workCardHandlersInitialized) {
                workCardHandlersInitialized = true;
                document.querySelectorAll('[data-work-card]').forEach(el => {
                    el.addEventListener('click', () => {
                        const cardType = el.dataset.workCard;
                        const currentCommits = getFilteredCommits();
                        let filtered, title;

                        if (cardType === 'features') {
                            filtered = currentCommits.filter(c => (c.tags || []).includes('feature'));
                            title = 'Feature Commits';
                        } else if (cardType === 'bugfixes') {
                            filtered = currentCommits.filter(c =>
                                (c.tags || []).includes('bugfix') || (c.tags || []).includes('fix')
                            );
                            title = 'Bug Fix Commits';
                        } else if (cardType === 'refactors') {
                            filtered = currentCommits.filter(c => (c.tags || []).includes('refactor'));
                            title = 'Refactor Commits';
                        }

                        if (filtered) {
                            openDetailPane(title, `${filtered.length} commits`, filtered);
                        }
                    });
                });
            }

            // Get months from filtered commits
            const monthSet = new Set(commits.map(c => c.timestamp?.substring(0, 7)).filter(Boolean));
            const months = [...monthSet].sort();

            // Feature vs Bug Fix Trend
            const monthlyTagCounts = {};
            const monthlyComplexity = {};
            commits.forEach(commit => {
                const month = commit.timestamp?.substring(0, 7);
                if (!month) return;
                if (!monthlyTagCounts[month]) monthlyTagCounts[month] = { feature: 0, bugfix: 0 };
                if (!monthlyComplexity[month]) monthlyComplexity[month] = { total: 0, count: 0 };
                const tags = getCommitTags(commit);
                if (tags.includes('feature')) monthlyTagCounts[month].feature++;
                if (tags.includes('bugfix')) monthlyTagCounts[month].bugfix++;
                if (commit.complexity != null) {
                    monthlyComplexity[month].total += commit.complexity;
                    monthlyComplexity[month].count++;
                }
            });
            const featData = months.map(m => monthlyTagCounts[m]?.feature || 0);
            const fixData = months.map(m => monthlyTagCounts[m]?.bugfix || 0);

            if (charts.featFix) charts.featFix.destroy();
            charts.featFix = new Chart(document.getElementById('feat-fix-chart'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Features',
                            data: featData,
                            borderColor: '#16A34A',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Bug Fixes',
                            data: fixData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Complexity Over Time
            const complexityData = months.map(m => {
                const mc = monthlyComplexity[m];
                return mc && mc.count > 0 ? (mc.total / mc.count) : null;
            });

            if (charts.complexityTrend) charts.complexityTrend.destroy();
            charts.complexityTrend = new Chart(document.getElementById('complexity-trend-chart'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Avg Complexity',
                        data: complexityData,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            min: 1,
                            max: 5,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        // === Contributors Tab ===
        function renderContributors() {
            const commits = getFilteredCommits();
            const config = getViewConfig();

            // Use aggregation layer for view-level-appropriate grouping
            const aggregated = aggregateContributors(commits);

            // Who Does What - work type breakdown (cards)
            // Different granularity based on view level:
            // - executive: single "All Contributors" card
            // - management: one card per repo
            // - developer: one card per person (current behavior)
            const workTypesHtml = aggregated.slice(0, 8).map(item => {
                const totalTags = Object.values(item.breakdown).reduce((s, v) => s + v, 0);
                const tagBars = Object.entries(item.breakdown)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([tag, count]) => {
                        const pct = totalTags > 0 ? Math.round((count / totalTags) * 100) : 0;
                        return `<div class="flex items-center gap-2">
                            <span class="tag ${getTagClass(tag)}" style="${getTagStyle(tag)}">${tag}</span>
                            <div class="flex-1 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                <div class="h-2 rounded-full" style="width: ${pct}%; background-color: ${getTagColor(tag)}"></div>
                            </div>
                            <span class="text-xs text-themed-tertiary w-8">${pct}%</span>
                        </div>`;
                    }).join('');
                return `
                    <div class="p-3 bg-themed-tertiary rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" data-drilldown-label="${escapeHtml(item.label)}">
                        <p class="font-medium text-themed-primary mb-1">${escapeHtml(item.displayName)}</p>
                        <p class="text-xs text-themed-tertiary mb-2">${item.count} commits</p>
                        <div class="space-y-1">${tagBars}</div>
                    </div>
                `;
            }).join('');
            document.getElementById('contributor-work-types').innerHTML = workTypesHtml || '<p class="text-themed-tertiary">No contributor data</p>';

            // Add click handlers for cards - drilldown changes by view level
            document.querySelectorAll('[data-drilldown-label]').forEach(el => {
                el.addEventListener('click', () => {
                    const label = el.dataset.drilldownLabel;
                    const item = aggregated.find(a => a.label === label);
                    if (!item) return;

                    // Get commits for this item based on view level
                    let relevantCommits;
                    if (config.contributors === 'total') {
                        relevantCommits = commits;
                    } else if (config.contributors === 'repo') {
                        relevantCommits = commits.filter(c => (c.repo_id || 'default') === label);
                    } else {
                        relevantCommits = commits.filter(c => getAuthorEmail(c) === label);
                    }

                    openDetailPane(item.displayName, `${item.count} commits`, relevantCommits);
                });
            });

            // Complexity chart - same shape, different labels based on view level
            const top8 = aggregated.slice(0, 8);
            const chartLabels = top8.map(item => {
                // Truncate long labels for chart
                const name = item.displayName;
                return name.length > 20 ? name.substring(0, 17) + '...' : name;
            });
            const avgComplexities = top8.map(item => {
                if (!item.complexities || item.complexities.length === 0) return 0;
                return item.complexities.reduce((a, b) => a + b, 0) / item.complexities.length;
            });

            if (charts.contributorComplexity) charts.contributorComplexity.destroy();
            charts.contributorComplexity = new Chart(document.getElementById('contributor-complexity-chart'), {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Avg Complexity',
                        data: avgComplexities,
                        backgroundColor: avgComplexities.map(c => c >= 3.5 ? '#8b5cf6' : c >= 2.5 ? '#2D68FF' : '#94a3b8')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { min: 0, max: 5, ticks: { stepSize: 1 } }
                    }
                }
            });
        }

        // === Security Tab ===
        function renderSecurity() {
            const commits = getFilteredCommits();
            const config = getViewConfig();

            // Use security_events from summary if available, otherwise compute
            let securityCommits;
            if (data.summary?.security_events?.length > 0) {
                // Map security_events back to full commits for display
                const securityShas = new Set(data.summary.security_events.map(e => e.sha));
                securityCommits = commits.filter(c => securityShas.has(c.sha));
            } else {
                securityCommits = commits.filter(c =>
                    c.type === 'security' || (c.tags || []).includes('security')
                );
            }

            let listHtml;

            if (config.contributors === 'total') {
                // Executive view: show summary stats only
                if (securityCommits.length === 0) {
                    listHtml = '<p class="text-themed-tertiary text-center py-8">No security-related commits found</p>';
                } else {
                    const dateRange = getCommitDateRange(securityCommits);
                    const repos = [...new Set(securityCommits.map(c => c.repo_id).filter(Boolean))];
                    listHtml = `
                        <div class="p-6 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
                            <div class="text-center">
                                <div class="text-4xl font-bold text-red-600 dark:text-red-400 mb-2">${securityCommits.length}</div>
                                <div class="text-sm text-themed-secondary mb-4">Security-related commits</div>
                                <div class="text-xs text-themed-tertiary">
                                    ${dateRange.earliest}  ${dateRange.latest}
                                    ${repos.length > 0 ? `<br>Across ${repos.length} repositories` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else if (config.contributors === 'repo') {
                // Management view: show counts per repo
                if (securityCommits.length === 0) {
                    listHtml = '<p class="text-themed-tertiary text-center py-8">No security-related commits found</p>';
                } else {
                    const byRepo = {};
                    securityCommits.forEach(c => {
                        const repo = c.repo_id || 'default';
                        byRepo[repo] = (byRepo[repo] || 0) + 1;
                    });
                    const sortedRepos = Object.entries(byRepo).sort((a, b) => b[1] - a[1]);

                    listHtml = `
                        <div class="p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg mb-4">
                            <div class="text-center mb-4">
                                <div class="text-3xl font-bold text-red-600 dark:text-red-400">${securityCommits.length}</div>
                                <div class="text-sm text-themed-secondary">Total security commits</div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            ${sortedRepos.map(([repo, count]) => `
                                <div class="p-3 bg-themed-tertiary rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" data-security-repo="${escapeHtml(repo)}">
                                    <div class="flex justify-between items-center">
                                        <span class="text-themed-primary font-medium">${escapeHtml(repo)}</span>
                                        <span class="text-red-600 dark:text-red-400 font-semibold">${count} commits</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;

                    // Add click handlers after rendering
                    setTimeout(() => {
                        document.querySelectorAll('[data-security-repo]').forEach(el => {
                            el.addEventListener('click', () => {
                                const repo = el.dataset.securityRepo;
                                const filtered = securityCommits.filter(c => (c.repo_id || 'default') === repo);
                                openDetailPane(`${repo} Security`, `${filtered.length} commits`, filtered);
                            });
                        });
                    }, 0);
                }
            } else {
                // Developer view: show full commit details (original behavior)
                listHtml = securityCommits.length > 0
                    ? securityCommits.map(commit => `
                        <div class="p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
                            <div class="flex items-start gap-3">
                                <span class="tag tag-security">security</span>
                                <div class="flex-1">
                                    <p class="font-medium text-themed-primary">${escapeHtml(sanitizeMessage(getCommitSubject(commit)))}</p>
                                    <p class="text-sm text-themed-secondary mt-1">${isSanitized ? '[Details hidden]' : (escapeHtml(commit.body || '').substring(0, 200) || 'No description')}</p>
                                    <p class="text-xs text-themed-tertiary mt-2">
                                        ${commit.sha} by ${escapeHtml(getAuthorName(commit))} on ${formatDate(commit.timestamp)}
                                        ${commit.repo_id ? `in ${commit.repo_id}` : ''}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `).join('')
                    : '<p class="text-themed-tertiary text-center py-8">No security-related commits found</p>';
            }

            document.getElementById('security-list').innerHTML = listHtml;
        }

        // === Health Tab (Urgency & Impact) ===
        let healthCardHandlersInitialized = false;

        function renderHealth() {
            const commits = getFilteredCommits();
            const total = commits.length;

            // Security count
            const securityCount = commits.filter(c =>
                c.type === 'security' || (c.tags || []).includes('security')
            ).length;
            document.getElementById('health-security-count').textContent = securityCount;

            // Reactive percentage (urgency 4-5)
            const reactiveCount = commits.filter(c => c.urgency >= 4).length;
            const reactivePct = total > 0 ? Math.round((reactiveCount / total) * 100) : 0;
            document.getElementById('health-reactive-pct').textContent = `${reactivePct}%`;

            // Weekend percentage
            const weekendCount = commits.filter(c => {
                if (!c.timestamp) return false;
                const date = new Date(c.timestamp);
                const day = date.getDay();
                return day === 0 || day === 6;
            }).length;
            const weekendPct = total > 0 ? Math.round((weekendCount / total) * 100) : 0;
            document.getElementById('health-weekend-pct').textContent = `${weekendPct}%`;

            // After hours percentage
            const afterHoursCount = commits.filter(c => {
                if (!c.timestamp) return false;
                const date = new Date(c.timestamp);
                const hour = date.getHours();
                return hour < workHourStart || hour >= workHourEnd;
            }).length;
            const afterHoursPct = total > 0 ? Math.round((afterHoursCount / total) * 100) : 0;
            document.getElementById('health-afterhours-pct').textContent = `${afterHoursPct}%`;

            // Urgency breakdown
            const urgencyBreakdown = { planned: 0, normal: 0, reactive: 0 };
            commits.forEach(c => {
                if (c.urgency <= 2) urgencyBreakdown.planned++;
                else if (c.urgency === 3) urgencyBreakdown.normal++;
                else if (c.urgency >= 4) urgencyBreakdown.reactive++;
            });

            const urgencyHtml = [
                { label: 'Planned (1-2)', count: urgencyBreakdown.planned, color: 'bg-green-500', filter: 'planned' },
                { label: 'Normal (3)', count: urgencyBreakdown.normal, color: 'bg-blue-500', filter: 'normal' },
                { label: 'Reactive (4-5)', count: urgencyBreakdown.reactive, color: 'bg-amber-500', filter: 'reactive' }
            ].map(({ label, count, color, filter }) => {
                const pct = total > 0 ? Math.round((count / total) * 100) : 0;
                return `
                    <div class="cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 rounded p-2 -m-2 transition-colors" data-urgency-filter="${filter}">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-themed-secondary">${label}</span>
                            <span class="text-themed-primary font-medium">${count} (${pct}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                            <div class="${color} h-2 rounded-full" style="width: ${pct}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('urgency-breakdown').innerHTML = urgencyHtml;

            // Add click handlers for urgency bars
            document.querySelectorAll('[data-urgency-filter]').forEach(el => {
                el.addEventListener('click', () => {
                    const filter = el.dataset.urgencyFilter;
                    let filterFn, title;
                    if (filter === 'planned') {
                        filterFn = c => c.urgency <= 2;
                        title = 'Planned Work (Urgency 1-2)';
                    } else if (filter === 'normal') {
                        filterFn = c => c.urgency === 3;
                        title = 'Normal Work (Urgency 3)';
                    } else {
                        filterFn = c => c.urgency >= 4;
                        title = 'Reactive Work (Urgency 4-5)';
                    }
                    const filtered = getFilteredCommits().filter(filterFn);
                    openDetailPane(title, `${filtered.length} commits`, filtered);
                });
            });

            // Impact breakdown
            const impactBreakdown = { 'user-facing': 0, 'internal': 0, 'infrastructure': 0, 'api': 0 };
            commits.forEach(c => {
                if (c.impact && impactBreakdown.hasOwnProperty(c.impact)) {
                    impactBreakdown[c.impact]++;
                }
            });

            const impactLabels = {
                'user-facing': { label: 'User-Facing', color: 'bg-blue-500' },
                'internal': { label: 'Internal', color: 'bg-gray-500' },
                'infrastructure': { label: 'Infrastructure', color: 'bg-purple-500' },
                'api': { label: 'API', color: 'bg-green-500' }
            };

            const impactHtml = Object.entries(impactBreakdown)
                .sort((a, b) => b[1] - a[1])
                .map(([key, count]) => {
                    const { label, color } = impactLabels[key] || { label: key, color: 'bg-gray-400' };
                    const pct = total > 0 ? Math.round((count / total) * 100) : 0;
                    return `
                        <div class="cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 rounded p-2 -m-2 transition-colors" data-impact-filter="${key}">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-themed-secondary">${label}</span>
                                <span class="text-themed-primary font-medium">${count} (${pct}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                <div class="${color} h-2 rounded-full" style="width: ${pct}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            document.getElementById('impact-breakdown').innerHTML = impactHtml;

            // Add click handlers for impact bars
            document.querySelectorAll('[data-impact-filter]').forEach(el => {
                el.addEventListener('click', () => {
                    const impact = el.dataset.impactFilter;
                    const label = impactLabels[impact]?.label || impact;
                    const filtered = getFilteredCommits().filter(c => c.impact === impact);
                    openDetailPane(`${label} Impact`, `${filtered.length} commits`, filtered);
                });
            });

            // Urgency Trend Chart (line chart by month)
            const monthlyUrgency = {};
            commits.forEach(c => {
                if (!c.timestamp || !c.urgency) return;
                const month = c.timestamp.substring(0, 7);
                if (!monthlyUrgency[month]) {
                    monthlyUrgency[month] = { sum: 0, count: 0 };
                }
                monthlyUrgency[month].sum += c.urgency;
                monthlyUrgency[month].count++;
            });

            const sortedMonths = Object.keys(monthlyUrgency).sort();
            const urgencyData = sortedMonths.map(m =>
                Math.round((monthlyUrgency[m].sum / monthlyUrgency[m].count) * 100) / 100
            );

            if (charts.urgencyTrend) charts.urgencyTrend.destroy();
            charts.urgencyTrend = new Chart(document.getElementById('urgency-trend-chart'), {
                type: 'line',
                data: {
                    labels: sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                    }),
                    datasets: [{
                        label: 'Avg Urgency',
                        data: urgencyData,
                        borderColor: '#EAB308',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { min: 1, max: 5, ticks: { stepSize: 1 } }
                    }
                }
            });

            // Impact Over Time Chart (stacked bar)
            const monthlyImpact = {};
            commits.forEach(c => {
                if (!c.timestamp || !c.impact) return;
                const month = c.timestamp.substring(0, 7);
                if (!monthlyImpact[month]) {
                    monthlyImpact[month] = { 'user-facing': 0, 'internal': 0, 'infrastructure': 0, 'api': 0 };
                }
                if (monthlyImpact[month].hasOwnProperty(c.impact)) {
                    monthlyImpact[month][c.impact]++;
                }
            });

            const impactColors = {
                'user-facing': '#2D68FF',
                'internal': '#767676',
                'infrastructure': '#a78bfa',
                'api': '#16A34A'
            };

            if (charts.impactTrend) charts.impactTrend.destroy();
            charts.impactTrend = new Chart(document.getElementById('impact-trend-chart'), {
                type: 'bar',
                data: {
                    labels: sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                    }),
                    datasets: ['user-facing', 'internal', 'infrastructure', 'api'].map(impact => ({
                        label: impact,
                        data: sortedMonths.map(m => monthlyImpact[m]?.[impact] || 0),
                        backgroundColor: impactColors[impact]
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } },
                    scales: { x: { stacked: true }, y: { stacked: true } }
                }
            });

            // Urgency by Contributor (or aggregated based on view level)
            const config = getViewConfig();

            if (config.contributors === 'total') {
                // Executive view: show single aggregated bar
                const plannedPct = total > 0 ? Math.round((urgencyBreakdown.planned / total) * 100) : 0;
                const normalPct = total > 0 ? Math.round((urgencyBreakdown.normal / total) * 100) : 0;
                const reactivePct = total > 0 ? Math.round((urgencyBreakdown.reactive / total) * 100) : 0;

                const urgencyByContributorHtml = `
                    <div class="p-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-themed-secondary font-medium">All Contributors</span>
                            <span class="text-themed-tertiary">${total} commits</span>
                        </div>
                        <div class="w-full h-3 bg-gray-200 dark:bg-gray-600 rounded-full flex overflow-hidden">
                            <div class="bg-green-500 h-full" style="width: ${plannedPct}%" title="Planned: ${urgencyBreakdown.planned}"></div>
                            <div class="bg-blue-500 h-full" style="width: ${normalPct}%" title="Normal: ${urgencyBreakdown.normal}"></div>
                            <div class="bg-amber-500 h-full" style="width: ${reactivePct}%" title="Reactive: ${urgencyBreakdown.reactive}"></div>
                        </div>
                        <div class="flex justify-between text-xs text-themed-tertiary mt-1">
                            <span>Planned ${plannedPct}%</span>
                            <span>Normal ${normalPct}%</span>
                            <span>Reactive ${reactivePct}%</span>
                        </div>
                    </div>
                `;
                document.getElementById('urgency-by-contributor').innerHTML = urgencyByContributorHtml;
            } else if (config.contributors === 'repo') {
                // Management view: show by repo
                const repoUrgency = {};
                commits.forEach(c => {
                    const repo = c.repo_id || 'default';
                    if (!repoUrgency[repo]) {
                        repoUrgency[repo] = { planned: 0, normal: 0, reactive: 0, total: 0 };
                    }
                    repoUrgency[repo].total++;
                    if (c.urgency <= 2) repoUrgency[repo].planned++;
                    else if (c.urgency === 3) repoUrgency[repo].normal++;
                    else if (c.urgency >= 4) repoUrgency[repo].reactive++;
                });

                const sortedRepos = Object.entries(repoUrgency)
                    .sort((a, b) => b[1].total - a[1].total)
                    .slice(0, 6);

                const urgencyByContributorHtml = sortedRepos.map(([repo, data]) => {
                    const plannedPct = Math.round((data.planned / data.total) * 100);
                    const normalPct = Math.round((data.normal / data.total) * 100);
                    const reactivePct = Math.round((data.reactive / data.total) * 100);
                    return `
                        <div class="cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 rounded p-2 -m-2 transition-colors" data-repo-urgency="${escapeHtml(repo)}">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-themed-secondary font-medium">${escapeHtml(repo)}</span>
                                <span class="text-themed-tertiary">${data.total} commits</span>
                            </div>
                            <div class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-full flex overflow-hidden">
                                <div class="bg-green-500 h-full" style="width: ${plannedPct}%" title="Planned: ${data.planned}"></div>
                                <div class="bg-blue-500 h-full" style="width: ${normalPct}%" title="Normal: ${data.normal}"></div>
                                <div class="bg-amber-500 h-full" style="width: ${reactivePct}%" title="Reactive: ${data.reactive}"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                document.getElementById('urgency-by-contributor').innerHTML = urgencyByContributorHtml || '<p class="text-themed-tertiary text-sm">No data</p>';

                // Click handlers for repo urgency
                document.querySelectorAll('[data-repo-urgency]').forEach(el => {
                    el.addEventListener('click', () => {
                        const repo = el.dataset.repoUrgency;
                        const filtered = getFilteredCommits().filter(c => (c.repo_id || 'default') === repo);
                        openDetailPane(`${repo}`, `${filtered.length} commits`, filtered);
                    });
                });
            } else {
                // Developer view: show by individual contributor (original behavior)
                const contributorUrgency = {};
                commits.forEach(c => {
                    const email = getAuthorEmail(c);
                    const name = getAuthorName(c);
                    if (!contributorUrgency[email]) {
                        contributorUrgency[email] = { name, email, planned: 0, normal: 0, reactive: 0, total: 0 };
                    }
                    contributorUrgency[email].total++;
                    if (c.urgency <= 2) contributorUrgency[email].planned++;
                    else if (c.urgency === 3) contributorUrgency[email].normal++;
                    else if (c.urgency >= 4) contributorUrgency[email].reactive++;
                });

                const sortedContributors = Object.values(contributorUrgency)
                    .sort((a, b) => b.total - a.total)
                    .slice(0, 6);

                const urgencyByContributorHtml = sortedContributors.map(c => {
                    const plannedPct = Math.round((c.planned / c.total) * 100);
                    const normalPct = Math.round((c.normal / c.total) * 100);
                    const reactivePct = Math.round((c.reactive / c.total) * 100);
                    return `
                        <div class="cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 rounded p-2 -m-2 transition-colors" data-contributor-urgency="${escapeHtml(c.email)}">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-themed-secondary font-medium">${escapeHtml(sanitizeName(c.name, c.email))}</span>
                                <span class="text-themed-tertiary">${c.total} commits</span>
                            </div>
                            <div class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-full flex overflow-hidden">
                                <div class="bg-green-500 h-full" style="width: ${plannedPct}%" title="Planned: ${c.planned}"></div>
                                <div class="bg-blue-500 h-full" style="width: ${normalPct}%" title="Normal: ${c.normal}"></div>
                                <div class="bg-amber-500 h-full" style="width: ${reactivePct}%" title="Reactive: ${c.reactive}"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                document.getElementById('urgency-by-contributor').innerHTML = urgencyByContributorHtml || '<p class="text-themed-tertiary text-sm">No data</p>';

                // Click handlers for urgency by contributor
                document.querySelectorAll('[data-contributor-urgency]').forEach(el => {
                    el.addEventListener('click', () => {
                        const email = el.dataset.contributorUrgency;
                        const filtered = getFilteredCommits().filter(c => getAuthorEmail(c) === email);
                        const name = filtered.length > 0 ? sanitizeName(getAuthorName(filtered[0]), email) : 'Unknown';
                        openDetailPane(`${name}'s Commits`, `${filtered.length} commits`, filtered);
                    });
                });
            }

            // Impact by Contributor (or aggregated based on view level)
            if (config.contributors === 'total') {
                // Executive view: show single aggregated bar
                const userPct = total > 0 ? Math.round((impactBreakdown['user-facing'] / total) * 100) : 0;
                const internalPct = total > 0 ? Math.round((impactBreakdown['internal'] / total) * 100) : 0;
                const infraPct = total > 0 ? Math.round((impactBreakdown['infrastructure'] / total) * 100) : 0;
                const apiPct = total > 0 ? Math.round((impactBreakdown['api'] / total) * 100) : 0;

                const impactByContributorHtml = `
                    <div class="p-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-themed-secondary font-medium">All Contributors</span>
                            <span class="text-themed-tertiary">${total} commits</span>
                        </div>
                        <div class="w-full h-3 bg-gray-200 dark:bg-gray-600 rounded-full flex overflow-hidden">
                            <div class="bg-blue-500 h-full" style="width: ${userPct}%" title="User-facing: ${impactBreakdown['user-facing']}"></div>
                            <div class="bg-gray-500 h-full" style="width: ${internalPct}%" title="Internal: ${impactBreakdown['internal']}"></div>
                            <div class="bg-purple-500 h-full" style="width: ${infraPct}%" title="Infrastructure: ${impactBreakdown['infrastructure']}"></div>
                            <div class="bg-green-500 h-full" style="width: ${apiPct}%" title="API: ${impactBreakdown['api']}"></div>
                        </div>
                        <div class="flex justify-between text-xs text-themed-tertiary mt-1">
                            <span>User ${userPct}%</span>
                            <span>Internal ${internalPct}%</span>
                            <span>Infra ${infraPct}%</span>
                            <span>API ${apiPct}%</span>
                        </div>
                    </div>
                `;
                document.getElementById('impact-by-contributor').innerHTML = impactByContributorHtml;
            } else if (config.contributors === 'repo') {
                // Management view: show by repo
                const repoImpact = {};
                commits.forEach(c => {
                    const repo = c.repo_id || 'default';
                    if (!repoImpact[repo]) {
                        repoImpact[repo] = { 'user-facing': 0, 'internal': 0, 'infrastructure': 0, 'api': 0, total: 0 };
                    }
                    repoImpact[repo].total++;
                    if (c.impact && repoImpact[repo].hasOwnProperty(c.impact)) {
                        repoImpact[repo][c.impact]++;
                    }
                });

                const sortedReposImpact = Object.entries(repoImpact)
                    .sort((a, b) => b[1].total - a[1].total)
                    .slice(0, 6);

                const impactByContributorHtml = sortedReposImpact.map(([repo, data]) => {
                    const userPct = Math.round((data['user-facing'] / data.total) * 100);
                    const internalPct = Math.round((data['internal'] / data.total) * 100);
                    const infraPct = Math.round((data['infrastructure'] / data.total) * 100);
                    const apiPct = Math.round((data['api'] / data.total) * 100);
                    return `
                        <div class="cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 rounded p-2 -m-2 transition-colors" data-repo-impact="${escapeHtml(repo)}">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-themed-secondary font-medium">${escapeHtml(repo)}</span>
                                <span class="text-themed-tertiary">${data.total} commits</span>
                            </div>
                            <div class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-full flex overflow-hidden">
                                <div class="bg-blue-500 h-full" style="width: ${userPct}%" title="User-facing: ${data['user-facing']}"></div>
                                <div class="bg-gray-500 h-full" style="width: ${internalPct}%" title="Internal: ${data['internal']}"></div>
                                <div class="bg-purple-500 h-full" style="width: ${infraPct}%" title="Infrastructure: ${data['infrastructure']}"></div>
                                <div class="bg-green-500 h-full" style="width: ${apiPct}%" title="API: ${data['api']}"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                document.getElementById('impact-by-contributor').innerHTML = impactByContributorHtml || '<p class="text-themed-tertiary text-sm">No data</p>';

                // Click handlers for repo impact
                document.querySelectorAll('[data-repo-impact]').forEach(el => {
                    el.addEventListener('click', () => {
                        const repo = el.dataset.repoImpact;
                        const filtered = getFilteredCommits().filter(c => (c.repo_id || 'default') === repo);
                        openDetailPane(`${repo}`, `${filtered.length} commits`, filtered);
                    });
                });
            } else {
                // Developer view: show by individual contributor (original behavior)
                const contributorImpact = {};
                commits.forEach(c => {
                    const email = getAuthorEmail(c);
                    const name = getAuthorName(c);
                    if (!contributorImpact[email]) {
                        contributorImpact[email] = { name, email, 'user-facing': 0, 'internal': 0, 'infrastructure': 0, 'api': 0, total: 0 };
                    }
                    contributorImpact[email].total++;
                    if (c.impact && contributorImpact[email].hasOwnProperty(c.impact)) {
                        contributorImpact[email][c.impact]++;
                    }
                });

                const sortedContributorsImpact = Object.values(contributorImpact)
                    .sort((a, b) => b.total - a.total)
                    .slice(0, 6);

                const impactByContributorHtml = sortedContributorsImpact.map(c => {
                    const userPct = Math.round((c['user-facing'] / c.total) * 100);
                    const internalPct = Math.round((c['internal'] / c.total) * 100);
                    const infraPct = Math.round((c['infrastructure'] / c.total) * 100);
                    const apiPct = Math.round((c['api'] / c.total) * 100);
                    return `
                        <div class="cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 rounded p-2 -m-2 transition-colors" data-contributor-impact="${escapeHtml(c.email)}">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-themed-secondary font-medium">${escapeHtml(sanitizeName(c.name, c.email))}</span>
                                <span class="text-themed-tertiary">${c.total} commits</span>
                            </div>
                            <div class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-full flex overflow-hidden">
                                <div class="bg-blue-500 h-full" style="width: ${userPct}%" title="User-facing: ${c['user-facing']}"></div>
                                <div class="bg-gray-500 h-full" style="width: ${internalPct}%" title="Internal: ${c['internal']}"></div>
                                <div class="bg-purple-500 h-full" style="width: ${infraPct}%" title="Infrastructure: ${c['infrastructure']}"></div>
                                <div class="bg-green-500 h-full" style="width: ${apiPct}%" title="API: ${c['api']}"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                document.getElementById('impact-by-contributor').innerHTML = impactByContributorHtml || '<p class="text-themed-tertiary text-sm">No data</p>';

                // Click handlers for impact by contributor
                document.querySelectorAll('[data-contributor-impact]').forEach(el => {
                    el.addEventListener('click', () => {
                        const email = el.dataset.contributorImpact;
                        const filtered = getFilteredCommits().filter(c => getAuthorEmail(c) === email);
                        const name = filtered.length > 0 ? sanitizeName(getAuthorName(filtered[0]), email) : 'Unknown';
                        openDetailPane(`${name}'s Commits`, `${filtered.length} commits`, filtered);
                    });
                });
            }

            // Add click handlers for health cards (only once, using dynamic data)
            if (!healthCardHandlersInitialized) {
                healthCardHandlersInitialized = true;
                document.querySelectorAll('[data-health-card]').forEach(el => {
                    el.addEventListener('click', () => {
                        const cardType = el.dataset.healthCard;
                        // Get filtered commits dynamically (respects current filters)
                        const currentCommits = getFilteredCommits();
                        let filteredCommits, title;

                        if (cardType === 'security') {
                            filteredCommits = currentCommits.filter(c =>
                                c.type === 'security' || (c.tags || []).includes('security')
                            );
                            title = 'Security Commits';
                        } else if (cardType === 'reactive') {
                            filteredCommits = currentCommits.filter(c => c.urgency >= 4);
                            title = 'Reactive Work (Urgency 4-5)';
                        } else if (cardType === 'weekend') {
                            filteredCommits = currentCommits.filter(c => {
                                if (!c.timestamp) return false;
                                const date = new Date(c.timestamp);
                                const day = date.getDay();
                                return day === 0 || day === 6;
                            });
                            title = 'Weekend Commits';
                        } else if (cardType === 'afterhours') {
                            filteredCommits = currentCommits.filter(c => {
                                if (!c.timestamp) return false;
                                const date = new Date(c.timestamp);
                                const hour = date.getHours();
                                return hour < workHourStart || hour >= workHourEnd;
                            });
                            title = 'After Hours Commits';
                        }

                        if (filteredCommits) {
                            openDetailPane(title, `${filteredCommits.length} commits`, filteredCommits);
                        }
                    });
                });
            }
        }

        // === Tags Tab ===
        function renderTags() {
            const commits = getFilteredCommits();
            // Build tag breakdown from commits (counting each tag occurrence)
            const tagBreakdown = {};
            commits.forEach(commit => {
                const tags = getCommitTags(commit);
                tags.forEach(tag => {
                    tagBreakdown[tag] = (tagBreakdown[tag] || 0) + 1;
                });
            });

            // Sort tags by count (descending) for consistent display
            const sortedTags = Object.entries(tagBreakdown)
                .map(([tag, count]) => ({ tag, count }))
                .sort((a, b) => b.count - a.count);

            const tags = sortedTags.map(t => t.tag);
            const counts = sortedTags.map(t => t.count);
            const colors = tags.map(t => getTagColor(t));
            const total = counts.reduce((a, b) => a + b, 0);

            // Tags Pie Chart
            if (charts.tags) charts.tags.destroy();
            charts.tags = new Chart(document.getElementById('tags-chart'), {
                type: 'doughnut',
                data: {
                    labels: tags,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 8,
                                font: { size: 11 },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: `${label} (${data.datasets[0].data[i]})`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        hidden: false,
                                        index: i
                                    }));
                                }
                            }
                        }
                    }
                }
            });

            const breakdownHtml = sortedTags.map(({ tag, count }) => `
                <div class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 rounded p-2 -m-2 transition-colors" data-tag-filter="${tag}">
                    <span class="tag ${getTagClass(tag)}" style="${getTagStyle(tag)}">${tag}</span>
                    <div class="flex-1 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                        <div class="h-2 rounded-full" style="width: ${(count / total * 100).toFixed(1)}%; background-color: ${getTagColor(tag)}"></div>
                    </div>
                    <span class="text-sm text-themed-secondary">${count} (${(count / total * 100).toFixed(1)}%)</span>
                </div>
            `).join('');
            document.getElementById('tag-breakdown').innerHTML = breakdownHtml;

            // Add click handlers for tag bars
            document.querySelectorAll('[data-tag-filter]').forEach(el => {
                el.addEventListener('click', () => {
                    const tag = el.dataset.tagFilter;
                    const filtered = getFilteredCommits().filter(c => (c.tags || []).includes(tag));
                    openDetailPane(`${tag} Commits`, `${filtered.length} commits`, filtered);
                });
            });
        }

        // === Timing Tab ===
        const DAY_NAMES = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const DAY_NAMES_SHORT = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        function getCommitDateTime(commit) {
            const date = new Date(commit.timestamp);
            if (useUTC) {
                return {
                    hour: date.getUTCHours(),
                    dayOfWeek: date.getUTCDay()
                };
            }
            return {
                hour: date.getHours(),
                dayOfWeek: date.getDay()
            };
        }

        function renderTiming() {
            const commits = getFilteredCommits();
            const config = getViewConfig();

            // Render the heatmap (handles its own granularity)
            renderHeatmap();

            // Aggregate commits by hour (0-23)
            const byHour = new Array(24).fill(0);
            // Aggregate commits by day of week (0=Sun, 6=Sat)
            const byDay = new Array(7).fill(0);

            commits.forEach(commit => {
                const { hour, dayOfWeek } = getCommitDateTime(commit);
                byHour[hour]++;
                byDay[dayOfWeek]++;
            });

            // Hour chart - only show for developer view (hourly granularity)
            const hourChartContainer = document.getElementById('hour-chart')?.parentElement?.parentElement;
            if (hourChartContainer) {
                if (config.timing === 'hour') {
                    hourChartContainer.style.display = '';
                } else {
                    hourChartContainer.style.display = 'none';
                }
            }

            // Hour Chart
            const hourLabels = Array.from({ length: 24 }, (_, i) =>
                i.toString().padStart(2, '0') + ':00'
            );

            if (charts.hour) charts.hour.destroy();
            charts.hour = new Chart(document.getElementById('hour-chart'), {
                type: 'bar',
                data: {
                    labels: hourLabels,
                    datasets: [{
                        label: 'Commits',
                        data: byHour,
                        backgroundColor: byHour.map((_, i) =>
                            (i >= workHourStart && i < workHourEnd) ? '#2D68FF' : '#94a3b8'
                        ),
                        borderRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: (ctx) => {
                                    const hour = ctx.dataIndex;
                                    if (hour >= workHourStart && hour < workHourEnd) return 'Work hours';
                                    return 'After hours';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                callback: function(value, index) {
                                    // Show every 3rd label to reduce clutter
                                    return index % 3 === 0 ? this.getLabelForValue(value) : '';
                                }
                            }
                        },
                        y: { beginAtZero: true }
                    }
                }
            });

            // Day of Week Chart - reorder to start with Monday
            const mondayFirstOrder = [1, 2, 3, 4, 5, 6, 0]; // Mon-Sun
            const dayLabels = mondayFirstOrder.map(i => DAY_NAMES_SHORT[i]);
            const dayData = mondayFirstOrder.map(i => byDay[i]);

            if (charts.day) charts.day.destroy();
            charts.day = new Chart(document.getElementById('day-chart'), {
                type: 'bar',
                data: {
                    labels: dayLabels,
                    datasets: [{
                        label: 'Commits',
                        data: dayData,
                        backgroundColor: dayData.map((_, i) =>
                            (i < 5) ? '#2D68FF' : '#94a3b8'  // Mon-Fri blue, Sat-Sun gray
                        ),
                        borderRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: (ctx) => {
                                    return ctx.dataIndex < 5 ? 'Weekday' : 'Weekend';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Render developer activity patterns - only for developer view
            const devPatternsContainer = document.querySelector('[data-section="developer-patterns"]');
            if (devPatternsContainer) {
                if (config.timing === 'hour') {
                    devPatternsContainer.style.display = '';
                    renderDeveloperPatterns();
                } else {
                    devPatternsContainer.style.display = 'none';
                }
            }
        }

        function renderHeatmap() {
            const commits = getFilteredCommits();
            const config = getViewConfig();

            // Different granularity based on view level
            if (config.timing === 'week') {
                renderWeeklyHeatmap(commits);
                return;
            } else if (config.timing === 'day') {
                renderDailyHeatmap(commits);
                return;
            }

            // Developer view: full 24x7 hourly heatmap (current behavior)
            // Build 24x7 matrix (hours x days)
            const matrix = Array.from({ length: 24 }, () => new Array(7).fill(0));

            commits.forEach(commit => {
                const { hour, dayOfWeek } = getCommitDateTime(commit);
                matrix[hour][dayOfWeek]++;
            });

            // Find max for intensity scaling
            const maxCount = Math.max(...matrix.flat(), 1);

            // Get intensity level (0-4)
            const getIntensity = (count) => {
                if (count === 0) return 0;
                const ratio = count / maxCount;
                if (ratio <= 0.25) return 1;
                if (ratio <= 0.5) return 2;
                if (ratio <= 0.75) return 3;
                return 4;
            };

            // Reorder to Monday-first
            const dayOrder = [1, 2, 3, 4, 5, 6, 0]; // Mon-Sun
            const dayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

            // Build HTML
            let html = '';

            // Header row (empty corner + day names)
            html += '<div class="heatmap-label"></div>';
            dayLabels.forEach(day => {
                html += `<div class="heatmap-header">${day}</div>`;
            });

            // Data rows (hour label + cells)
            for (let hour = 0; hour < 24; hour++) {
                // Hour label (show every 3 hours)
                const hourLabel = hour % 3 === 0 ? `${hour.toString().padStart(2, '0')}:00` : '';
                html += `<div class="heatmap-label">${hourLabel}</div>`;

                // Day cells
                dayOrder.forEach((dayIdx, i) => {
                    const count = matrix[hour][dayIdx];
                    const intensity = getIntensity(count);
                    const isWorkHours = hour >= 8 && hour < 17;
                    const isWeekday = i < 5;
                    const tooltip = `${dayLabels[i]} ${hour}:00 - ${count} commit${count !== 1 ? 's' : ''}`;

                    html += `<div class="heatmap-cell heatmap-${intensity}" title="${tooltip}">${count || ''}</div>`;
                });
            }

            document.getElementById('heatmap').innerHTML = html;
        }

        /**
         * Weekly heatmap for Executive view
         * Shows a simplified week-by-week view instead of hourly detail
         */
        function renderWeeklyHeatmap(commits) {
            // Group commits by week
            const byWeek = {};
            commits.forEach(commit => {
                if (!commit.timestamp) return;
                const date = new Date(commit.timestamp);
                // Get ISO week start (Monday)
                const weekStart = new Date(date);
                weekStart.setDate(date.getDate() - ((date.getDay() + 6) % 7));
                const weekKey = weekStart.toISOString().substring(0, 10);
                byWeek[weekKey] = (byWeek[weekKey] || 0) + 1;
            });

            const weeks = Object.entries(byWeek).sort((a, b) => a[0].localeCompare(b[0]));
            const maxCount = Math.max(...weeks.map(w => w[1]), 1);

            const getIntensity = (count) => {
                if (count === 0) return 0;
                const ratio = count / maxCount;
                if (ratio <= 0.25) return 1;
                if (ratio <= 0.5) return 2;
                if (ratio <= 0.75) return 3;
                return 4;
            };

            // Build a grid of weeks (similar to GitHub contribution graph)
            let html = '<div class="weekly-heatmap">';
            html += '<p class="text-xs text-themed-tertiary mb-2">Weekly commit activity (most recent weeks)</p>';
            html += '<div class="flex flex-wrap gap-1">';

            // Show last 26 weeks (half year)
            const recentWeeks = weeks.slice(-26);
            recentWeeks.forEach(([weekKey, count]) => {
                const intensity = getIntensity(count);
                const weekDate = new Date(weekKey);
                const weekLabel = weekDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                html += `<div class="heatmap-cell heatmap-${intensity}" style="width: 16px; height: 16px;" title="Week of ${weekLabel}: ${count} commits">${count > 9 ? '' : count || ''}</div>`;
            });

            html += '</div>';

            // Summary stats
            const totalWeeks = recentWeeks.length;
            const totalCommits = recentWeeks.reduce((sum, [_, c]) => sum + c, 0);
            const avgPerWeek = totalWeeks > 0 ? Math.round(totalCommits / totalWeeks) : 0;
            html += `<p class="text-xs text-themed-tertiary mt-2">${totalCommits} commits over ${totalWeeks} weeks (avg ${avgPerWeek}/week)</p>`;
            html += '</div>';

            document.getElementById('heatmap').innerHTML = html;
        }

        /**
         * Daily heatmap for Management view
         * Shows day-of-week distribution without hourly breakdown
         */
        function renderDailyHeatmap(commits) {
            // Aggregate by day of week
            const byDay = new Array(7).fill(0);
            commits.forEach(commit => {
                const { dayOfWeek } = getCommitDateTime(commit);
                byDay[dayOfWeek]++;
            });

            // Reorder to Monday-first
            const dayOrder = [1, 2, 3, 4, 5, 6, 0]; // Mon-Sun
            const dayLabels = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const maxCount = Math.max(...byDay, 1);

            const getIntensity = (count) => {
                if (count === 0) return 0;
                const ratio = count / maxCount;
                if (ratio <= 0.25) return 1;
                if (ratio <= 0.5) return 2;
                if (ratio <= 0.75) return 3;
                return 4;
            };

            let html = '<div class="daily-heatmap">';
            html += '<p class="text-xs text-themed-tertiary mb-3">Commits by day of week</p>';
            html += '<div class="space-y-2">';

            dayOrder.forEach((dayIdx, i) => {
                const count = byDay[dayIdx];
                const intensity = getIntensity(count);
                const pct = maxCount > 0 ? Math.round((count / maxCount) * 100) : 0;
                const isWeekend = i >= 5;

                html += `
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-themed-secondary w-24">${dayLabels[i]}</span>
                        <div class="flex-1 bg-gray-200 dark:bg-gray-600 rounded-full h-4">
                            <div class="h-4 rounded-full heatmap-${intensity}" style="width: ${pct}%;"></div>
                        </div>
                        <span class="text-sm text-themed-tertiary w-16 text-right">${count} commits</span>
                    </div>
                `;
            });

            html += '</div>';

            // Weekday vs weekend summary
            const weekdayCommits = dayOrder.slice(0, 5).reduce((sum, idx) => sum + byDay[idx], 0);
            const weekendCommits = dayOrder.slice(5).reduce((sum, idx) => sum + byDay[idx], 0);
            const weekendPct = commits.length > 0 ? Math.round((weekendCommits / commits.length) * 100) : 0;

            html += `<p class="text-xs text-themed-tertiary mt-3">Weekday: ${weekdayCommits} | Weekend: ${weekendCommits} (${weekendPct}%)</p>`;
            html += '</div>';

            document.getElementById('heatmap').innerHTML = html;
        }

        function setupTimezoneToggle() {
            document.getElementById('timezone-select').addEventListener('change', (e) => {
                useUTC = e.target.value === 'utc';
                renderTiming();
                saveFiltersToStorage();
            });
        }

        function setupWorkHoursToggle() {
            document.getElementById('work-hour-start').addEventListener('change', (e) => {
                workHourStart = parseInt(e.target.value);
                renderTiming();
                renderTimeline();
                renderSummary();
                saveFiltersToStorage();
            });
            document.getElementById('work-hour-end').addEventListener('change', (e) => {
                workHourEnd = parseInt(e.target.value);
                renderTiming();
                renderTimeline();
                renderSummary();
                saveFiltersToStorage();
            });
        }

        function renderDeveloperPatterns() {
            const commits = getFilteredCommits();
            const config = getViewConfig();

            // Hide the entire section for non-developer views
            const patternSection = document.querySelector('[data-section="developer-patterns"]');
            if (patternSection) {
                if (config.contributors !== 'individual') {
                    patternSection.style.display = 'none';
                    return;
                } else {
                    patternSection.style.display = '';
                }
            }

            // Get per-author timing data
            const authorPatterns = {};

            commits.forEach(commit => {
                const email = getAuthorEmail(commit);
                const name = getAuthorName(commit);
                const { hour, dayOfWeek } = getCommitDateTime(commit);

                if (!authorPatterns[email]) {
                    authorPatterns[email] = {
                        name,
                        email,
                        commitCount: 0,
                        byHour: new Array(24).fill(0),
                        byDay: new Array(7).fill(0),
                        afterHours: 0,
                        weekend: 0
                    };
                }

                authorPatterns[email].commitCount++;
                authorPatterns[email].byHour[hour]++;
                authorPatterns[email].byDay[dayOfWeek]++;

                if (hour < workHourStart || hour >= workHourEnd) {
                    authorPatterns[email].afterHours++;
                }
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    authorPatterns[email].weekend++;
                }
            });

            // Sort by commit count
            const sorted = Object.values(authorPatterns).sort((a, b) => b.commitCount - a.commitCount);

            // Render top contributors
            const html = sorted.slice(0, 6).map(author => {
                // Find peak hour
                const peakHour = author.byHour.indexOf(Math.max(...author.byHour));
                // Find peak day
                const mondayFirstOrder = [1, 2, 3, 4, 5, 6, 0];
                const dayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                const peakDayIdx = author.byDay.indexOf(Math.max(...author.byDay));
                const peakDayLabel = DAY_NAMES_SHORT[peakDayIdx];

                // After hours percentage
                const afterHoursPct = Math.round((author.afterHours / author.commitCount) * 100);
                const weekendPct = Math.round((author.weekend / author.commitCount) * 100);

                // Mini sparkline for hours (simplified - just show work vs after hours)
                const workHoursCommits = author.byHour.slice(workHourStart, workHourEnd).reduce((a, b) => a + b, 0);
                const workHoursPct = Math.round((workHoursCommits / author.commitCount) * 100);

                return `
                    <div class="p-3 bg-themed-tertiary rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-themed-primary">${escapeHtml(author.name)}</span>
                            <span class="text-xs text-themed-tertiary">${author.commitCount} commits</span>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs">
                            <div class="p-2 bg-themed-secondary rounded">
                                <span class="text-themed-tertiary">Peak Hour</span>
                                <p class="font-semibold text-themed-primary">${peakHour.toString().padStart(2, '0')}:00</p>
                            </div>
                            <div class="p-2 bg-themed-secondary rounded">
                                <span class="text-themed-tertiary">Peak Day</span>
                                <p class="font-semibold text-themed-primary">${peakDayLabel}</p>
                            </div>
                            <div class="p-2 bg-themed-secondary rounded">
                                <span class="text-themed-tertiary">Work Hours</span>
                                <p class="font-semibold ${workHoursPct >= 70 ? 'text-green-600' : workHoursPct >= 50 ? 'text-amber-600' : 'text-red-600'}">${workHoursPct}%</p>
                            </div>
                            <div class="p-2 bg-themed-secondary rounded">
                                <span class="text-themed-tertiary">Weekends</span>
                                <p class="font-semibold ${weekendPct <= 10 ? 'text-green-600' : weekendPct <= 25 ? 'text-amber-600' : 'text-red-600'}">${weekendPct}%</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('developer-patterns').innerHTML = html || '<p class="text-themed-tertiary">No contributor data</p>';
        }

        // === Executive Summary Tab ===
        let summaryPeriod = '7days';
        let summaryCardHandlersInitialized = false;

        // Helper to get commits filtered by both global filters AND current summary period
        function getCurrentPeriodCommits() {
            const commits = getFilteredCommits();
            const periods = getPeriodDates(summaryPeriod);
            return getCommitsInRange(commits, periods.current.start, periods.current.end);
        }

        function getPeriodDates(period) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let currentStart, currentEnd, previousStart, previousEnd;

            // Helper to set time to end of day (23:59:59.999)
            function endOfDay(date) {
                const d = new Date(date);
                d.setHours(23, 59, 59, 999);
                return d;
            }

            if (period === '7days') {
                // Rolling last 7 days (including today)
                currentStart = new Date(today);
                currentStart.setDate(today.getDate() - 6);
                currentEnd = endOfDay(today);
                // Previous 7 days before that
                previousStart = new Date(currentStart);
                previousStart.setDate(previousStart.getDate() - 7);
                previousEnd = new Date(currentStart);
                previousEnd.setDate(previousEnd.getDate() - 1);
                previousEnd = endOfDay(previousEnd);
            } else if (period === '30days') {
                // Rolling last 30 days (including today)
                currentStart = new Date(today);
                currentStart.setDate(today.getDate() - 29);
                currentEnd = endOfDay(today);
                // Previous 30 days before that
                previousStart = new Date(currentStart);
                previousStart.setDate(previousStart.getDate() - 30);
                previousEnd = new Date(currentStart);
                previousEnd.setDate(previousEnd.getDate() - 1);
                previousEnd = endOfDay(previousEnd);
            } else { // quarter
                const quarter = Math.floor(today.getMonth() / 3);
                currentStart = new Date(today.getFullYear(), quarter * 3, 1);
                currentEnd = endOfDay(today);
                previousStart = new Date(today.getFullYear(), (quarter - 1) * 3, 1);
                previousEnd = endOfDay(new Date(today.getFullYear(), quarter * 3, 0));
            }

            return {
                current: { start: currentStart, end: currentEnd },
                previous: { start: previousStart, end: previousEnd }
            };
        }

        function getCommitsInRange(commits, start, end) {
            return commits.filter(c => {
                const date = new Date(c.timestamp);
                return date >= start && date <= end;
            });
        }

        function getTrendHtml(current, previous, label) {
            if (previous === 0) {
                return current > 0
                    ? `<span class="text-green-600">+${current} new</span>`
                    : `<span class="text-themed-muted">No change</span>`;
            }
            const change = current - previous;
            const pct = Math.round((change / previous) * 100);
            if (change > 0) {
                return `<span class="text-green-600"> ${pct}% vs ${label}</span>`;
            } else if (change < 0) {
                return `<span class="text-red-600"> ${Math.abs(pct)}% vs ${label}</span>`;
            }
            return `<span class="text-themed-muted">No change</span>`;
        }

        function renderSummary() {
            const commits = getFilteredCommits();
            const periods = getPeriodDates(summaryPeriod);
            const periodLabel = summaryPeriod === '7days' ? 'previous 7 days'
                : summaryPeriod === '30days' ? 'previous 30 days' : 'last quarter';

            const currentCommits = getCommitsInRange(commits, periods.current.start, periods.current.end);
            const previousCommits = getCommitsInRange(commits, periods.previous.start, periods.previous.end);

            // Count metrics for current period
            const countTag = (commits, tag) => commits.filter(c =>
                getCommitTags(c).includes(tag)
            ).length;

            const currentFeatures = countTag(currentCommits, 'feature');
            const previousFeatures = countTag(previousCommits, 'feature');
            const currentFixes = countTag(currentCommits, 'bugfix');
            const previousFixes = countTag(previousCommits, 'bugfix');

            // Urgency metrics
            const getAvgUrgency = (commits) => {
                const urgencies = commits.map(c => c.urgency).filter(u => u != null && u >= 1 && u <= 5);
                return urgencies.length > 0
                    ? (urgencies.reduce((a, b) => a + b, 0) / urgencies.length)
                    : 0;
            };
            const currentUrgency = getAvgUrgency(currentCommits);
            const previousUrgency = getAvgUrgency(previousCommits);

            // Planned percentage (urgency 1-2)
            const getPlannedPct = (commits) => {
                const withUrgency = commits.filter(c => c.urgency != null && c.urgency >= 1 && c.urgency <= 5);
                if (withUrgency.length === 0) return 0;
                const planned = withUrgency.filter(c => c.urgency <= 2).length;
                return Math.round((planned / withUrgency.length) * 100);
            };
            const currentPlanned = getPlannedPct(currentCommits);
            const previousPlanned = getPlannedPct(previousCommits);

            // Update stats - focus on what matters
            document.getElementById('summary-features').textContent = currentFeatures;
            document.getElementById('summary-features-trend').innerHTML = getTrendHtml(currentFeatures, previousFeatures, periodLabel);

            document.getElementById('summary-fixes').textContent = currentFixes;
            document.getElementById('summary-fixes-trend').innerHTML = getTrendHtml(currentFixes, previousFixes, periodLabel);

            document.getElementById('summary-urgency').textContent = currentUrgency > 0 ? currentUrgency.toFixed(1) : '-';
            document.getElementById('summary-urgency-trend').innerHTML = currentUrgency > 0
                ? getTrendHtml(Math.round(previousUrgency * 10), Math.round(currentUrgency * 10), periodLabel, true) // Inverted: lower is better
                : '<span class="text-gray-400">No data</span>';

            document.getElementById('summary-planned').textContent = currentPlanned > 0 ? `${currentPlanned}%` : '-';
            document.getElementById('summary-planned-trend').innerHTML = currentPlanned > 0
                ? getTrendHtml(currentPlanned, previousPlanned, periodLabel) // Higher is better
                : '<span class="text-gray-400">No data</span>';

            // Work breakdown chart
            const tagCounts = {};
            currentCommits.forEach(c => {
                getCommitTags(c).forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });
            const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);

            if (charts.summaryBreakdown) charts.summaryBreakdown.destroy();
            charts.summaryBreakdown = new Chart(document.getElementById('summary-breakdown-chart'), {
                type: 'doughnut',
                data: {
                    labels: sortedTags.map(t => t[0]),
                    datasets: [{
                        data: sortedTags.map(t => t[1]),
                        backgroundColor: sortedTags.map(t => getTagColor(t[0]))
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 8,
                                font: { size: 11 },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: `${label} (${data.datasets[0].data[i]})`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        hidden: false,
                                        index: i
                                    }));
                                }
                            }
                        }
                    }
                }
            });

            // Key highlights - focus on meaningful insights
            const highlights = [];

            // Complexity breakdown
            const complexChanges = currentCommits.filter(c => c.complexity >= 4).length;
            const simpleChanges = currentCommits.filter(c => c.complexity != null && c.complexity <= 2).length;
            if (complexChanges > 0 || simpleChanges > 0) {
                highlights.push({
                    label: 'Complex Changes',
                    value: `${complexChanges} high complexity`,
                    subvalue: `${simpleChanges} simple`
                });
            }

            // Most active repo (if aggregated)
            const repoCounts = {};
            currentCommits.forEach(c => {
                if (c.repo_id) {
                    repoCounts[c.repo_id] = (repoCounts[c.repo_id] || 0) + 1;
                }
            });
            const repos = Object.keys(repoCounts);
            if (repos.length > 1) {
                const topRepo = Object.entries(repoCounts).sort((a, b) => b[1] - a[1])[0];
                const topPct = Math.round((topRepo[1] / currentCommits.length) * 100);
                highlights.push({
                    label: 'Most Active Repo',
                    value: topRepo[0],
                    subvalue: `${topPct}% of work`
                });
            }

            // Work pattern summary
            const afterHoursCount = currentCommits.filter(c => getWorkPattern(c).isAfterHours).length;
            const weekendCount = currentCommits.filter(c => getWorkPattern(c).isWeekend).length;
            const afterHoursPct = currentCommits.length > 0
                ? Math.round((afterHoursCount / currentCommits.length) * 100)
                : 0;
            if (afterHoursPct > 0 || weekendCount > 0) {
                highlights.push({
                    label: 'Off-Hours Work',
                    value: `${afterHoursPct}% after hours`,
                    subvalue: `${weekendCount} weekend`
                });
            }

            // Refactoring ratio
            const refactorCount = currentCommits.filter(c => getCommitTags(c).includes('refactor')).length;
            const testCount = currentCommits.filter(c => getCommitTags(c).includes('test')).length;
            if (refactorCount > 0 || testCount > 0) {
                highlights.push({
                    label: 'Quality Work',
                    value: `${refactorCount} refactors`,
                    subvalue: `${testCount} tests`
                });
            }

            document.getElementById('summary-highlights').innerHTML = highlights.length > 0
                ? highlights.map(h => `
                    <div class="p-3 bg-themed-tertiary rounded">
                        <p class="text-xs text-themed-tertiary mb-1">${h.label}</p>
                        <p class="text-sm font-semibold text-themed-primary">${h.value}</p>
                        ${h.subvalue ? `<p class="text-xs text-themed-tertiary">${h.subvalue}</p>` : ''}
                    </div>
                `).join('')
                : '<p class="text-themed-tertiary text-sm">No activity in this period</p>';

            // Activity snapshot - work pattern indicators (useful for burnout detection)
            const holidayCount = currentCommits.filter(c => getWorkPattern(c).isHoliday).length;

            document.getElementById('summary-activity').innerHTML = `
                <div class="text-center p-3 bg-amber-50 dark:bg-amber-900/20 rounded">
                    <p class="text-2xl font-bold text-amber-600">${afterHoursCount}</p>
                    <p class="text-xs text-themed-tertiary">After-hours</p>
                </div>
                <div class="text-center p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded">
                    <p class="text-2xl font-bold text-indigo-600">${weekendCount}</p>
                    <p class="text-xs text-themed-tertiary">Weekend</p>
                </div>
                <div class="text-center p-3 bg-pink-50 dark:bg-pink-900/20 rounded">
                    <p class="text-2xl font-bold text-pink-600">${holidayCount}</p>
                    <p class="text-xs text-themed-tertiary">Holiday</p>
                </div>
                <div class="text-center p-3 bg-purple-50 dark:bg-purple-900/20 rounded">
                    <p class="text-2xl font-bold text-purple-600">${complexChanges}</p>
                    <p class="text-xs text-themed-tertiary">Complex</p>
                </div>
            `;

            // Add click handlers for summary cards (only once, using dynamic data)
            if (!summaryCardHandlersInitialized) {
                summaryCardHandlersInitialized = true;
                document.querySelectorAll('[data-summary-card]').forEach(el => {
                    el.addEventListener('click', () => {
                        const cardType = el.dataset.summaryCard;
                        // Get current period commits dynamically (respects current filters and period)
                        const currentPeriodCommits = getCurrentPeriodCommits();
                        let filteredCommits, title;

                        if (cardType === 'features') {
                            filteredCommits = currentPeriodCommits.filter(c => (c.tags || []).includes('feature'));
                            title = 'Feature Commits';
                        } else if (cardType === 'fixes') {
                            filteredCommits = currentPeriodCommits.filter(c => (c.tags || []).includes('bugfix'));
                            title = 'Bug Fix Commits';
                        } else if (cardType === 'urgency') {
                            filteredCommits = currentPeriodCommits.filter(c => c.urgency >= 4);
                            title = 'Reactive Commits (Urgency 4-5)';
                        } else if (cardType === 'planned') {
                            filteredCommits = currentPeriodCommits.filter(c => c.urgency <= 2);
                            title = 'Planned Work (Urgency 1-2)';
                        }

                        if (filteredCommits) {
                            openDetailPane(title, `${filteredCommits.length} commits in this period`, filteredCommits);
                        }
                    });
                });
            }
        }

        function setupSummaryPeriodToggle() {
            document.getElementById('summary-period').addEventListener('change', (e) => {
                summaryPeriod = e.target.value;
                renderSummary();
                saveFiltersToStorage();
            });
        }

        // === Tab Navigation (V2: 4 grouped tabs) ===
        // Map new tabs to the content containers they should show
        const TAB_MAPPING = {
            'overview': ['tab-overview'],
            'activity': ['tab-activity', 'tab-timing'],
            'work': ['tab-progress', 'tab-tags', 'tab-contributors'],
            'health': ['tab-security']
        };

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Update button styles
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('border-blue-500', 'text-blue-600');
                    b.classList.add('border-transparent', 'text-themed-tertiary');
                });
                btn.classList.remove('border-transparent', 'text-themed-tertiary');
                btn.classList.add('border-blue-500', 'text-blue-600');

                // Show/hide tabs based on mapping
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
                const tabsToShow = TAB_MAPPING[btn.dataset.tab] || [`tab-${btn.dataset.tab}`];
                tabsToShow.forEach(tabId => {
                    const tabEl = document.getElementById(tabId);
                    if (tabEl) tabEl.classList.remove('hidden');
                });

                // Re-render content when tab becomes visible (Chart.js needs visible containers)
                if (data) {
                    const activeTab = btn.dataset.tab;
                    if (activeTab === 'overview') {
                        renderSummary();
                    } else if (activeTab === 'activity') {
                        renderTiming();
                    } else if (activeTab === 'work') {
                        renderTags();
                    } else if (activeTab === 'health') {
                        renderHealth();
                    }
                }

                // Save state (only if data is loaded)
                if (data) {
                    saveFiltersToStorage();
                }
            });
        });

        // === File Input Handler ===
        document.getElementById('file-input').addEventListener('change', async (e) => {
            const files = e.target.files;
            if (!files || files.length === 0) return;

            try {
                if (files.length === 1) {
                    // Single file - load directly
                    const text = await files[0].text();
                    const jsonData = JSON.parse(text);
                    loadData(jsonData);
                } else {
                    // Multiple files - combine them
                    const allData = [];
                    for (const file of files) {
                        const text = await file.text();
                        const jsonData = JSON.parse(text);
                        allData.push(jsonData);
                    }
                    const combined = combineDataFiles(allData);
                    loadData(combined);
                }
            } catch (error) {
                alert('Error loading file(s): ' + error.message);
            }
        });

        // === Combine Multiple Data Files ===
        function combineDataFiles(dataFiles) {
            const allCommits = [];
            const allContributors = new Map();
            const allFiles = new Map();
            const repos = [];

            let totalAdditions = 0;
            let totalDeletions = 0;
            const tagBreakdown = {};
            const monthlyCommits = {};
            const allAuthors = {};

            for (const data of dataFiles) {
                const repoId = data.metadata?.repo_id || data.metadata?.repository || 'unknown';
                repos.push(repoId);

                // Merge authors from metadata
                if (data.metadata?.authors) {
                    Object.assign(allAuthors, data.metadata.authors);
                }

                // Process commits
                for (const commit of data.commits || []) {
                    const enrichedCommit = { ...commit, repo_id: commit.repo_id || repoId };
                    allCommits.push(enrichedCommit);

                    // Tag breakdown
                    const tags = getCommitTags(commit);
                    tags.forEach(tag => {
                        tagBreakdown[tag] = (tagBreakdown[tag] || 0) + 1;
                    });

                    // Monthly
                    const month = commit.timestamp?.substring(0, 7);
                    if (month) {
                        if (!monthlyCommits[month]) monthlyCommits[month] = { total: 0, tags: {} };
                        monthlyCommits[month].total++;
                        tags.forEach(tag => {
                            monthlyCommits[month].tags[tag] = (monthlyCommits[month].tags[tag] || 0) + 1;
                        });
                    }

                    totalAdditions += getAdditions(commit);
                    totalDeletions += getDeletions(commit);
                }

                // Process contributors
                for (const contributor of data.contributors || []) {
                    const key = contributor.author_id || contributor.email?.toLowerCase();
                    if (!allContributors.has(key)) {
                        allContributors.set(key, {
                            ...contributor,
                            repos: new Set([repoId])
                        });
                    } else {
                        const existing = allContributors.get(key);
                        existing.commits += contributor.commits;
                        existing.additions += contributor.additions;
                        existing.deletions += contributor.deletions;
                        existing.repos.add(repoId);
                        for (const [type, count] of Object.entries(contributor.types || {})) {
                            existing.types[type] = (existing.types[type] || 0) + count;
                        }
                    }
                }

                // Process files
                for (const file of data.files || []) {
                    const key = `${repoId}:${file.path}`;
                    if (!allFiles.has(key)) {
                        allFiles.set(key, { ...file, repo_id: repoId });
                    }
                }
            }

            // Sort commits by timestamp
            allCommits.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Convert contributors
            const contributors = Array.from(allContributors.values())
                .map(c => ({
                    ...c,
                    repos: Array.from(c.repos),
                    repoCount: c.repos.size
                }))
                .sort((a, b) => b.commits - a.commits);

            // Get date range
            const timestamps = allCommits.map(c => c.timestamp).filter(Boolean).sort();

            return {
                metadata: {
                    repository: `Combined (${repos.length} repos)`,
                    repos,
                    authors: allAuthors
                },
                commits: allCommits,
                contributors,
                files: Array.from(allFiles.values()),
                summary: {
                    totalCommits: allCommits.length,
                    totalContributors: contributors.length,
                    totalAdditions,
                    totalDeletions,
                    netLinesChanged: totalAdditions - totalDeletions,
                    tagBreakdown,
                    monthlyCommits,
                    dateRange: {
                        earliest: timestamps[0] || null,
                        latest: timestamps[timestamps.length - 1] || null
                    }
                }
            };
        }

        // === Auto-load data.json if present ===
        function showLoading(show) {
            const content = document.getElementById('loader-content');
            const spinner = document.getElementById('loader-spinner');
            if (show) {
                content.classList.add('hidden');
                spinner.classList.remove('hidden');
            } else {
                content.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }

        async function tryAutoLoad() {
            showLoading(true);
            try {
                // Try to load from same directory
                const response = await fetch('data.json');
                if (response.ok) {
                    const jsonData = await response.json();
                    loadData(jsonData);
                    return;
                }
            } catch (e) {
                // Try reports folder
                try {
                    const response = await fetch('../reports/repo-tor/data.json');
                    if (response.ok) {
                        const jsonData = await response.json();
                        loadData(jsonData);
                        return;
                    }
                } catch (e2) {
                    // No auto-load available
                }
            }
            // No data found, show file picker
            showLoading(false);
        }

        // === Utilities ===
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // === Toast Notification ===
        function showToast(message, duration = 3000) {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            // Trigger animation
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // === URL State Management (Shareable Links) ===
        function getStateFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return {
                tag: params.get('tag') || '',
                author: params.get('author') || '',
                repo: params.get('repo') || '',
                dateFrom: params.get('from') || '',
                dateTo: params.get('to') || '',
                tab: params.get('tab') || 'overview',
                period: params.get('period') || '7days',
                tz: params.get('tz') || 'local'
            };
        }

        function buildShareableUrl() {
            const url = new URL(window.location.href.split('?')[0]);
            const params = new URLSearchParams();

            // Add current tab
            const activeTab = document.querySelector('.tab-btn.border-blue-500')?.dataset.tab || 'summary';
            if (activeTab !== 'summary') params.set('tab', activeTab);

            // Add filters (only if set)
            if (filters.tag) params.set('tag', filters.tag);
            if (filters.author) params.set('author', filters.author);
            if (filters.repo) params.set('repo', filters.repo);
            if (filters.dateFrom) params.set('from', filters.dateFrom);
            if (filters.dateTo) params.set('to', filters.dateTo);

            // Add summary period if on overview tab
            if (activeTab === 'overview' && summaryPeriod !== '7days') {
                params.set('period', summaryPeriod);
            }

            // Add timezone if on activity tab (which includes timing) and not local
            if (activeTab === 'activity' && useUTC) {
                params.set('tz', 'utc');
            }

            const paramStr = params.toString();
            return paramStr ? `${url}?${paramStr}` : url.toString();
        }

        function applyUrlState() {
            const state = getStateFromUrl();

            // Apply filters
            filters.tag = state.tag;
            filters.author = state.author;
            filters.repo = state.repo;
            filters.dateFrom = state.dateFrom;
            filters.dateTo = state.dateTo;

            // Update filter UI
            document.getElementById('filter-tag').value = state.tag;
            document.getElementById('filter-author').value = state.author;
            document.getElementById('filter-repo').value = state.repo;
            document.getElementById('filter-date-from').value = state.dateFrom;
            document.getElementById('filter-date-to').value = state.dateTo;

            // Apply summary period
            if (state.period) {
                summaryPeriod = state.period;
                document.getElementById('summary-period').value = state.period;
            }

            // Apply timezone
            if (state.tz === 'utc') {
                useUTC = true;
                document.getElementById('timezone-select').value = 'utc';
            }

            // Switch to specified tab
            if (state.tab) {
                const tabBtn = document.querySelector(`.tab-btn[data-tab="${state.tab}"]`);
                if (tabBtn) tabBtn.click();
            }
        }

        function copyShareableLink() {
            const url = buildShareableUrl();
            navigator.clipboard.writeText(url).then(() => {
                showToast('Link copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const input = document.createElement('input');
                input.value = url;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                showToast('Link copied to clipboard!');
            });
        }

        // === PDF Export ===
        async function exportToPdf() {
            const exportBtn = document.getElementById('btn-export-pdf');
            const originalText = exportBtn.innerHTML;
            exportBtn.innerHTML = `
                <svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
                <span class="hidden sm:inline">Generating...</span>
            `;
            exportBtn.disabled = true;

            try {
                // Get current active tab
                const activeTab = document.querySelector('.tab-btn.border-blue-500')?.dataset.tab || 'summary';
                const tabContent = document.getElementById(`tab-${activeTab}`);

                // Create a container for PDF content
                const pdfContent = document.createElement('div');
                pdfContent.style.cssText = 'background: white; padding: 20px; max-width: 1000px;';

                // Add header
                const header = document.createElement('div');
                header.innerHTML = `
                    <h1 style="font-size: 24px; font-weight: bold; color: #111827; margin-bottom: 8px;">
                        ${document.getElementById('repo-name').textContent}
                    </h1>
                    <p style="color: #6b7280; font-size: 14px; margin-bottom: 16px;">
                        ${document.getElementById('repo-subtitle').textContent}
                    </p>
                    <p style="color: #9ca3af; font-size: 12px; margin-bottom: 24px;">
                        Generated: ${new Date().toLocaleString()} | Tab: ${activeTab.charAt(0).toUpperCase() + activeTab.slice(1)}
                        ${hasActiveFilters() ? ' | Filtered view' : ''}
                    </p>
                `;
                pdfContent.appendChild(header);

                // Add summary stats
                const stats = document.createElement('div');
                stats.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            <p style="color: #6b7280; font-size: 12px; text-transform: uppercase;">Files Changed</p>
                            <p style="font-size: 24px; font-weight: bold;">${document.getElementById('stat-files').textContent}</p>
                        </div>
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            <p style="color: #6b7280; font-size: 12px; text-transform: uppercase;">Avg Complexity</p>
                            <p style="font-size: 24px; font-weight: bold;">${document.getElementById('stat-complexity').textContent}</p>
                        </div>
                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                            <p style="color: #6b7280; font-size: 12px; text-transform: uppercase;">Contributors</p>
                            <p style="font-size: 24px; font-weight: bold;">${document.getElementById('stat-contributors').textContent}</p>
                        </div>
                    </div>
                `;
                pdfContent.appendChild(stats);

                // Clone the current tab content
                const contentClone = tabContent.cloneNode(true);
                contentClone.classList.remove('hidden');
                // Remove any interactive elements
                contentClone.querySelectorAll('select, button, input').forEach(el => {
                    if (el.tagName === 'SELECT') {
                        const span = document.createElement('span');
                        span.textContent = el.options[el.selectedIndex]?.text || '';
                        span.style.cssText = 'font-weight: 500;';
                        el.replaceWith(span);
                    } else if (el.tagName === 'BUTTON') {
                        el.remove();
                    }
                });
                pdfContent.appendChild(contentClone);

                // Temporarily add to DOM for rendering
                pdfContent.style.position = 'absolute';
                pdfContent.style.left = '-9999px';
                document.body.appendChild(pdfContent);

                // Generate PDF
                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: `git-analytics-${activeTab}-${new Date().toISOString().split('T')[0]}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        logging: false
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: 'a4',
                        orientation: 'landscape'
                    }
                };

                await html2pdf().set(opt).from(pdfContent).save();

                // Cleanup
                document.body.removeChild(pdfContent);
                showToast('PDF exported successfully!');
            } catch (error) {
                console.error('PDF export error:', error);
                showToast('Export failed. Please try again.');
            } finally {
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
            }
        }

        function hasActiveFilters() {
            return filters.tag || filters.author || filters.repo || filters.dateFrom || filters.dateTo;
        }

        // Setup export/share button handlers
        function setupExportButtons() {
            document.getElementById('export-buttons').classList.remove('hidden');
            document.getElementById('btn-share').addEventListener('click', copyShareableLink);
            document.getElementById('btn-export-pdf').addEventListener('click', exportToPdf);
            document.getElementById('btn-theme').addEventListener('click', toggleDarkMode);
            document.getElementById('btn-sanitize').addEventListener('click', toggleSanitizeMode);
        }

        // Initialize
        initDarkMode();
        initSanitizeMode();
        initDetailPane();
        initFilterSidebar();
        tryAutoLoad();
    </script>
</body>
</html>
